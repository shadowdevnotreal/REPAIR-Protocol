<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced REPAIR Protocol - Agent-Powered Restoration System</title>
    
    <!-- Desktop Enhancement Framework -->
    <link rel="stylesheet" href="desktop-enhancements.css">
    
    <script src="theme-system.js"></script>
    <style>
        :root {
            /* Light Theme Variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.98);
            --bg-glass: rgba(255, 255, 255, 0.25);
            --bg-glass-hover: rgba(255, 255, 255, 0.35);
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --border-color: rgba(102, 126, 234, 0.2);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(102, 126, 234, 0.3);
            --backdrop-blur: blur(20px);
        }

        [data-theme="dark"] {
            /* Dark Theme Variables - WCAG AA+ Compliant */
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: rgba(15, 23, 42, 0.98);
            --bg-glass: rgba(30, 41, 59, 0.85);
            --bg-glass-hover: rgba(30, 41, 59, 0.95);
            --card-bg: rgba(30, 41, 59, 0.95);
            /* High contrast text colors for accessibility */
            --text-primary: #ffffff;
            --text-secondary: #f1f5f9;
            --text-tertiary: #e2e8f0;
            --text-on-glass: #ffffff;
            --text-hover: #c4b5fd;
            --border-color: rgba(203, 213, 225, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(196, 181, 253, 0.4);
            --backdrop-blur: blur(20px);
            --accent-primary: #a78bfa;
            --accent-secondary: #8b5cf6;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: var(--bg-primary);
            color: var(--text-secondary);
            line-height: 1.6;
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Theme Toggle in Header */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .theme-toggle:hover {
            background: var(--bg-glass-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .theme-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover .theme-icon {
            transform: scale(1.1);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5rem;
            margin-bottom: 10px;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.3);
            color: white;
        }

        .header p {
            font-size: 1.2rem;
            opacity: 0.9;
            color: white;
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 30px;
            margin-bottom: 30px;
        }

        .process-panel {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px var(--shadow-color);
        }

        .process-panel h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .agents-dashboard {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .agent-card {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 8px 25px var(--shadow-color);
            border-left: 5px solid;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .agent-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 40px var(--shadow-hover);
        }

        .agent-card.contract { border-left-color: #4CAF50; }
        .agent-card.mediation { border-left-color: #2196F3; }
        .agent-card.emotional { border-left-color: #FF9800; }
        .agent-card.progress { border-left-color: #9C27B0; }

        .agent-header {
            display: flex;
            align-items: center;
            margin-bottom: 15px;
        }

        .agent-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            margin-right: 15px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: bold;
            font-size: 1.2rem;
        }

        .agent-icon.contract { background: #4CAF50; }
        .agent-icon.mediation { background: #2196F3; }
        .agent-icon.emotional { background: #FF9800; }
        .agent-icon.progress { background: #9C27B0; }

        .agent-title {
            font-size: 1.3rem;
            font-weight: 600;
            color: var(--text-primary);
        }

        .agent-status {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.85rem;
            font-weight: 500;
            margin-left: auto;
        }

        .status-active {
            background: var(--bg-glass-hover);
            color: #2E7D32;
            border: 1px solid var(--border-color);
        }

        .status-analyzing {
            background: var(--bg-glass-hover);
            color: #F57C00;
            border: 1px solid var(--border-color);
        }

        .status-warning {
            background: var(--bg-glass-hover);
            color: #C62828;
            border: 1px solid var(--border-color);
        }

        .metric {
            display: flex;
            justify-content: space-between;
            margin: 10px 0;
            padding: 8px 0;
            border-bottom: 1px solid var(--border-color);
        }

        .metric:last-child {
            border-bottom: none;
        }

        .metric-label {
            font-weight: 500;
            color: var(--text-secondary);
        }

        .metric-value {
            font-weight: 600;
            color: var(--text-primary);
        }

        .score-high { color: #4CAF50; }
        .score-medium { color: #FF9800; }
        .score-low { color: #F44336; }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: var(--border-color);
            border-radius: 4px;
            overflow: hidden;
            margin: 10px 0;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #4CAF50, #8BC34A);
            transition: width 0.3s ease;
        }

        .insights-panel {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px var(--shadow-color);
            margin-bottom: 30px;
        }

        .insights-panel h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .insights-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .insight-category {
            background: var(--bg-glass-hover);
            border-radius: 10px;
            padding: 20px;
            border: 1px solid var(--border-color);
        }

        .insight-category h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
            font-size: 1.2rem;
        }

        .insight-item {
            background: var(--bg-glass);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 10px;
            border-left: 4px solid #2196F3;
            box-shadow: 0 2px 8px var(--shadow-color);
            color: var(--text-secondary);
        }

        .insight-item:last-child {
            margin-bottom: 0;
        }

        .insight-item strong {
            color: var(--text-primary);
        }

        .recommendation {
            background: var(--bg-glass);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            padding: 15px;
            margin: 10px 0;
            backdrop-filter: var(--backdrop-blur);
        }

        .recommendation.high-priority {
            border-color: #ffcdd2;
        }

        .recommendation.medium-priority {
            border-color: #fff3e0;
        }

        .recommendation strong {
            color: var(--text-primary);
        }

        .priority-badge {
            display: inline-block;
            padding: 3px 8px;
            border-radius: 12px;
            font-size: 0.8rem;
            font-weight: 600;
            margin-bottom: 8px;
        }

        .priority-high {
            background: #ffcdd2;
            color: #c62828;
        }

        .priority-medium {
            background: #fff3e0;
            color: #f57c00;
        }

        .priority-low {
            background: #e8f5e8;
            color: #2e7d32;
        }

        .controls-panel {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 10px 30px var(--shadow-color);
            margin-bottom: 20px;
        }

        .controls-panel h2 {
            color: var(--text-primary);
            margin-bottom: 20px;
        }

        .controls-panel h3 {
            color: var(--text-primary);
            margin-bottom: 15px;
        }

        .control-group {
            margin-bottom: 20px;
        }

        .control-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .control-group input,
        .control-group textarea,
        .control-group select {
            width: 100%;
            padding: 12px;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 1rem;
            transition: border-color 0.3s ease;
            background: var(--bg-glass);
            color: var(--text-primary);
        }

        .control-group input:focus,
        .control-group textarea:focus,
        .control-group select:focus {
            outline: none;
            border-color: var(--accent-primary);
        }

        .control-group input::placeholder,
        .control-group textarea::placeholder {
            color: var(--text-tertiary);
        }

        .btn {
            background: linear-gradient(135deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 10px;
            margin-bottom: 10px;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 20px rgba(33, 150, 243, 0.3);
        }

        .btn-secondary {
            background: linear-gradient(135deg, #6c757d, #868e96);
        }

        .btn-secondary:hover {
            box-shadow: 0 8px 20px rgba(108, 117, 125, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, #4CAF50, #66BB6A);
        }

        .btn-success:hover {
            box-shadow: 0 8px 20px rgba(76, 175, 80, 0.3);
        }

        .timeline {
            position: relative;
            padding-left: 30px;
        }

        .timeline::before {
            content: '';
            position: absolute;
            left: 15px;
            top: 0;
            bottom: 0;
            width: 2px;
            background: var(--border-color);
        }

        .timeline-item {
            position: relative;
            background: var(--bg-glass);
            padding: 15px;
            border-radius: 8px;
            margin-bottom: 15px;
            box-shadow: 0 2px 8px var(--shadow-color);
            border: 1px solid var(--border-color);
            color: var(--text-secondary);
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: -22px;
            top: 20px;
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #2196F3;
        }

        .timeline-item strong {
            color: var(--text-primary);
        }

        .timeline-item small {
            color: var(--text-tertiary);
        }

        .notification {
            position: fixed;
            top: 20px;
            right: 20px;
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-left: 5px solid #4CAF50;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 8px 25px var(--shadow-color);
            transform: translateX(400px);
            transition: transform 0.3s ease;
            z-index: 1000;
            max-width: 300px;
            color: var(--text-secondary);
            border: 1px solid var(--border-color);
        }

        .notification.show {
            transform: translateX(0);
        }

        .real-time-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            background: #4CAF50;
            border-radius: 50%;
            animation: pulse 2s infinite;
            margin-right: 8px;
        }

        @keyframes pulse {
            0% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0.7);
            }

            70% {
                transform: scale(1);
                box-shadow: 0 0 0 10px rgba(76, 175, 80, 0);
            }

            100% {
                transform: scale(0.95);
                box-shadow: 0 0 0 0 rgba(76, 175, 80, 0);
            }
        }

        /* Navigation */
        nav {
            background: var(--bg-glass);
            padding: 15px;
            margin-bottom: 30px;
            border-radius: 12px;
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
        }

        nav div {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
            flex-wrap: wrap;
        }

        nav a {
            text-decoration: none;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        nav a:hover {
            background: var(--bg-glass-hover);
            color: var(--text-hover);
        }

        nav button {
            background: none;
            border: none;
            cursor: pointer;
            color: var(--text-secondary);
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
        }

        nav button:hover {
            background: var(--bg-glass-hover);
            color: var(--text-hover);
        }

        /* Additional dark mode text fixes */
        [data-theme="dark"] .container,
        [data-theme="dark"] .process-panel,
        [data-theme="dark"] .insights-panel,
        [data-theme="dark"] .controls-panel {
            color: var(--text-secondary);
        }

        [data-theme="dark"] .container h1,
        [data-theme="dark"] .container h2,
        [data-theme="dark"] .container h3,
        [data-theme="dark"] .process-panel h2,
        [data-theme="dark"] .insights-panel h2,
        [data-theme="dark"] .controls-panel h2,
        [data-theme="dark"] .controls-panel h3,
        [data-theme="dark"] .agent-title {
            color: var(--text-primary) !important;
        }

        @media (max-width: 768px) {
            .main-grid {
                grid-template-columns: 1fr;
            }

            .agents-dashboard {
                grid-template-columns: 1fr;
            }

            .insights-grid {
                grid-template-columns: 1fr;
            }

            .header h1 {
                font-size: 2rem;
            }

            .theme-toggle {
                padding: 10px 14px;
                font-size: 0.8rem;
            }
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-icon" id="theme-icon">🌙</span>
        <span id="theme-text">Dark Mode</span>
    </div>

    <div class="container desktop-center responsive-padding">
        <div class="header header-section responsive-padding">
            <h1>🔧 Enhanced REPAIR Protocol</h1>
            <p>Agent-Powered Relationship Restoration System</p>
        </div>

        <!-- Navigation -->
        <nav class="navigation desktop-center">
            <div>
                <a href="index.html">🏠 Home</a>
                <a href="repair.html">🔧 Start REPAIR</a>
                <a href="mediation-mode.html">⚖️ Mediation</a>
                <a href="sign-contract.html">📝 Contract</a>
                <a href="progress.html">📊 Progress</a>
                <a href="about.html">ℹ️ About</a>
            </div>
        </nav>

        <!-- Main Control Panel -->
        <div class="main-grid content-wrapper-enhanced desktop-center">
            <div class="process-panel">
                <h2>📝 Repair Process Control</h2>

                <div class="control-group">
                    <label for="repairText">Apology/Repair Text:</label>
                    <textarea id="repairText" rows="6" placeholder="Enter the apology or repair text to analyze...">I am deeply sorry for my actions yesterday when I spoke harshly to you during the meeting. I realize now that my behavior was completely inappropriate and caused you embarrassment in front of the team. I take full responsibility for my words and understand how they must have made you feel. I commit to attending anger management sessions starting next week and will work on improving my communication skills. Can we schedule time to talk about how to rebuild trust between us?</textarea>
                </div>

                <div class="control-group">
                    <label for="processType">Process Type:</label>
                    <select id="processType">
                        <option value="individual">Individual Apology</option>
                        <option value="mediated">Mediated Discussion</option>
                        <option value="group">Group Process</option>
                        <option value="formal">Formal Restoration</option>
                    </select>
                </div>

                <div class="control-group">
                    <label for="participants">Number of Participants:</label>
                    <input type="number" id="participants" value="2" min="2" max="10">
                </div>

                <button class="btn" onclick="initiateAnalysis()">🚀 Start Analysis</button>
                <button class="btn btn-secondary" onclick="generateContract()">📋 Generate Contract</button>
                <button class="btn btn-success" onclick="startMediation()">🤝 Begin Mediation</button>
            </div>

            <div class="process-panel">
                <h2>📊 Process Overview</h2>

                <div class="metric">
                    <span class="metric-label">Overall Progress:</span>
                    <span class="metric-value">67%</span>
                </div>
                <div class="progress-bar">
                    <div class="progress-fill" style="width: 67%"></div>
                </div>

                <div class="metric">
                    <span class="metric-label">Current Phase:</span>
                    <span class="metric-value">Empathy & Understanding</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Trust Level:</span>
                    <span class="metric-value score-medium">Rebuilding (45%)</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Risk Level:</span>
                    <span class="metric-value score-low">Low</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Est. Completion:</span>
                    <span class="metric-value">3-4 weeks</span>
                </div>

                <div class="timeline">
                    <div class="timeline-item">
                        <strong>Recognition Complete</strong><br>
                        <small>Harm acknowledged by all parties</small>
                    </div>
                    <div class="timeline-item">
                        <strong>Responsibility Taken</strong><br>
                        <small>Full accountability demonstrated</small>
                    </div>
                    <div class="timeline-item" style="background: var(--bg-glass-hover);">
                        <strong>Empathy Phase - Current</strong><br>
                        <small>Building understanding and validation</small>
                    </div>
                </div>
            </div>
        </div>

        <!-- Agents Dashboard -->
        <div class="agents-dashboard">
            <!-- Contract Analyzer Agent -->
            <div class="agent-card contract">
                <div class="agent-header">
                    <div class="agent-icon contract">CA</div>
                    <div class="agent-title">Contract Analyzer</div>
                    <div class="agent-status status-active">
                        <span class="real-time-indicator"></span>Active
                    </div>
                </div>

                <div class="metric">
                    <span class="metric-label">Specificity Score:</span>
                    <span class="metric-value score-high">85%</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Measurability:</span>
                    <span class="metric-value score-high">78%</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Achievability:</span>
                    <span class="metric-value score-medium">72%</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Success Prediction:</span>
                    <span class="metric-value score-high">82%</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Risk Factors:</span>
                    <span class="metric-value">2 identified</span>
                </div>

                <div class="insight-item">
                    <strong>Key Insight:</strong> Contract shows high specificity with concrete timelines. Recommend adding verification milestones.
                </div>
            </div>

            <!-- Mediation Engine Agent -->
            <div class="agent-card mediation">
                <div class="agent-header">
                    <div class="agent-icon mediation">ME</div>
                    <div class="agent-title">Mediation Engine</div>
                    <div class="agent-status status-analyzing">
                        <span class="real-time-indicator"></span>Analyzing
                    </div>
                </div>

                <div class="metric">
                    <span class="metric-label">Communication Quality:</span>
                    <span class="metric-value score-high">76%</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Escalation Risk:</span>
                    <span class="metric-value score-low">Low (15%)</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Common Ground:</span>
                    <span class="metric-value">4 areas found</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Active Sessions:</span>
                    <span class="metric-value">1 mediation</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Cultural Adaptations:</span>
                    <span class="metric-value">2 applied</span>
                </div>

                <div class="insight-item">
                    <strong>Recommendation:</strong> Parties showing good alignment on shared values. Suggest structured dialogue on expectations.
                </div>
            </div>

            <!-- Emotional Intelligence Agent -->
            <div class="agent-card emotional">
                <div class="agent-header">
                    <div class="agent-icon emotional">EI</div>
                    <div class="agent-title">Emotional Intelligence</div>
                    <div class="agent-status status-active">
                        <span class="real-time-indicator"></span>Active
                    </div>
                </div>

                <div class="metric">
                    <span class="metric-label">Authenticity Score:</span>
                    <span class="metric-value score-high">89%</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Emotional Depth:</span>
                    <span class="metric-value score-high">High</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Manipulation Risk:</span>
                    <span class="metric-value score-low">Very Low</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Trigger Warnings:</span>
                    <span class="metric-value">1 potential</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Emotional Regulation:</span>
                    <span class="metric-value score-medium">Moderate</span>
                </div>

                <div class="insight-item">
                    <strong>Pattern Detected:</strong> High authenticity with genuine vulnerability. Monitor for emotional overwhelm during difficult topics.
                </div>
            </div>

            <!-- Progress Optimizer Agent -->
            <div class="agent-card progress">
                <div class="agent-header">
                    <div class="agent-icon progress">PO</div>
                    <div class="agent-title">Progress Optimizer</div>
                    <div class="agent-status status-active">
                        <span class="real-time-indicator"></span>Active
                    </div>
                </div>

                <div class="metric">
                    <span class="metric-label">Progress Velocity:</span>
                    <span class="metric-value score-high">Good (+12%)</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Bottlenecks:</span>
                    <span class="metric-value">1 minor</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Timeline Prediction:</span>
                    <span class="metric-value">On track</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Engagement Level:</span>
                    <span class="metric-value score-high">High (87%)</span>
                </div>

                <div class="metric">
                    <span class="metric-label">Optimization Score:</span>
                    <span class="metric-value score-medium">75%</span>
                </div>

                <div class="insight-item">
                    <strong>Acceleration Opportunity:</strong> Consider parallel processing of commitment items. Could reduce timeline by 1 week.
                </div>
            </div>
        </div>

        <!-- Real-time Insights Panel -->
        <div class="insights-panel">
            <h2>🧠 Real-time AI Insights</h2>

            <div class="insights-grid">
                <div class="insight-category">
                    <h3>🎯 Key Recommendations</h3>

                    <div class="recommendation high-priority">
                        <div class="priority-badge priority-high">HIGH PRIORITY</div>
                        <strong>Strengthen Verification Measures</strong><br>
                        Contract shows good commitments but needs stronger verification milestones. Add weekly check-ins and progress reports.
                    </div>

                    <div class="recommendation medium-priority">
                        <div class="priority-badge priority-medium">MEDIUM</div>
                        <strong>Emotional Support Integration</strong><br>
                        High authenticity detected but monitor for emotional fatigue. Consider integrating counseling support.
                    </div>

                    <div class="recommendation">
                        <div class="priority-badge priority-low">LOW</div>
                        <strong>Timeline Optimization</strong><br>
                        Current pace is good. Consider parallel task execution to accelerate by 15%.
                    </div>
                </div>

                <div class="insight-category">
                    <h3>⚠️ Risk Factors & Alerts</h3>

                    <div class="insight-item">
                        <strong>Communication Pattern:</strong> Slight avoidance detected around accountability topics. Recommend structured approach.
                    </div>

                    <div class="insight-item">
                        <strong>Trust Building:</strong> Progress is steady but could accelerate with transparency measures.
                    </div>

                    <div class="insight-item">
                        <strong>External Factors:</strong> No significant external risks detected. Environment is stable for repair work.
                    </div>

                    <div class="insight-item">
                        <strong>Engagement Trends:</strong> Both parties showing consistent engagement. Positive trend maintained.
                    </div>
                </div>
            </div>
        </div>

        <!-- Agent Coordination Status -->
        <div class="controls-panel">
            <h2>🤖 Agent Coordination Status</h2>

            <div class="main-grid">
                <div>
                    <h3>System Health</h3>
                    <div class="metric">
                        <span class="metric-label">Overall Status:</span>
                        <span class="metric-value score-high">Operational</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Active Coordinations:</span>
                        <span class="metric-value">3</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Event Queue:</span>
                        <span class="metric-value">2 pending</span>
                    </div>
                    <div class="metric">
                        <span class="metric-label">Agent Sync Rate:</span>
                        <span class="metric-value score-high">98.5%</span>
                    </div>
                </div>

                <div>
                    <h3>Recent Agent Communications</h3>
                    <div class="timeline">
                        <div class="timeline-item">
                            <strong>EI → PO:</strong> Emotional stability confirmed, cleared for acceleration<br>
                            <small>2 minutes ago</small>
                        </div>
                        <div class="timeline-item">
                            <strong>CA → ME:</strong> Contract analysis complete, recommendations shared<br>
                            <small>5 minutes ago</small>
                        </div>
                        <div class="timeline-item">
                            <strong>Coordinator:</strong> All agents synchronized, consensus achieved<br>
                            <small>8 minutes ago</small>
                        </div>
                    </div>
                </div>
            </div>

            <button class="btn" onclick="refreshAgents()">🔄 Refresh Agents</button>
            <button class="btn btn-secondary" onclick="viewDetailedLogs()">📋 View Logs</button>
            <button class="btn btn-success" onclick="exportResults()">💾 Export Analysis</button>
        </div>
    </div>

    <!-- Notification Element -->
    <div id="notification" class="notification">
        <div id="notificationContent"></div>
    </div>

    <!-- Scripts for agent system -->
    <script src="agents/contract-analyzer.js"></script>
    <script src="agents/mediation-engine.js"></script>
    <script src="agents/emotional-intelligence.js"></script>
    <script src="agents/progress-optimizer.js"></script>
    <script src="agents/agent-coordinator.js"></script>

    <script>
        // Theme management
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);

            // Update theme toggle button
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            if (newTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }

            // Store preference
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            if (savedTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }
        }

        // Initialize the agent system
        let agentCoordinator;
        let currentProcessId = null;
        let analysisResults = {};

        // Initialize agents when page loads
        window.addEventListener('load', async function() {
            initializeTheme();
            
            try {
                agentCoordinator = new AgentCoordinator();
                const initResult = await agentCoordinator.initializeAgents();

                if (initResult.success) {
                    showNotification('🤖 Agent system initialized successfully!', 'success');
                    updateSystemStatus();
                } else {
                    showNotification('⚠️ Some agents failed to initialize', 'warning');
                    console.error('Initialization errors:', initResult.errors);
                }
            } catch (error) {
                showNotification('❌ Failed to initialize agent system', 'error');
                console.error('Initialization error:', error);
            }

            // Start real-time updates
            startRealTimeUpdates();
        });

        async function initiateAnalysis() {
            const repairText = document.getElementById('repairText').value;
            const processType = document.getElementById('processType').value;
            const participants = document.getElementById('participants').value;

            if (!repairText.trim()) {
                showNotification('⚠️ Please enter repair text to analyze', 'warning');
                return;
            }

            if (!agentCoordinator) {
                showNotification('❌ Agent system not initialized', 'error');
                return;
            }

            try {
                showNotification('🔍 Starting comprehensive analysis...', 'info');
                updateAgentStatus('analyzing');

                // Create repair context
                const repairContext = {
                    apologyText: repairText,
                    contract: {
                        text: repairText,
                        type: processType,
                        parties: Array.from({length: participants}, (_, i) => ({
                            id: `party_${i + 1}`,
                            name: `Participant ${i + 1}`,
                            role: i === 0 ? 'apologizer' : 'affected_party'
                        }))
                    },
                    parties: Array.from({length: participants}, (_, i) => ({
                        id: `party_${i + 1}`,
                        name: `Participant ${i + 1}`,
                        role: i === 0 ? 'apologizer' : 'affected_party'
                    })),
                    processId: 'repair_' + Date.now(),
                    currentStatus: {
                        phase: 'empathy',
                        progress: 67,
                        engagement: 87,
                        trustLevel: 45
                    },
                    communications: [
                        {
                            timestamp: new Date().toISOString(),
                            text: repairText,
                            speaker: 'party_1'
                        }
                    ],
                    speakerId: 'party_1'
                };

                // Perform comprehensive analysis
                const analysis = await agentCoordinator.analyzeRepairProcess(repairContext);
                analysisResults = analysis;
                currentProcessId = repairContext.processId;

                // Update UI with results
                updateAnalysisResults(analysis);
                showNotification('✅ Analysis complete! Check insights below.', 'success');

            } catch (error) {
                console.error('Analysis error:', error);
                showNotification('❌ Analysis failed: ' + error.message, 'error');
            } finally {
                updateAgentStatus('active');
            }
        }

        function updateAnalysisResults(analysis) {
            // Update agent cards with real results
            if (analysis.agentResults.contractAnalyzer) {
                const ca = analysis.agentResults.contractAnalyzer;
                updateAgentCard('contract', {
                    specificity: ca.scores?.specificity?.score || 85,
                    measurability: ca.scores?.measurability?.score || 78,
                    achievability: ca.scores?.achievability?.score || 72,
                    successPrediction: Math.round((ca.successPrediction?.probability || 0.82) * 100),
                    riskFactors: ca.riskAssessment?.factors?.length || 2,
                    insight: ca.improvements?.[0]?.suggestion || "Contract shows high specificity with concrete timelines."
                });
            }

            if (analysis.agentResults.emotionalIntelligence) {
                const ei = analysis.agentResults.emotionalIntelligence;
                updateAgentCard('emotional', {
                    authenticity: ei.scores?.overall || 89,
                    depth: ei.emotionalDepth?.depth || 'High',
                    manipulationRisk: ei.manipulationRisk?.riskLevel || 'Very Low',
                    triggers: 1,
                    regulation: 'Moderate',
                    insight: "High authenticity with genuine vulnerability detected."
                });
            }

            // Update recommendations panel
            updateRecommendations(analysis.recommendations || []);

            // Update coordination status
            updateCoordinationStatus(analysis);
        }

        function updateAgentCard(agentType, data) {
            const card = document.querySelector(`.agent-card.${agentType}`);
            if (!card) return;

            const metrics = card.querySelectorAll('.metric-value');
            switch(agentType) {
                case 'contract':
                    if (metrics[0]) metrics[0].textContent = data.specificity + '%';
                    if (metrics[1]) metrics[1].textContent = data.measurability + '%';
                    if (metrics[2]) metrics[2].textContent = data.achievability + '%';
                    if (metrics[3]) metrics[3].textContent = data.successPrediction + '%';
                    if (metrics[4]) metrics[4].textContent = data.riskFactors + ' identified';
                    break;
                case 'emotional':
                    if (metrics[0]) metrics[0].textContent = data.authenticity + '%';
                    if (metrics[1]) metrics[1].textContent = data.depth;
                    if (metrics[2]) metrics[2].textContent = data.manipulationRisk;
                    if (metrics[3]) metrics[3].textContent = data.triggers + ' potential';
                    if (metrics[4]) metrics[4].textContent = data.regulation;
                    break;
            }

            const insightElement = card.querySelector('.insight-item');
            if (insightElement && data.insight) {
                insightElement.innerHTML = '<strong>Key Insight:</strong> ' + data.insight;
            }
        }

        function updateRecommendations(recommendations) {
            const container = document.querySelector('.insight-category');
            if (!container || recommendations.length === 0) return;

            // Clear existing recommendations except the header
            const existingRecs = container.querySelectorAll('.recommendation');
            existingRecs.forEach(rec => rec.remove());

            // Add new recommendations
            recommendations.slice(0, 3).forEach(rec => {
                const recElement = document.createElement('div');
                recElement.className = `recommendation ${rec.priority === 'high' ? 'high-priority' :
                                                      rec.priority === 'medium' ? 'medium-priority' : ''}`;

                recElement.innerHTML = `
                    <div class="priority-badge priority-${rec.priority || 'medium'}">${(rec.priority || 'medium').toUpperCase()}</div>
                    <strong>${rec.action || 'Improvement Needed'}</strong><br>
                    ${rec.reason || 'Analysis suggests this action would improve the repair process.'}
                `;

                container.appendChild(recElement);
            });
        }

        function updateCoordinationStatus(analysis) {
            // Update system health metrics
            const healthMetrics = document.querySelectorAll('.controls-panel .metric-value');
            if (healthMetrics[1]) healthMetrics[1].textContent = agentCoordinator.getActiveCoordinations().length;

            // Add coordination timeline entry
            const timeline = document.querySelector('.controls-panel .timeline');
            if (timeline) {
                const newEntry = document.createElement('div');
                newEntry.className = 'timeline-item';
                newEntry.innerHTML = `
                    <strong>Analysis Complete:</strong> ${analysis.consensus?.keyInsights?.length || 0} insights generated<br>
                    <small>Just now</small>
                `;
                timeline.insertBefore(newEntry, timeline.firstChild);

                // Keep only the 3 most recent entries
                const entries = timeline.querySelectorAll('.timeline-item');
                if (entries.length > 3) {
                    entries[entries.length - 1].remove();
                }
            }
        }

        function updateAgentStatus(status) {
            const statusElements = document.querySelectorAll('.agent-status');
            statusElements.forEach(element => {
                element.className = `agent-status status-${status}`;
                element.innerHTML = `<span class="real-time-indicator"></span>${status.charAt(0).toUpperCase() + status.slice(1)}`;
            });
        }

        function updateSystemStatus() {
            if (!agentCoordinator) return;

            const status = agentCoordinator.getSystemStatus();

            // Update system health
            const healthElement = document.querySelector('.controls-panel .metric-value');
            if (healthElement) {
                healthElement.className = `metric-value score-${status.health.overallStatus === 'operational' ? 'high' : 'medium'}`;
                healthElement.textContent = status.health.overallStatus.charAt(0).toUpperCase() + status.health.overallStatus.slice(1);
            }
        }

        function startRealTimeUpdates() {
            // Simulate real-time updates
            setInterval(() => {
                if (agentCoordinator) {
                    updateSystemStatus();

                    // Randomly update some metrics to simulate real-time activity
                    if (Math.random() < 0.1) { // 10% chance every interval
                        simulateAgentActivity();
                    }
                }
            }, 5000); // Update every 5 seconds
        }

        function simulateAgentActivity() {
            const activities = [
                'Progress velocity increased by 3%',
                'New common ground identified',
                'Emotional stability confirmed',
                'Contract verification milestone reached',
                'Communication quality improved'
            ];

            const randomActivity = activities[Math.floor(Math.random() * activities.length)];
            showNotification('📊 ' + randomActivity, 'info');
        }

        async function generateContract() {
            if (!agentCoordinator) {
                showNotification('❌ Agent system not initialized', 'error');
                return;
            }

            showNotification('📋 Generating optimized repair contract...', 'info');

            // Simulate contract generation
            setTimeout(() => {
                const contractWindow = window.open('', '_blank');
                contractWindow.document.write(`
                    <html>
                        <head><title>Generated Repair Contract</title></head>
                        <body style="font-family: Arial, sans-serif; padding: 20px;">
                            <h1>🔧 REPAIR Protocol Contract</h1>
                            <h2>Generated by AI Agent Analysis</h2>

                            <h3>📋 Commitments</h3>
                            <ul>
                                <li><strong>Accountability:</strong> Full acknowledgment of harm caused within 24 hours</li>
                                <li><strong>Action:</strong> Attend anger management sessions starting within 1 week</li>
                                <li><strong>Communication:</strong> Weekly check-ins for 4 weeks to discuss progress</li>
                                <li><strong>Verification:</strong> Session completion certificates to be shared</li>
                            </ul>

                            <h3>📊 Success Metrics</h3>
                            <ul>
                                <li>100% attendance at committed sessions</li>
                                <li>Weekly progress reports completed on time</li>
                                <li>Trust level improvement measured monthly</li>
                            </ul>

                            <h3>⚠️ Risk Mitigation</h3>
                            <ul>
                                <li>Backup counseling options if primary unavailable</li>
                                <li>Alternative communication methods if needed</li>
                                <li>Regular assessment of emotional readiness</li>
                            </ul>

                            <p><em>Contract generated with AI optimization for maximum success probability (82%)</em></p>
                        </body>
                    </html>
                `);
                showNotification('✅ Contract generated successfully!', 'success');
            }, 2000);
        }

        async function startMediation() {
            if (!agentCoordinator) {
                showNotification('❌ Agent system not initialized', 'error');
                return;
            }

            showNotification('🤝 Initiating mediation session...', 'info');

            try {
                if (agentCoordinator.agents.mediationEngine) {
                    const parties = [
                        { id: 'party_1', name: 'Participant 1', role: 'apologizer' },
                        { id: 'party_2', name: 'Participant 2', role: 'affected_party' }
                    ];

                    const context = {
                        type: 'repair_mediation',
                        complexity: 'medium',
                        urgency: 'normal'
                    };

                    const session = agentCoordinator.agents.mediationEngine.initiateMediationSession(parties, context);

                    // Update UI to show mediation is active
                    updateMediationStatus(session);
                    showNotification('✅ Mediation session started successfully!', 'success');
                } else {
                    throw new Error('Mediation engine not available');
                }
            } catch (error) {
                showNotification('❌ Failed to start mediation: ' + error.message, 'error');
            }
        }

        function updateMediationStatus(session) {
            const mediationCard = document.querySelector('.agent-card.mediation');
            if (mediationCard) {
                const statusElement = mediationCard.querySelector('.agent-status');
                statusElement.className = 'agent-status status-active';
                statusElement.innerHTML = '<span class="real-time-indicator"></span>Mediating';

                const activeSessionsMetric = mediationCard.querySelectorAll('.metric-value')[3];
                if (activeSessionsMetric) {
                    activeSessionsMetric.textContent = '1 active session';
                }
            }
        }

        function refreshAgents() {
            showNotification('🔄 Refreshing agent status...', 'info');

            setTimeout(() => {
                updateSystemStatus();
                showNotification('✅ Agents refreshed successfully!', 'success');
            }, 1000);
        }

        function viewDetailedLogs() {
            if (!agentCoordinator) {
                showNotification('❌ Agent system not initialized', 'error');
                return;
            }

            const logs = agentCoordinator.agentCommunicationLog || [];
            const logsWindow = window.open('', '_blank');
            logsWindow.document.write(`
                <html>
                    <head><title>Agent Communication Logs</title></head>
                    <body style="font-family: monospace; padding: 20px;">
                        <h1>🤖 Agent Communication Logs</h1>
                        <div style="background: #f5f5f5; padding: 15px; border-radius: 8px;">
                            ${logs.slice(-20).map(log => `
                                <div style="margin-bottom: 10px; padding: 8px; background: white; border-radius: 4px;">
                                    <strong>${log.timestamp}</strong> -
                                    Agent: ${log.agent} |
                                    Method: ${log.method} |
                                    Time: ${log.executionTime}ms |
                                    Status: ${log.success ? '✅' : '❌'}
                                    ${log.error ? '<br>Error: ' + log.error : ''}
                                </div>
                            `).join('')}
                        </div>
                    </body>
                </html>
            `);
        }

        function exportResults() {
            if (!analysisResults || Object.keys(analysisResults).length === 0) {
                showNotification('⚠️ No analysis results to export', 'warning');
                return;
            }

            const exportData = {
                timestamp: new Date().toISOString(),
                processId: currentProcessId,
                analysis: analysisResults,
                systemStatus: agentCoordinator ? agentCoordinator.getSystemStatus() : null
            };

            const dataStr = JSON.stringify(exportData, null, 2);
            const dataBlob = new Blob([dataStr], {type: 'application/json'});
            const url = URL.createObjectURL(dataBlob);

            const link = document.createElement('a');
            link.href = url;
            link.download = `repair-analysis-${currentProcessId || Date.now()}.json`;
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            URL.revokeObjectURL(url);

            showNotification('💾 Analysis results exported successfully!', 'success');
        }

        function showNotification(message, type = 'info') {
            const notification = document.getElementById('notification');
            const content = document.getElementById('notificationContent');

            content.textContent = message;
            notification.className = `notification show ${type}`;

            setTimeout(() => {
                notification.className = 'notification';
            }, 4000);
        }

        // Demo mode - simulate some activity
        setTimeout(() => {
            if (document.getElementById('repairText').value) {
                showNotification('💡 Sample text loaded. Click "Start Analysis" to see AI agents in action!', 'info');
            }
        }, 2000);
    </script>
</body>
</html>