<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced REPAIR Protocol - Digital Platform</title>
    
    <!-- Desktop Enhancement Framework -->
    <link rel="stylesheet" href="desktop-enhancements.css">
    
    <script src="theme-system.js"></script>
    <style>
        :root {
            /* Light Theme Variables */
            --bg-primary: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --bg-secondary: rgba(255, 255, 255, 0.98);
            --bg-glass: rgba(255, 255, 255, 0.25);
            --bg-glass-hover: rgba(255, 255, 255, 0.35);
            --bg-glass-light: rgba(255, 255, 255, 0.8);
            --bg-input: rgba(255, 255, 255, 0.8);
            --bg-input-focus: white;
            --bg-card: #f9fafb;
            --text-primary: #1f2937;
            --text-secondary: #4b5563;
            --text-tertiary: #6b7280;
            --text-accent: #4c1d95;
            --text-warning: #92400e;
            --text-success: #065f46;
            --text-success-light: #047857;
            --text-hover: #667eea;
            --border-color: rgba(102, 126, 234, 0.2);
            --border-accent: rgba(139, 92, 246, 0.1);
            --shadow-color: rgba(0, 0, 0, 0.1);
            --shadow-hover: rgba(102, 126, 234, 0.3);
            --backdrop-blur: blur(20px);
        }

        [data-theme="dark"] {
            /* Dark Theme Variables - WCAG AA+ Compliant */
            --bg-primary: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            --bg-secondary: rgba(15, 23, 42, 0.98);
            --bg-glass: rgba(30, 41, 59, 0.85);
            --bg-glass-hover: rgba(30, 41, 59, 0.95);
            --bg-glass-light: rgba(30, 41, 59, 0.7);
            --bg-input: rgba(30, 41, 59, 0.8);
            --bg-input-focus: rgba(30, 41, 59, 0.95);
            --bg-card: rgba(15, 23, 42, 0.95);
            /* High contrast text colors for accessibility */
            --text-primary: #ffffff;
            --text-secondary: #f1f5f9;
            --text-tertiary: #e2e8f0;
            --text-accent: #c4b5fd;
            --text-warning: #fbbf24;
            --text-success: #34d399;
            --text-success-light: #10b981;
            --text-hover: #c4b5fd;
            --border-color: rgba(203, 213, 225, 0.3);
            --border-accent: rgba(196, 181, 253, 0.3);
            --shadow-color: rgba(0, 0, 0, 0.4);
            --shadow-hover: rgba(196, 181, 253, 0.4);
            --backdrop-blur: blur(20px);
        }
        
        /* Dark mode specific improvements */
        [data-theme="dark"] .contract-preview {
            background: var(--bg-card);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        [data-theme="dark"] .helper-text {
            background: var(--bg-glass-light);
            color: var(--text-secondary);
            border-left-color: #60a5fa;
        }
        
        [data-theme="dark"] .enhancement-item {
            background: var(--bg-glass-light);
            color: var(--text-primary);
            border-color: var(--border-accent);
        }
        
        [data-theme="dark"] .structure-item {
            background: var(--bg-glass-light);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .bias-item {
            background: var(--bg-glass-light);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .insight-item {
            background: var(--bg-glass-light);
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .history-item {
            background: var(--bg-glass-light);
            color: var(--text-primary);
        }
        
        /* Enhanced dark mode fixes for all elements */
        [data-theme="dark"] .navigation {
            border-color: var(--border-color);
        }
        
        [data-theme="dark"] .btn-secondary {
            background: var(--bg-glass-light);
            color: var(--text-primary);
            border-color: var(--border-color);
        }
        
        [data-theme="dark"] .btn-secondary:hover:not(:disabled) {
            background: var(--bg-glass-hover);
            color: var(--text-primary);
        }
        
        /* API Configuration modal dark mode fixes */
        [data-theme="dark"] .api-config-close {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .api-config-close:hover {
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .api-config-tabs {
            border-bottom-color: var(--border-color);
        }
        
        [data-theme="dark"] .api-config-tab {
            color: var(--text-tertiary);
        }
        
        [data-theme="dark"] .api-config-tab.active {
            color: var(--text-accent);
            border-bottom-color: var(--text-accent);
        }
        
        [data-theme="dark"] .api-config-tab:hover {
            color: var(--text-accent);
        }
        
        [data-theme="dark"] .quickstart-header {
            background: linear-gradient(135deg, rgba(196, 181, 253, 0.05) 0%, rgba(139, 92, 246, 0.05) 100%);
            border-color: rgba(196, 181, 253, 0.2);
        }
        
        [data-theme="dark"] .quickstart-header h3 {
            color: var(--text-primary);
        }
        
        [data-theme="dark"] .quickstart-header p {
            color: var(--text-secondary);
        }

        /* Theme Toggle Styling */
        .theme-toggle {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1000;
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 50px;
            padding: 12px 16px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-weight: 600;
            color: var(--text-primary);
            transition: all 0.3s ease;
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .theme-toggle:hover {
            background: var(--bg-glass-hover);
            transform: translateY(-2px);
            box-shadow: 0 8px 25px var(--shadow-hover);
        }

        .theme-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .theme-toggle:hover .theme-icon {
            transform: scale(1.1);
        }
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: var(--text-primary, #1f2937);
            background: var(--bg-primary, linear-gradient(135deg, #667eea 0%, #764ba2 100%));
            min-height: 100vh;
            transition: all 0.3s ease;
        }

        /* Dynamic Navigation */
        nav {
            background: var(--bg-glass, rgba(255,255,255,0.95));
            backdrop-filter: var(--backdrop-blur, blur(20px));
            padding: 15px;
            box-shadow: 0 2px 10px var(--shadow-color, rgba(0,0,0,0.1));
            position: sticky;
            top: 0;
            z-index: 100;
            border-bottom: 1px solid var(--border-color, rgba(102, 126, 234, 0.2));
        }

        .nav-container {
            max-width: 1400px;
            margin: 0 auto;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 30px;
            flex-wrap: wrap;
        }

        .nav-link {
            text-decoration: none;
            color: var(--text-secondary, #4b5563);
            font-weight: 600;
            padding: 8px 16px;
            border-radius: 8px;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .nav-link:hover {
            background: var(--bg-glass-hover, rgba(255, 255, 255, 0.35));
            color: var(--text-hover, #667eea);
        }

        .nav-link.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            cursor: default;
        }

        .nav-link.active:hover {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-nav-link {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 10px 20px;
            font-weight: 700;
            box-shadow: 0 2px 10px rgba(16, 185, 129, 0.3);
        }

        .ai-nav-link:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            color: white;
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            background: var(--bg-glass, rgba(255, 255, 255, 0.95));
            backdrop-filter: var(--backdrop-blur, blur(20px));
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 4px 20px var(--shadow-color, rgba(0, 0, 0, 0.1));
            border-bottom: 1px solid var(--border-color, rgba(102, 126, 234, 0.2));
        }

        .header h1 {
            font-size: clamp(2rem, 5vw, 3rem);
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            color: var(--text-tertiary, #6b7280);
            font-weight: 500;
        }

        .main-content {
            padding: 2rem 0;
            display: grid;
            grid-template-columns: 1fr;
            gap: 2rem;
        }

        .main-content.ai-mode {
            grid-template-columns: 1fr 350px;
        }

        /* AI Mode Toggle */
        .ai-mode-toggle {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            text-align: center;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Enhanced AI toggle dark mode text */
        [data-theme="dark"] .ai-mode-toggle p,
        [data-theme="dark"] .ai-mode-toggle span {
            color: var(--text-secondary) !important;
        }

        .toggle-switch {
            display: flex;
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 50px;
            padding: 4px;
            box-shadow: 0 4px 15px var(--shadow-color);
            border: 2px solid var(--border-color) !important;
            max-width: 300px;
            margin: 0 auto 1rem;
        }
        
        /* Enhanced toggle switch dark mode */
        [data-theme="dark"] .toggle-switch {
            background: var(--bg-glass) !important;
            border: 2px solid var(--border-color) !important;
        }

        .toggle-option {
            flex: 1;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
        }

        .toggle-option.active {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .toggle-option:not(.active) {
            color: var(--text-tertiary, #6b7280);
        }

        .toggle-option:not(.active):hover {
            background: var(--bg-glass-hover, #f3f4f6);
            color: var(--text-primary, #374151);
        }

        /* Agent Analysis Panel */
        .agent-panel {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            position: sticky;
            top: 100px;
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            display: none;
            border: 1px solid var(--border-color);
        }

        .agent-panel.active {
            display: block;
        }

        .agent-panel h3 {
            color: var(--text-success, #059669);
            font-size: 1.3rem;
            font-weight: 700;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .agent-status {
            padding: 1rem;
            border-radius: 12px;
            margin-bottom: 1rem;
            border-left: 4px solid #10b981;
            background: var(--bg-glass-light);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
        }

        .agent-status.analyzing {
            border-left-color: #f59e0b;
            background: var(--bg-glass-light);
        }

        .agent-status.warning {
            border-left-color: #ef4444;
            background: var(--bg-glass-light);
        }

        .agent-insights {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .insight-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-glass-light);
            border-radius: 8px;
            border-left: 3px solid #3b82f6;
            font-size: 0.9rem;
            color: var(--text-primary);
        }

        .insight-item.suggestion {
            border-left-color: #10b981;
        }

        .insight-item.warning {
            border-left-color: #f59e0b;
        }

        .insight-item.risk {
            border-left-color: #ef4444;
        }

        .emotional-gauge {
            background: var(--bg-glass-light);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
        }

        .gauge-meter {
            width: 100%;
            height: 20px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            overflow: hidden;
            margin: 0.5rem 0;
        }

        .gauge-fill {
            height: 100%;
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .gauge-fill.empathy {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .gauge-fill.sincerity {
            background: linear-gradient(90deg, #3b82f6 0%, #1d4ed8 100%);
        }

        .gauge-fill.completeness {
            background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
        }

        /* Real-time feedback indicator */
        .feedback-indicator {
            position: absolute;
            top: 35px;
            right: 10px;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            transition: all 0.3s ease;
        }

        .feedback-indicator.good {
            background: #10b981;
        }

        .feedback-indicator.warning {
            background: #f59e0b;
        }

        .feedback-indicator.poor {
            background: #ef4444;
        }

        .form-group {
            position: relative;
        }

        /* Progress Stepper */
        .progress-stepper {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            overflow-x: auto;
            border: 1px solid var(--border-color);
        }

        .stepper-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 800px;
            gap: 1rem;
        }

        .step {
            display: flex;
            align-items: center;
            flex-direction: column;
            text-align: center;
            min-width: 100px;
            cursor: pointer;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            border: 3px solid transparent;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .step-circle.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .step-circle.inactive {
        background: var(--bg-card);
        color: var(--text-tertiary);
        border: 3px solid var(--border-color);
        }
        
        .step-label {
        font-size: 0.9rem;
        font-weight: 600;
        color: var(--text-primary);
        }
        
        .step-connector {
        flex: 1;
        height: 3px;
        background: var(--border-color);
        margin: 0 1rem;
        border-radius: 2px;
        position: relative;
        top: -15px;
        }

        .step-connector.completed {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        /* Content Card */
        .content-card {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            margin-bottom: 2rem;
            animation: fadeIn 0.5s ease-in;
            border: 1px solid var(--border-color);
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .phase-title {
            font-size: 2rem;
            font-weight: 700;
            color: var(--text-primary, #1f2937);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1.1rem;
            color: var(--text-secondary, #6b7280);
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        /* Form Styling */
        .form-group {
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: var(--text-primary, #374151);
            margin-bottom: 0.5rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: var(--bg-input, rgba(255, 255, 255, 0.8));
            color: var(--text-primary, #1f2937);
            font-family: inherit;
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: var(--bg-input-focus, white);
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        /* Enhancement Box */
        .enhancement-box {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        /* Enhanced dark mode styling for enhancement boxes */
        [data-theme="dark"] .enhancement-box {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .enhancement-box * {
            color: var(--text-primary) !important;
        }

        .enhancement-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-accent);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .enhancement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .enhancement-item {
            background: var(--bg-glass-light) !important;
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid var(--border-accent) !important;
            font-size: 0.9rem;
            color: var(--text-primary) !important;
        }
        
        /* Enhanced enhancement items dark mode fix */
        [data-theme="dark"] .enhancement-item {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-accent) !important;
        }

        /* Bias Checklist */
        .bias-checklist {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .bias-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-warning);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bias-item {
            display: flex;
            align-items: flex-start;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-glass-light, rgba(255, 255, 255, 0.7));
            border-radius: 8px;
            transition: all 0.2s ease;
            color: var(--text-primary, #1f2937);
        }

        .bias-item:hover {
            background: var(--bg-glass-hover, rgba(255, 255, 255, 0.9));
        }

        .bias-checkbox {
            width: 20px;
            height: 20px;
            margin-top: 2px;
            border-radius: 4px;
            cursor: pointer;
            flex-shrink: 0;
            accent-color: #f59e0b;
        }

        /* Navigation Buttons */
        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 2rem;
            border-top: 2px solid var(--border-color);
            margin-top: 2rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
            background: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: var(--bg-glass-light) !important;
            color: var(--text-secondary) !important;
            border: 2px solid var(--border-color) !important;
        }
        
        .btn-secondary:hover:not(:disabled) {
            background: var(--bg-glass-hover) !important;
            color: var(--text-primary) !important;
        }
        
        /* Enhanced button dark mode fixes */
        [data-theme="dark"] .btn-secondary {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 2px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .btn-secondary:hover:not(:disabled) {
            background: var(--bg-glass-hover) !important;
            color: var(--text-primary) !important;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* Apology Structure */
        .apology-structure {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        /* Enhanced apology structure dark mode */
        [data-theme="dark"] .apology-structure {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .apology-structure * {
            color: var(--text-primary) !important;
        }

        .structure-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: var(--text-success);
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .structure-list {
            list-style: none;
        }

        .structure-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: var(--bg-glass-light) !important;
            border-radius: 8px;
            border-left: 4px solid #10b981;
            font-size: 0.95rem;
            color: var(--text-primary) !important;
        }
        
        /* Enhanced structure items dark mode */
        [data-theme="dark"] .structure-item {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
        }

        /* Contract Preview */
        .contract-preview {
            background: var(--bg-card, #f9fafb);
            border: 2px solid var(--border-color, #e5e7eb);
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            font-family: 'Monaco', 'Menlo', monospace;
            font-size: 0.9rem;
            line-height: 1.6;
            white-space: pre-line;
            color: var(--text-primary, #1f2937);
        }

        /* Completion Section */
        .completion-section {
            text-align: center;
            padding: 3rem;
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            margin-top: 2rem;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .completion-icon {
            font-size: 4rem;
            margin-bottom: 1rem;
        }

        .completion-title {
            font-size: 2rem;
            color: var(--text-success);
            margin-bottom: 1rem;
            font-weight: 700;
        }

        .completion-text {
            font-size: 1.1rem;
            color: var(--text-success-light);
            margin-bottom: 2rem;
        }

        /* Helper Text */
        .helper-text {
            font-size: 0.85rem;
            color: var(--text-secondary) !important;
            margin-top: 1rem;
            padding: 0.75rem;
            background: var(--bg-glass-light) !important;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Enhanced helper text dark mode */
        [data-theme="dark"] .helper-text {
            background: var(--bg-glass-light) !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border-color) !important;
        }

        @media (max-width: 1200px) {
            .main-content.ai-mode {
                grid-template-columns: 1fr;
            }

            .agent-panel {
                position: static;
                max-height: none;
                order: -1;
            }
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }

            .content-card {
                padding: 2rem;
            }

            .stepper-container {
                min-width: 600px;
            }

            .step {
                min-width: 80px;
            }

            .step-circle {
                width: 50px;
                height: 50px;
                font-size: 1.2rem;
            }

            .enhancement-grid {
                grid-template-columns: 1fr;
            }

            .toggle-switch {
                max-width: 100%;
            }
        }

        .emoji {
            font-style: normal;
        }

        /* API Configuration Modal */
        .api-config-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: var(--backdrop-blur);
            z-index: 2000;
            display: none;
            overflow-y: auto;
        }

        .api-config-modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .api-config-content {
            background: var(--bg-secondary);
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color);
            border-radius: 20px;
            padding: 3rem;
            max-width: 800px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
            box-shadow: 0 20px 40px var(--shadow-color);
        }

        .api-config-close {
            position: absolute;
            top: 20px;
            right: 25px;
            font-size: 2rem;
            cursor: pointer;
            color: #6b7280;
            transition: color 0.3s ease;
        }

        .api-config-close:hover {
            color: #374151;
        }

        .config-section {
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: var(--bg-glass-light);
            border-radius: 12px;
            border: 1px solid var(--border-color);
        }

        .config-section h3 {
            color: var(--text-primary);
            margin-bottom: 1rem;
            font-size: 1.2rem;
            font-weight: 600;
        }

        .config-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1rem;
        }

        .config-input-group {
            margin-bottom: 1rem;
        }

        .config-label {
            display: block;
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.5rem;
        }

        .config-input, .config-select {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            transition: border-color 0.3s ease;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .config-input:focus, .config-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        .config-status {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 0.5rem;
            font-size: 0.85rem;
        }

        .status-indicator {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: var(--text-tertiary);
        }

        .status-indicator.success {
            background: #10b981;
        }

        .status-indicator.error {
            background: #ef4444;
        }

        .status-indicator.warning {
            background: #f59e0b;
        }

        .config-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            margin-right: 1rem;
        }

        .config-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .config-button.secondary {
            background: #6b7280;
        }

        .config-button.danger {
            background: #ef4444;
        }
        .config-button.special {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            font-weight: 700;
            margin-left: 0.5rem;
            position: relative;
            overflow: hidden;
        }
        
        .config-button.special::after {
            content: '→';
            margin-left: 0.5rem;
            font-size: 1.1rem;
            transition: transform 0.3s ease;
        }
        
        .config-button.special:hover {
            background: linear-gradient(135deg, #059669 0%, #047857 100%);
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.4);
        }
        
        .config-button.special:hover::after {
            transform: translateX(3px);
        }
        
        .config-button.special:disabled {
            opacity: 0.7;
            cursor: not-allowed;
            transform: none;
        }
        
        .config-button.special:disabled::after {
            content: '';
            margin-left: 0;
        }

        /* API Config Tabs */
        .api-config-tabs {
            display: flex;
            margin-bottom: 2rem;
            border-bottom: 2px solid var(--border-color);
            gap: 0;
        }

        .api-config-tab {
            padding: 1rem 2rem;
            background: none;
            border: none;
            font-size: 1rem;
            font-weight: 600;
            color: #6b7280;
            cursor: pointer;
            transition: all 0.3s ease;
            border-bottom: 3px solid transparent;
            position: relative;
        }

        .api-config-tab.active {
            color: #667eea;
            border-bottom-color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
        }

        .api-config-tab:hover {
            color: #667eea;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.02) 0%, rgba(118, 75, 162, 0.02) 100%);
        }

        .tab-content {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-content.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* Code Examples */
        .code-examples-grid {
            display: grid;
            grid-template-columns: 1fr;
            gap: 1.5rem;
        }

        .code-example {
            background: #1e293b;
            border-radius: 12px;
            overflow: hidden;
            border: 1px solid #334155;
        }

        .code-example-header {
            background: #0f172a;
            padding: 1rem 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #334155;
        }

        .code-example-title {
            color: #e2e8f0;
            font-weight: 600;
            font-size: 0.9rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .language-icon {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
            color: white;
        }

        .language-icon.javascript { background: #f7df1e; color: #000; }
        .language-icon.python { background: #3776ab; }
        .language-icon.curl { background: #073642; }
        .language-icon.typescript { background: #3178c6; }

        .copy-button {
            background: #475569;
            color: #e2e8f0;
            border: none;
            padding: 0.5rem 1rem;
            border-radius: 6px;
            font-size: 0.8rem;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .copy-button:hover {
            background: #64748b;
        }

        .copy-button.copied {
            background: #059669;
        }

        .code-content {
            padding: 1.5rem;
            overflow-x: auto;
        }

        .code-content pre {
            margin: 0;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.85rem;
            line-height: 1.5;
            color: #e2e8f0;
        }

        .code-content code {
            font-family: inherit;
        }

        /* Syntax Highlighting */
        .keyword { color: #c792ea; }
        .string { color: #c3e88d; }
        .comment { color: #546e7a; font-style: italic; }
        .number { color: #f78c6c; }
        .operator { color: #89ddff; }
        .function { color: #82aaff; }
        .variable { color: #ffcb6b; }

        .quickstart-header {
            text-align: center;
            margin-bottom: 2rem;
            padding: 1.5rem;
            background: linear-gradient(135deg, rgba(102, 126, 234, 0.05) 0%, rgba(118, 75, 162, 0.05) 100%);
            border-radius: 12px;
            border: 1px solid rgba(102, 126, 234, 0.1);
        }

        .quickstart-header h3 {
            color: #374151;
            margin-bottom: 0.5rem;
            font-size: 1.3rem;
        }

        .quickstart-header p {
            color: #6b7280;
            margin: 0;
        }

        .view-docs-button {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 0.75rem 1.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-flex;
            align-items: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .view-docs-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3);
        }

        .config-placeholder {
            background: var(--bg-glass-light);
            border: 2px dashed var(--border-color);
            border-radius: 12px;
            padding: 2rem;
            text-align: center;
            color: var(--text-tertiary);
        }

        .config-placeholder-icon {
            font-size: 2rem;
            margin-bottom: 1rem;
        }

        /* Enhanced Chat Interface */
        .chat-interface {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            margin-top: 1rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            display: none;
            overflow: hidden;
            border: 1px solid var(--border-color);
            transition: all 0.3s ease;
        }
        
        .chat-interface:hover {
            box-shadow: 0 12px 40px var(--shadow-hover);
        }

        .chat-interface.active {
            display: block;
        }

        .chat-header {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            justify-content: between;
            gap: 1rem;
        }

        .chat-title {
            font-size: 1.1rem;
            font-weight: 600;
            flex: 1;
        }

        .chat-status {
            background: rgba(255, 255, 255, 0.2);
            padding: 0.25rem 0.75rem;
            border-radius: 20px;
            font-size: 0.8rem;
        }

        .chat-minimize {
            background: none;
            border: none;
            color: white;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            border-radius: 4px;
            transition: background 0.3s ease;
        }

        .chat-minimize:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .chat-messages {
            height: 400px;
            overflow-y: auto;
            padding: 1rem;
            background: var(--bg-card);
        }

        .chat-message {
            margin-bottom: 1rem;
            display: flex;
            gap: 0.75rem;
        }

        .chat-message.user {
            flex-direction: row-reverse;
        }

        .chat-avatar {
            width: 36px;
            height: 36px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
        }

        .chat-avatar.assistant {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
        }

        .chat-avatar.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .chat-bubble {
            max-width: 70%;
            padding: 0.75rem 1rem;
            border-radius: 12px;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .chat-bubble.assistant {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-bottom-left-radius: 4px;
            color: var(--text-primary);
        }

        .chat-bubble.user {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border-bottom-right-radius: 4px;
        }

        .chat-input-area {
            padding: 1rem 1.5rem;
            border-top: 1px solid var(--border-color);
            background: var(--bg-secondary);
        }

        .chat-input-container {
            display: flex;
            gap: 0.75rem;
            align-items: flex-end;
        }

        .chat-input {
            flex: 1;
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 12px;
            resize: none;
            min-height: 44px;
            max-height: 120px;
            font-family: inherit;
            font-size: 0.9rem;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .chat-input:focus {
            outline: none;
            border-color: #10b981;
            box-shadow: 0 0 0 3px rgba(16, 185, 129, 0.1);
        }

        .chat-send {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            border: none;
            border-radius: 12px;
            padding: 0.75rem 1rem;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .chat-send:hover:not(:disabled) {
            transform: translateY(-1px);
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .chat-send:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .chat-typing {
            display: none;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            font-size: 0.85rem;
            color: #6b7280;
        }

        .chat-typing.active {
            display: flex;
        }

        .typing-dots {
            display: flex;
            gap: 2px;
        }

        .typing-dot {
            width: 4px;
            height: 4px;
            border-radius: 50%;
            background: #10b981;
            animation: typingDot 1.4s infinite ease-in-out;
        }

        .typing-dot:nth-child(1) { animation-delay: -0.32s; }
        .typing-dot:nth-child(2) { animation-delay: -0.16s; }

        @keyframes typingDot {
            0%, 80%, 100% { opacity: 0.3; }
            40% { opacity: 1; }
        }

        /* AI Configuration Panel */
        .ai-config-panel {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            padding: 1.5rem;
            margin-bottom: 1rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            display: none;
            border: 1px solid var(--border-color);
        }

        .ai-config-panel.active {
            display: block;
        }

        .config-quick-setup {
            display: grid;
            grid-template-columns: 1fr auto;
            gap: 1rem;
            align-items: center;
            margin-bottom: 1rem;
        }

        .api-key-input {
            padding: 0.75rem;
            border: 1px solid var(--border-color);
            border-radius: 8px;
            font-size: 0.9rem;
            width: 100%;
            background: var(--bg-input);
            color: var(--text-primary);
        }

        .config-actions {
            display: flex;
            gap: 0.5rem;
        }

        .config-status-bar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0.75rem 1rem;
            background: var(--bg-glass-light);
            border-radius: 8px;
            font-size: 0.85rem;
            border: 1px solid var(--border-color);
        }

        /* Usage Stats */
        .usage-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
            margin-top: 1rem;
        }

        .usage-stat {
            text-align: center;
            padding: 1rem;
            background: var(--bg-secondary);
            border-radius: 8px;
            border: 1px solid var(--border-color);
        }

        .usage-stat-value {
            font-size: 1.5rem;
            font-weight: 700;
            color: #10b981;
        }

        .usage-stat-label {
            font-size: 0.8rem;
            color: #6b7280;
            margin-top: 0.25rem;
        }

        /* Contextual Insights */
        .contextual-insights {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 12px;
            padding: 1rem;
            margin: 1rem 0;
            border: 1px solid var(--border-color);
            box-shadow: 0 4px 15px var(--shadow-color);
        }

        .insights-title {
            font-size: 1rem;
            font-weight: 600;
            color: #5b21b6;
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .insight-list {
            display: flex;
            flex-direction: column;
            gap: 0.5rem;
        }

        .insight-item-ai {
            background: rgba(255, 255, 255, 0.8);
            padding: 0.75rem;
            border-radius: 8px;
            font-size: 0.9rem;
            border-left: 3px solid #8b5cf6;
        }

        /* Real-time Feedback */
        .realtime-feedback {
            position: absolute;
            top: 8px;
            right: 35px;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 0.75rem;
            color: #6b7280;
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .realtime-feedback.active {
            opacity: 1;
        }

        .feedback-score {
            padding: 0.25rem 0.5rem;
            border-radius: 4px;
            font-weight: 600;
            font-size: 0.7rem;
        }

        .feedback-score.excellent {
            background: #10b981;
            color: white;
        }

        .feedback-score.good {
            background: #3b82f6;
            color: white;
        }

        .feedback-score.fair {
            background: #f59e0b;
            color: white;
        }

        .feedback-score.poor {
            background: #ef4444;
            color: white;
        }

        /* Conversation History Panel */
        .conversation-history {
            background: var(--bg-secondary);
            border-radius: 12px;
            padding: 1rem;
            margin-top: 1rem;
            border: 1px solid var(--border-color);
            max-height: 300px;
            overflow-y: auto;
        }

        .history-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 0.75rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .history-item {
            padding: 0.5rem;
            margin-bottom: 0.5rem;
            background: var(--bg-glass-light);
            border-radius: 6px;
            font-size: 0.8rem;
            border-left: 2px solid #10b981;
            color: var(--text-primary);
        }

        .history-timestamp {
            color: var(--text-tertiary);
            font-size: 0.7rem;
        }

        /* Action Buttons for Contract */
        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .btn-download {
            background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%);
            color: white;
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            text-decoration: none;
            font-weight: 600;
            transition: all 0.3s ease;
            cursor: pointer;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        /* Enhanced Signature Section - Dark Mode Optimized */
        .signature-container {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            padding: 2rem !important;
            border-radius: 16px !important;
            box-shadow: 0 8px 32px var(--shadow-color) !important;
        }
        
        .signature-box {
            background: var(--bg-input) !important;
            border: 2px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            border-radius: 8px !important;
            padding: 1rem !important;
            transition: all 0.3s ease !important;
        }
        
        .signature-box:focus-within {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
        }
        
        .signature-input {
            background: var(--bg-input) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            border-radius: 8px !important;
            padding: 0.75rem !important;
            font-family: inherit !important;
        }
        
        .signature-input:focus {
            border-color: #667eea !important;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1) !important;
            background: var(--bg-input-focus) !important;
            outline: none !important;
        }
        
        .signature-label {
            color: var(--text-primary) !important;
            font-weight: 600 !important;
            margin-bottom: 0.75rem !important;
            display: block !important;
            font-size: 1rem !important;
        }
        
        /* Dark mode signature canvas styling */
        [data-theme="dark"] .signature-box canvas {
            background: var(--bg-input) !important;
            border-radius: 6px !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Enhanced signature area fixes for all related elements */
        .signature-section,
        .signature-area,
        .signing-area,
        .contract-signing {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        .signature-section h3,
        .signature-section h4,
        .signature-section p,
        .signature-section label,
        .contract-signing h3,
        .contract-signing h4,
        .contract-signing p,
        .contract-signing label,
        .signing-area h3,
        .signing-area h4,
        .signing-area p,
        .signing-area label {
            color: var(--text-primary) !important;
        }
        
        .signature-instructions {
            background: var(--bg-glass-light) !important;
            color: var(--text-secondary) !important;
            border: 1px solid var(--border-color) !important;
            padding: 1rem !important;
            border-radius: 8px !important;
            margin-bottom: 1.5rem !important;
        }
        
        /* Fix contract preview signature areas */
        [data-theme="dark"] .contract-preview {
            background: var(--bg-card) !important;
            color: var(--text-primary) !important;
            border-color: var(--border-color) !important;
        }
        
        /* Fix contract signature fields specifically */
        [data-theme="dark"] .signature-field,
        [data-theme="dark"] .date-field {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Enhanced AI Analysis Panel Styling */
        .agent-panel {
            background: var(--bg-glass);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 20px;
            padding: 2rem;
            box-shadow: 0 8px 32px var(--shadow-color);
            position: sticky;
            top: 100px;
            height: fit-content;
            max-height: calc(100vh - 120px);
            overflow-y: auto;
            display: none;
            border: 1px solid var(--border-color);
        }
        
        /* Enhanced Apology Structure List Items - Dark Mode Fix */
        .apology-structure-list {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        .apology-structure-item {
            padding: 1rem;
            margin-bottom: 1rem;
            background: var(--bg-glass-light) !important;
            border-radius: 12px;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
            font-size: 1rem;
            line-height: 1.6;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .apology-structure-item:hover {
            background: var(--bg-glass-hover) !important;
            border-color: var(--text-accent) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        /* Enhanced apology structure item dark mode fixes */
        [data-theme="dark"] .apology-structure-list {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .apology-structure-item {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .apology-structure-item:hover {
            background: var(--bg-glass-hover) !important;
            border-color: var(--text-accent) !important;
        }
        
        /* Number styling for apology structure items */
        .apology-structure-item .item-number {
            display: inline-block;
            background: var(--text-accent);
            color: white;
            width: 2rem;
            height: 2rem;
            border-radius: 50%;
            text-align: center;
            line-height: 2rem;
            font-weight: 700;
            margin-right: 1rem;
            font-size: 0.9rem;
            flex-shrink: 0;
        }
        
        .apology-structure-item .item-content {
            flex: 1;
            color: var(--text-primary) !important;
        }
        
        .apology-structure-item .item-title {
            font-weight: 700;
            color: var(--text-accent) !important;
            margin-bottom: 0.5rem;
        }
        
        .apology-structure-item .item-description {
            color: var(--text-secondary) !important;
            font-style: italic;
            font-size: 0.9rem;
        }
        
        /* Enhanced structure box styling */
        .structure-box {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        [data-theme="dark"] .structure-box {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .structure-box * {
            color: var(--text-primary) !important;
        }
        
        /* Phase 4 specific enhancements */
        .articulate-phase .numbered-list {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 16px;
            padding: 2rem;
            margin: 2rem 0;
        }
        
        .articulate-phase .numbered-list li {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            list-style: none;
            position: relative;
        }
        
        [data-theme="dark"] .articulate-phase .numbered-list {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Additional Enhanced Apology Structure Elements */
        .enhanced-apology-structure,
        .apology-framework,
        .structure-guidelines {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid var(--border-color) !important;
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        /* Any structure list styling */
        .structure-list,
        .apology-list,
        .framework-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }
        
        .structure-list li,
        .apology-list li,
        .framework-list li {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            padding: 1rem;
            margin-bottom: 1rem;
            border-radius: 12px;
            position: relative;
            transition: all 0.3s ease;
        }
        
        .structure-list li:hover,
        .apology-list li:hover,
        .framework-list li:hover {
            background: var(--bg-glass-hover) !important;
            border-color: var(--text-accent) !important;
            transform: translateY(-2px);
            box-shadow: 0 4px 15px var(--shadow-color);
        }
        
        /* Dark mode fixes for all structure elements */
        [data-theme="dark"] .enhanced-apology-structure,
        [data-theme="dark"] .apology-framework,
        [data-theme="dark"] .structure-guidelines {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .enhanced-apology-structure *,
        [data-theme="dark"] .apology-framework *,
        [data-theme="dark"] .structure-guidelines * {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .structure-list li,
        [data-theme="dark"] .apology-list li,
        [data-theme="dark"] .framework-list li {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .structure-list li:hover,
        [data-theme="dark"] .apology-list li:hover,
        [data-theme="dark"] .framework-list li:hover {
            background: var(--bg-glass-hover) !important;
            border-color: var(--text-accent) !important;
        }
        
        /* Generic numbered/bulleted list dark mode fixes */
        [data-theme="dark"] ul li,
        [data-theme="dark"] ol li {
            color: var(--text-primary) !important;
        }
        
        /* Enhanced visibility for any content boxes */
        [data-theme="dark"] .content-box,
        [data-theme="dark"] .info-box,
        [data-theme="dark"] .guidelines-box {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .content-box *,
        [data-theme="dark"] .info-box *,
        [data-theme="dark"] .guidelines-box * {
            color: var(--text-primary) !important;
        }
        
        /* Enhanced AI panel text visibility */
        [data-theme="dark"] .agent-panel,
        [data-theme="dark"] .agent-panel * {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .agent-panel h3,
        [data-theme="dark"] .agent-panel h4,
        [data-theme="dark"] .agent-panel p,
        [data-theme="dark"] .agent-panel label,
        [data-theme="dark"] .agent-panel span {
            color: var(--text-primary) !important;
        }
        
        /* AI panel sections enhanced visibility */
        [data-theme="dark"] .agent-status {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .agent-insights {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Comprehensive AI Analysis Panel Dark Mode Fixes */
        .agent-panel {
            background: var(--bg-glass) !important;
            backdrop-filter: var(--backdrop-blur);
            border: 1px solid var(--border-color) !important;
            color: var(--text-primary) !important;
        }
        
        /* AI Panel Headers and Titles */
        .agent-panel h3,
        .agent-panel h4,
        .agent-panel h5 {
            color: var(--text-primary) !important;
            background: var(--bg-glass-light) !important;
            padding: 0.75rem 1rem;
            border-radius: 8px;
            border: 1px solid var(--border-color) !important;
            margin-bottom: 1rem;
        }
        
        /* AI Status and Insights Containers */
        .agent-status,
        .agent-insights,
        .contextual-insights,
        .conversation-history,
        .emotional-gauge,
        .ai-config-panel {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 12px;
            padding: 1rem;
            margin-bottom: 1rem;
        }
        
        /* AI Insight Items */
        .insight-item,
        .insight-item-ai,
        .history-item,
        .optimization-tip {
            background: var(--bg-glass) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
            border-radius: 8px;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            border-left: 3px solid var(--text-accent);
        }
        
        .insight-item:hover,
        .insight-item-ai:hover,
        .history-item:hover {
            background: var(--bg-glass-hover) !important;
            border-color: var(--text-accent) !important;
            transform: translateY(-1px);
            box-shadow: 0 2px 8px var(--shadow-color);
        }
        
        /* Risk Warnings Styling */
        .risk-warning,
        .warning-item {
            background: rgba(239, 68, 68, 0.1) !important;
            border: 1px solid rgba(239, 68, 68, 0.3) !important;
            color: var(--text-primary) !important;
            border-left: 3px solid #ef4444;
        }
        
        /* Optimization Tips Styling */
        .optimization-tip,
        .suggestion-item {
            background: rgba(16, 185, 129, 0.1) !important;
            border: 1px solid rgba(16, 185, 129, 0.3) !important;
            color: var(--text-primary) !important;
            border-left: 3px solid #10b981;
        }
        
        /* Chat Interface Dark Mode Fixes */
        [data-theme="dark"] .chat-interface {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .chat-messages {
            background: var(--bg-card) !important;
        }
        
        [data-theme="dark"] .chat-bubble.assistant {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .chat-input-area {
            background: var(--bg-glass-light) !important;
            border-top: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .chat-input {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Emotional Gauge Enhancements */
        [data-theme="dark"] .emotional-gauge {
            background: var(--bg-glass-light) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .emotional-gauge h4,
        [data-theme="dark"] .emotional-gauge label {
            color: var(--text-primary) !important;
        }
        
        [data-theme="dark"] .gauge-meter {
            background: var(--bg-input) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        /* Configuration Panel Dark Mode */
        [data-theme="dark"] .ai-config-panel {
            background: var(--bg-glass) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .config-quick-setup,
        [data-theme="dark"] .config-status-bar {
            background: var(--bg-glass-light) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .api-key-input {
            background: var(--bg-input) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .usage-stats {
            background: var(--bg-glass-light) !important;
        }
        
        [data-theme="dark"] .usage-stat {
            background: var(--bg-glass) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .usage-stat-label {
            color: var(--text-secondary) !important;
        }
        
        /* Real-time Feedback Elements */
        [data-theme="dark"] .realtime-feedback {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .feedback-indicator {
            border: 2px solid var(--border-color) !important;
        }
        
        /* AI Panel Typography Improvements */
        [data-theme="dark"] .agent-panel .insights-title,
        [data-theme="dark"] .agent-panel .history-title {
            color: var(--text-accent) !important;
            font-weight: 700;
        }
        
        [data-theme="dark"] .agent-panel .status-text,
        [data-theme="dark"] .agent-panel .connection-text {
            color: var(--text-secondary) !important;
        }
        
        /* Ensure all AI panel buttons are visible */
        [data-theme="dark"] .agent-panel button {
            background: var(--bg-glass-light) !important;
            color: var(--text-primary) !important;
            border: 1px solid var(--border-color) !important;
        }
        
        [data-theme="dark"] .agent-panel button:hover {
            background: var(--bg-glass-hover) !important;
            border-color: var(--text-accent) !important;
        }
        
        /* Generic AI panel list items */
        [data-theme="dark"] .agent-panel ul li,
        [data-theme="dark"] .agent-panel ol li {
            color: var(--text-primary) !important;
        }
        
        .agent-panel h3 {
            color: var(--text-success);
            font-size: 1.4rem;
            font-weight: 700;
            margin-bottom: 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 1rem;
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.1) 100%);
            border-radius: 12px;
            border-left: 4px solid var(--text-success);
            box-shadow: 0 2px 8px rgba(16, 185, 129, 0.2);
        }
        
        .agent-panel h4 {
            color: var(--text-primary);
            font-size: 1.1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            margin-top: 1.5rem;
            padding: 0.75rem;
            background: var(--bg-glass-light);
            border-radius: 8px;
            border-left: 3px solid #667eea;
        }
        
        .emotional-gauge {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.05) 0%, rgba(124, 58, 237, 0.05) 100%);
            border: 1px solid rgba(139, 92, 246, 0.2);
            box-shadow: 0 4px 12px rgba(139, 92, 246, 0.1);
        }
        
        .emotional-gauge h4 {
            color: var(--text-primary);
            font-size: 1rem;
            font-weight: 600;
            margin-bottom: 1rem;
            padding: 0.75rem;
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.1) 0%, rgba(124, 58, 237, 0.1) 100%);
            border-radius: 8px;
            border-left: 4px solid #8b5cf6;
            text-align: center;
        }
        
        .emotional-gauge label {
            color: var(--text-secondary);
            font-weight: 500;
            font-size: 0.9rem;
            margin-bottom: 0.5rem;
            display: block;
        }
        
        /* Enhanced gauge styling */
        .gauge-meter {
            width: 100%;
            height: 24px;
            background: var(--bg-input);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            overflow: hidden;
            margin: 0.5rem 0;
            box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .gauge-fill {
            height: 100%;
            border-radius: 12px;
            transition: width 0.8s ease;
            position: relative;
        }
        
        .gauge-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(90deg, transparent 0%, rgba(255, 255, 255, 0.3) 50%, transparent 100%);
            animation: shimmer 2s infinite;
        }
        
        @keyframes shimmer {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        /* Improved AI Panel Spacing and Organization */
        .agent-panel > * {
            margin-bottom: 1.5rem;
        }
        
        .agent-panel .agent-status:last-child {
            margin-bottom: 0;
        }
        
        /* AI Status indicators with better visual hierarchy */
        .agent-status {
            position: relative;
            overflow: hidden;
        }
        
        .agent-status::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 4px;
            height: 100%;
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            border-radius: 0 2px 2px 0;
        }
        
        .agent-status.analyzing::before {
            background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);
        }
        
        .agent-status.warning::before {
            background: linear-gradient(135deg, #ef4444 0%, #dc2626 100%);
        }
    </style>
</head>
<body>
    <!-- Theme Toggle Button -->
    <div class="theme-toggle" onclick="toggleTheme()">
        <span class="theme-icon" id="theme-icon">🌙</span>
        <span id="theme-text">Dark Mode</span>
    </div>
    <nav>
        <div class="nav-container">
            <a href="index.html" class="nav-link">
                <span class="emoji">🏠</span> Home
            </a>
            <span class="nav-link active">
                <span class="emoji">🔧</span> REPAIR Protocol
            </span>
            <a href="about.html" class="nav-link">
                <span class="emoji">📊</span> Visual Framework
            </a>
            <a href="progress.html" class="nav-link">
                <span class="emoji">📈</span> Progress
            </a>
            <a href="mediation-mode.html" class="nav-link">
                <span class="emoji">🤝</span> Mediation
            </a>
            <a href="sign-contract.html" class="nav-link">
                <span class="emoji">✍️</span> Sign Contract
            </a>
            <a href="https://chatgpt.com/g/g-685f7ec1cae4819183b514fdeff27b43-repair-protocol-support-bot"
               class="nav-link ai-nav-link"
               target="_blank"
               rel="noopener noreferrer">
                <span class="emoji">🤖</span> AI Coach
            </a>
            <button class="nav-link" onclick="openAPIConfig()" style="background: none; border: none; cursor: pointer;">
                <span class="emoji">⚙️</span> API Setup
            </button>

        </div>
    </nav>

    <div class="header">
        <div class="container desktop-optimized">
            <h1>Enhanced REPAIR Protocol</h1>
            <p>Reconciliation & Emotional Process for Apology, Integration, & Restoration</p>
            <div style="margin-top: 1rem; font-size: 0.9rem; color: #8b5cf6;">
                <strong>Enhanced with Cognitive Foundation Components</strong>
            </div>
        </div>
    </div>

    <div class="main-content" id="main-content">
        <div class="container desktop-optimized responsive-padding">
            <!-- AI Mode Toggle -->
            <div class="ai-mode-toggle desktop-center">
                <div class="toggle-switch">
                    <div class="toggle-option active" id="standard-toggle" onclick="toggleAIMode(false)">
                        <span class="emoji">🔧</span>
                        Standard
                    </div>
                    <div class="toggle-option" id="ai-toggle" onclick="toggleAIMode(true)">
                        <span class="emoji">🤖</span>
                        AI Enhanced
                    </div>
                </div>
                <p style="color: #6b7280; font-size: 0.9rem; margin: 0;">
                    <span id="mode-description">Experience the foundational REPAIR Protocol with comprehensive 8-phase workflow.</span>
                </p>
            </div>

            <!-- Progress Stepper -->
            <div class="progress-stepper desktop-center">
                <div class="stepper-container">
                    <div class="step" data-phase="0">
                        <div class="step-circle active" id="step-0">
                            <span class="emoji">📋</span>
                        </div>
                        <div class="step-label">Assessment</div>
                    </div>
                    <div class="step-connector" id="connector-0"></div>

                    <div class="step" data-phase="1">
                        <div class="step-circle inactive" id="step-1">
                            <span class="emoji">👁️</span>
                        </div>
                        <div class="step-label">Recognize</div>
                    </div>
                    <div class="step-connector" id="connector-1"></div>

                    <div class="step" data-phase="2">
                        <div class="step-circle inactive" id="step-2">
                            <span class="emoji">🔍</span>
                        </div>
                        <div class="step-label">Examine</div>
                    </div>
                    <div class="step-connector" id="connector-2"></div>

                    <div class="step" data-phase="3">
                        <div class="step-circle inactive" id="step-3">
                            <span class="emoji">📝</span>
                        </div>
                        <div class="step-label">Prepare</div>
                    </div>
                    <div class="step-connector" id="connector-3"></div>

                    <div class="step" data-phase="4">
                        <div class="step-circle inactive" id="step-4">
                            <span class="emoji">💬</span>
                        </div>
                        <div class="step-label">Articulate</div>
                    </div>
                    <div class="step-connector" id="connector-4"></div>

                    <div class="step" data-phase="5">
                        <div class="step-circle inactive" id="step-5">
                            <span class="emoji">⚡</span>
                        </div>
                        <div class="step-label">Implement</div>
                    </div>
                    <div class="step-connector" id="connector-5"></div>

                    <div class="step" data-phase="6">
                        <div class="step-circle inactive" id="step-6">
                            <span class="emoji">💚</span>
                        </div>
                        <div class="step-label">Restore</div>
                    </div>
                    <div class="step-connector" id="connector-6"></div>

                    <div class="step" data-phase="7">
                        <div class="step-circle inactive" id="step-7">
                            <span class="emoji">📄</span>
                        </div>
                        <div class="step-label">Contract</div>
                    </div>
                </div>
            </div>

            <!-- Phase Content -->
            <div class="content-card desktop-center" id="phase-content">
                <!-- Content will be dynamically loaded here -->
            </div>
        </div>

        <!-- AI Agent Analysis Panel -->
        <div class="agent-panel" id="agent-panel">
            <h3><span class="emoji">🤖</span> AI Analysis</h3>

            <div class="agent-status" id="agent-status">
                <strong>Status:</strong> <span id="status-text">Ready to analyze</span>
            </div>

            <!-- AI Configuration Panel -->
            <div class="ai-config-panel" id="ai-config-panel">
                <h4><span class="emoji">⚙️</span> Quick API Setup</h4>
                <div class="config-quick-setup">
                    <input type="password"
                           class="api-key-input"
                           id="quick-api-key"
                           placeholder="Enter your OpenAI API key"
                           autocomplete="off">
                    <div class="config-actions">
                        <button class="config-button" onclick="saveQuickAPIKey()">Save API Key</button>
                        <button class="config-button secondary" onclick="testConnection()">Test</button>
                        <button class="config-button special" onclick="openAPIExamples()">View API Examples</button>
                    </div>
                </div>
                <div class="config-status-bar" id="api-status-bar">
                    <div class="config-status">
                        <div class="status-indicator" id="api-status-indicator"></div>
                        <span id="api-status-text">No API key configured</span>
                    </div>
                    <button class="config-button secondary" onclick="openAPIConfig()">Advanced</button>
                </div>
                <div class="usage-stats" id="usage-stats" style="display: none;">
                    <div class="usage-stat">
                        <div class="usage-stat-value" id="requests-today">0</div>
                        <div class="usage-stat-label">Requests Today</div>
                    </div>
                    <div class="usage-stat">
                        <div class="usage-stat-value" id="tokens-used">0</div>
                        <div class="usage-stat-label">Tokens Used</div>
                    </div>
                    <div class="usage-stat">
                        <div class="usage-stat-value" id="success-rate">0%</div>
                        <div class="usage-stat-label">Success Rate</div>
                    </div>
                </div>
            </div>

            <!-- Chat Interface -->
            <div class="chat-interface" id="chat-interface">
                <div class="chat-header">
                    <div class="chat-title">REPAIR Protocol Assistant</div>
                    <div class="chat-status" id="chat-status">Ready</div>
                    <button class="chat-minimize" onclick="toggleChat()">−</button>
                </div>
                <div class="chat-messages" id="chat-messages">
                    <div class="chat-message">
                        <div class="chat-avatar assistant">🤖</div>
                        <div class="chat-bubble assistant">
                            Welcome! I'm your REPAIR Protocol assistant. I'm here to provide personalized guidance throughout your reconciliation journey. How can I support you today?
                        </div>
                    </div>
                </div>
                <div class="chat-typing" id="chat-typing">
                    <span>Assistant is typing</span>
                    <div class="typing-dots">
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                        <div class="typing-dot"></div>
                    </div>
                </div>
                <div class="chat-input-area">
                    <div class="chat-input-container">
                        <textarea class="chat-input"
                                  id="chat-input"
                                  placeholder="Ask for guidance, share your thoughts, or request help with any phase..."
                                  rows="1"></textarea>
                        <button class="chat-send" id="chat-send" onclick="sendChatMessage()">
                            <span class="emoji">➤</span>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Contextual Insights -->
            <div class="contextual-insights" id="contextual-insights" style="display: none;">
                <div class="insights-title">
                    <span class="emoji">💡</span>
                    Contextual Insights
                </div>
                <div class="insight-list" id="insight-list">
                    <!-- Insights will be populated here -->
                </div>
            </div>

            <!-- Conversation History -->
            <div class="conversation-history" id="conversation-history" style="display: none;">
                <div class="history-title">
                    <span><span class="emoji">📝</span> Session History</span>
                    <button onclick="clearChatHistory()" style="background: none; border: none; color: #6b7280; cursor: pointer;">Clear</button>
                </div>
                <div id="history-list">
                    <!-- History items will be populated here -->
                </div>
            </div>

            <div class="emotional-gauge">
                <h4>Emotional Intelligence Metrics</h4>
                <div>
                    <label>Empathy Level</label>
                    <div class="gauge-meter">
                        <div class="gauge-fill empathy" id="empathy-gauge" style="width: 0%"></div>
                    </div>
                    <span id="empathy-score">0%</span>
                </div>
                <div>
                    <label>Sincerity Level</label>
                    <div class="gauge-meter">
                        <div class="gauge-fill sincerity" id="sincerity-gauge" style="width: 0%"></div>
                    </div>
                    <span id="sincerity-score">0%</span>
                </div>
                <div>
                    <label>Completeness</label>
                    <div class="gauge-meter">
                        <div class="gauge-fill completeness" id="completeness-gauge" style="width: 0%"></div>
                    </div>
                    <span id="completeness-score">0%</span>
                </div>
            </div>

            <div class="agent-insights" id="agent-insights">
                <h4>Real-time Insights</h4>
                <div id="insights-list">
                    <div class="insight-item">Complete the assessment to receive AI-powered guidance</div>
                </div>
            </div>

            <div id="risk-warnings" style="display: none;">
                <h4 style="color: #ef4444;">⚠️ Risk Warnings</h4>
                <div id="warnings-list"></div>
            </div>

            <div id="optimization-tips">
                <h4>💡 Optimization Tips</h4>
                <div id="tips-list">
                    <div class="insight-item suggestion">Start with honest self-reflection</div>
                </div>
            </div>
        </div>
    </div>

    <!-- API Configuration Modal -->
    <div class="api-config-modal" id="api-config-modal">
        <div class="api-config-content">
            <span class="api-config-close" onclick="closeAPIConfig()">&times;</span>
            <h2 style="margin-bottom: 2rem; color: #374151;">API Configuration</h2>

            <!-- Tab Navigation -->
            <div class="api-config-tabs">
                <button class="api-config-tab active" onclick="switchTab('configuration')">Configuration</button>
                <button class="api-config-tab" onclick="switchTab('quickstart')">🚀 API Integration Quickstart</button>
                <button class="api-config-tab" onclick="switchTab('test')">Test Connection</button>
            </div>

            <!-- Configuration Tab -->
            <div id="tab-configuration" class="tab-content active">
            <!-- Provider Configuration -->
            <div class="config-section">
                <h3><span class="emoji">🔗</span> API Provider Settings</h3>
                <div class="config-grid">
                    <div class="config-input-group">
                        <label class="config-label">Provider</label>
                        <select class="config-select" id="config-provider" onchange="updateProviderSettings()">
                            <option value="openai">OpenAI</option>
                            <option value="azure">Azure OpenAI</option>
                            <option value="anthropic">Anthropic Claude</option>
                            <option value="custom">Custom Endpoint</option>
                        </select>
                    </div>
                    <div class="config-input-group">
                        <label class="config-label">Model</label>
                        <select class="config-select" id="config-model">
                            <option value="gpt-4">GPT-4</option>
                            <option value="gpt-4-turbo">GPT-4 Turbo</option>
                            <option value="gpt-3.5-turbo">GPT-3.5 Turbo</option>
                            <option value="gpt-4o">GPT-4o</option>
                            <option value="claude-3-opus-20240229">Claude 3 Opus</option>
                            <option value="claude-3-sonnet-20240229">Claude 3 Sonnet</option>
                            <option value="claude-3-haiku-20240307">Claude 3 Haiku</option>
                        </select>
                    </div>
                </div>
                <div class="config-input-group">
                    <label class="config-label">API Endpoint</label>
                    <input type="text" class="config-input" id="config-endpoint" placeholder="https://api.openai.com/v1/chat/completions">
                </div>
                <div class="config-input-group">
                    <label class="config-label">API Key</label>
                    <input type="password" class="config-input" id="config-api-key" placeholder="Enter your API key">
                    <div class="config-status" id="connection-status">
                        <div class="status-indicator" id="connection-indicator"></div>
                        <span id="connection-text">Not tested</span>
                    </div>
                </div>
            </div>

            <!-- Model Parameters -->
            <div class="config-section">
                <h3><span class="emoji">⚙️</span> Model Parameters</h3>
                <div class="config-grid">
                    <div class="config-input-group">
                        <label class="config-label">Temperature (0.0 - 1.0)</label>
                        <input type="number" class="config-input" id="config-temperature" min="0" max="1" step="0.1" value="0.7">
                    </div>
                    <div class="config-input-group">
                        <label class="config-label">Max Tokens</label>
                        <input type="number" class="config-input" id="config-max-tokens" min="100" max="4000" value="2000">
                    </div>
                    <div class="config-input-group">
                        <label class="config-label">Request Timeout (ms)</label>
                        <input type="number" class="config-input" id="config-timeout" min="5000" max="60000" value="30000">
                    </div>
                </div>
            </div>

            <!-- Rate Limiting -->
            <div class="config-section">
                <h3><span class="emoji">⏱️</span> Rate Limiting</h3>
                <div class="config-grid">
                    <div class="config-input-group">
                        <label class="config-label">Requests per Minute</label>
                        <input type="number" class="config-input" id="config-rpm" min="1" max="100" value="10">
                    </div>
                    <div class="config-input-group">
                        <label class="config-label">Requests per Hour</label>
                        <input type="number" class="config-input" id="config-rph" min="10" max="1000" value="100">
                    </div>
                    <div class="config-input-group">
                        <label class="config-label">Daily Token Limit</label>
                        <input type="number" class="config-input" id="config-daily-limit" min="1000" max="50000" value="10000">
                    </div>
                </div>
            </div>

            <!-- Features -->
            <div class="config-section">
                <h3><span class="emoji">✨</span> Features</h3>
                <div class="config-grid">
                    <div class="config-input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="feature-conversation-history" checked>
                            <span>Conversation History</span>
                        </label>
                    </div>
                    <div class="config-input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="feature-real-time-feedback" checked>
                            <span>Real-time Feedback</span>
                        </label>
                    </div>
                    <div class="config-input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="feature-emotional-analysis" checked>
                            <span>Emotional Analysis</span>
                        </label>
                    </div>
                    <div class="config-input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="feature-bias-detection" checked>
                            <span>Bias Detection</span>
                        </label>
                    </div>
                    <div class="config-input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="feature-progress-tracking" checked>
                            <span>Progress Tracking</span>
                        </label>
                    </div>
                    <div class="config-input-group">
                        <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">
                            <input type="checkbox" id="feature-auto-save" checked>
                            <span>Auto-save</span>
                        </label>
                    </div>
                </div>
            </div>

            <!-- Actions -->
            <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 2rem; border-top: 1px solid #e5e7eb;">
                <button class="config-button danger" onclick="resetAPIConfig()">Reset to Defaults</button>
                <button class="config-button" onclick="saveAPIConfig()">Save Configuration</button>
            </div>
            </div>

            <!-- Quickstart Tab -->
            <div id="tab-quickstart" class="tab-content">
                <div class="quickstart-header">
                    <h3>🚀 API Integration Quickstart</h3>
                    <p>Copy and paste these examples to integrate with your current configuration</p>
                    <button class="view-docs-button" onclick="window.open('api-quickstart.html', '_blank')">
                        📚 View Full Documentation
                    </button>
                </div>

                <div class="code-examples-grid" id="code-examples-container">
                    <!-- Code examples will be dynamically generated here -->
                    <div class="config-placeholder">
                        <div class="config-placeholder-icon">⚙️</div>
                        <p>Configure your API settings in the Configuration tab to see code examples</p>
                    </div>
                </div>
            </div>

            <!-- Test Connection Tab -->
            <div id="tab-test" class="tab-content">
                <div class="config-section">
                    <h3><span class="emoji">🔍</span> Test API Connection</h3>
                    <p style="margin-bottom: 1.5rem; color: #6b7280;">Test your API configuration to ensure everything is working correctly.</p>

                    <div class="config-input-group">
                        <label class="config-label">Test Message</label>
                        <textarea class="config-input" id="test-message" rows="3" placeholder="Enter a test message to send to the API...">Hello, this is a test message to verify the API connection.</textarea>
                    </div>

                    <div class="config-input-group">
                        <label class="config-label">Connection Status</label>
                        <div class="config-status" id="connection-status">
                            <div class="status-indicator" id="connection-indicator"></div>
                            <span id="connection-text">Not tested</span>
                        </div>
                    </div>

                    <div style="display: flex; gap: 1rem; justify-content: flex-end; padding-top: 1rem;">
                        <button class="config-button secondary" onclick="testAPIConnection()">Test Connection</button>
                    </div>

                    <div id="test-results" style="display: none; margin-top: 1.5rem;">
                        <h4 style="color: #374151; margin-bottom: 1rem;">Test Results</h4>
                        <div class="code-example">
                            <div class="code-example-header">
                                <div class="code-example-title">
                                    <span class="language-icon" style="background: #10b981;">✓</span>
                                    API Response
                                </div>
                            </div>
                            <div class="code-content">
                                <pre id="test-response-content">No test performed yet</pre>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentPhase = 0;
        let aiMode = false;
        let formData = {
            harmDescription: '',
            affectedParty: '',
            harmSeverity: '',
            readiness: '',
            specificActions: '',
            responsibility: '',
            emotionalImpact: '',
            directImpacts: '',
            secondaryEffects: '',
            systemicImplications: '',
            acknowledgmentStatement: '',
            changeCommitment: '',
            amendsProposal: '',
            timeline: '',
            apologyText: '',
            immediateActions: '',
            longTermChanges: '',
            progressCheckins: '',
            trustMetrics: '',
            healingIndicators: '',
            biasChecklist: {},
            apologizerSignature: '',
            affectedPartySignature: '',
            signatureDate: ''
        };

        const phases = [
            { name: 'Assessment', icon: '📋' },
            { name: 'Recognize', icon: '👁️' },
            { name: 'Examine', icon: '🔍' },
            { name: 'Prepare', icon: '📝' },
            { name: 'Articulate', icon: '💬' },
            { name: 'Implement', icon: '⚡' },
            { name: 'Restore', icon: '💚' },
            { name: 'Contract', icon: '📄' }
        ];

        // Theme Toggle Function
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
            
            document.documentElement.setAttribute('data-theme', newTheme);
            localStorage.setItem('theme', newTheme);
            
            // Update theme toggle button
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (newTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }
        }
        
        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);
            
            // Update theme toggle button
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');
            
            if (savedTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }
            
            // Check URL parameters for mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            if (mode === 'ai') {
                toggleAIMode(true);
            }

            renderPhaseContent();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Phase navigation
            document.querySelectorAll('.step').forEach((step, index) => {
                step.addEventListener('click', () => goToPhase(index));
            });
        }

        function toggleAIMode(enable) {
            aiMode = enable;

            // Update toggle UI
            document.getElementById('standard-toggle').classList.toggle('active', !enable);
            document.getElementById('ai-toggle').classList.toggle('active', enable);

            // Update main content layout
            const mainContent = document.getElementById('main-content');
            mainContent.classList.toggle('ai-mode', enable);

            // Show/hide agent panel
            const agentPanel = document.getElementById('agent-panel');
            agentPanel.classList.toggle('active', enable);

            // Update description
            const description = document.getElementById('mode-description');
            if (enable) {
                description.textContent = 'AI-enhanced version with real-time analysis, intelligent feedback, and predictive insights.';
            } else {
                description.textContent = 'Experience the foundational REPAIR Protocol with comprehensive 8-phase workflow.';
            }

            // If AI mode is enabled, initialize AI features
            if (enable && window.RepairIntegrator) {
                window.RepairIntegrator.initialize();
            }
        }

        function saveFormData() {
            // Save to memory and trigger AI analysis if in AI mode
            if (aiMode && window.RepairIntegrator) {
                window.RepairIntegrator.analyzeFormData(formData);
            }
        }

        function updateFormData(field, value) {
            formData[field] = value;
            saveFormData();
        }

        function goToPhase(phaseIndex) {
            if (phaseIndex >= 0 && phaseIndex < phases.length) {
                currentPhase = phaseIndex;
                updateStepperUI();
                renderPhaseContent();

                // Trigger phase-specific AI analysis if in AI mode
                if (aiMode && window.RepairIntegrator) {
                    window.RepairIntegrator.analyzePhase(currentPhase, formData);
                }
            }
        }

        function nextPhase() {
            if (currentPhase < phases.length - 1) {
                currentPhase++;
                updateStepperUI();
                renderPhaseContent();
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Trigger AI analysis for new phase if in AI mode
                if (aiMode && window.RepairIntegrator) {
                    window.RepairIntegrator.analyzePhase(currentPhase, formData);
                }
            }
        }

        function prevPhase() {
            if (currentPhase > 0) {
                currentPhase--;
                updateStepperUI();
                renderPhaseContent();
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
        }

        function updateStepperUI() {
            phases.forEach((phase, index) => {
                const stepCircle = document.getElementById(`step-${index}`);
                const connector = document.getElementById(`connector-${index}`);

                stepCircle.className = 'step-circle';
                if (index < currentPhase) {
                    stepCircle.classList.add('completed');
                    stepCircle.innerHTML = '<span class="emoji">✓</span>';
                    if (connector) connector.classList.add('completed');
                } else if (index === currentPhase) {
                    stepCircle.classList.add('active');
                    stepCircle.innerHTML = `<span class="emoji">${phase.icon}</span>`;
                } else {
                    stepCircle.classList.add('inactive');
                    stepCircle.innerHTML = `<span class="emoji">${phase.icon}</span>`;
                    if (connector) connector.classList.remove('completed');
                }
            });
        }

        function renderPhaseContent() {
            const content = document.getElementById('phase-content');
            content.className = 'content-card';

            switch(currentPhase) {
                case 0: content.innerHTML = getAssessmentContent(); break;
                case 1: content.innerHTML = getRecognizeContent(); break;
                case 2: content.innerHTML = getExamineContent(); break;
                case 3: content.innerHTML = getPrepareContent(); break;
                case 4: content.innerHTML = getArticulateContent(); break;
                case 5: content.innerHTML = getImplementContent(); break;
                case 6: content.innerHTML = getRestoreContent(); break;
                case 7: content.innerHTML = getContractContent(); break;
            }

            bindFormEvents();
        }

        function bindFormEvents() {
            // Bind all form inputs with enhanced AI feedback
            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('input', (e) => {
                    updateFormData(e.target.name, e.target.value);

                    // Add AI feedback if in AI mode
                    if (aiMode) {
                        addFeedbackIndicator(e.target);

                        // Trigger AI analysis if available
                        if (window.RepairIntegrator) {
                            window.RepairIntegrator.provideFeedback(e.target.name, e.target.value, currentPhase);
                        }
                    }
                });

                // Set current values
                if (formData[input.name] !== undefined) {
                    input.value = formData[input.name];
                }
            });

            // Bind checkboxes
            document.querySelectorAll('.bias-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    formData.biasChecklist[e.target.name] = e.target.checked;
                    saveFormData();

                    // AI analysis for bias completion if in AI mode
                    if (aiMode && window.RepairIntegrator) {
                        window.RepairIntegrator.analyzeFormData(formData);
                    }
                });

                // Set current state
                if (formData.biasChecklist[checkbox.name]) {
                    checkbox.checked = true;
                }
            });
        }

        function addFeedbackIndicator(input) {
            // Remove existing indicator
            const existingIndicator = input.parentNode.querySelector('.feedback-indicator');
            if (existingIndicator) {
                existingIndicator.remove();
            }

            // Add new indicator based on analysis
            const indicator = document.createElement('div');
            indicator.className = 'feedback-indicator';

            // Simulate AI analysis (replace with actual AI logic)
            const analysis = analyzeInput(input.value, input.name);
            indicator.classList.add(analysis.quality);

            input.parentNode.appendChild(indicator);
        }

        function analyzeInput(value, fieldName) {
            // Simplified analysis logic (replace with actual AI integration)
            if (!value || value.length < 10) {
                return { quality: 'poor', feedback: 'Needs more detail' };
            } else if (value.length < 50) {
                return { quality: 'warning', feedback: 'Could be more comprehensive' };
            } else {
                return { quality: 'good', feedback: 'Good level of detail' };
            }
        }

        function getNavigationButtons() {
            return `
                <div class="navigation">
                    <button class="btn btn-secondary" onclick="prevPhase()" ${currentPhase === 0 ? 'disabled' : ''}>
                        <span class="emoji">←</span> Previous
                    </button>
                    <button class="btn btn-primary" onclick="nextPhase()" ${currentPhase === phases.length - 1 ? 'disabled' : ''}>
                        Next <span class="emoji">→</span>
                    </button>
                </div>
            `;
        }

        function getAssessmentContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">📋</span>
                    Initial Assessment
                </div>
                <div class="phase-subtitle">
                    Let's begin by understanding the situation and your readiness for this enhanced reconciliation process.
                </div>

                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <span class="emoji">🧠</span>
                        Cognitive Enhancement Framework Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Active Listening (0.9):</strong> Complete information gathering
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Emotional awareness and context
                        </div>
                        <div class="enhancement-item">
                            <strong>Memory Context (0.6):</strong> Learning integration foundation
                        </div>
                        <div class="enhancement-item">
                            <strong>Bias Mitigation (0.6):</strong> Objective assessment preparation
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Describe the harm that occurred:</label>
                    <textarea class="form-textarea" name="harmDescription" placeholder="What happened that caused harm? Be specific and comprehensive..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Who was affected?</label>
                    <input type="text" class="form-input" name="affectedParty" placeholder="Name or description of affected party">
                </div>

                <div class="form-group">
                    <label class="form-label">How would you rate the severity of harm?</label>
                    <select class="form-select" name="harmSeverity">
                        <option value="">Select severity level</option>
                        <option value="mild">Mild - Minor impact, easily addressed</option>
                        <option value="moderate">Moderate - Significant impact, requires effort</option>
                        <option value="severe">Severe - Major impact, substantial work needed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">How ready are you to engage in this enhanced process?</label>
                    <select class="form-select" name="readiness">
                        <option value="">Select readiness level</option>
                        <option value="fully">Fully ready - Committed to complete cognitive enhancement process</option>
                        <option value="mostly">Mostly ready - Some concerns but willing to engage</option>
                        <option value="somewhat">Somewhat ready - Need more consideration and support</option>
                    </select>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getRecognizeContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">👁️</span>
                    Phase 1: RECOGNIZE
                </div>
                <div class="phase-subtitle">
                    Acknowledge harm and establish comprehensive awareness through enhanced cognitive processing.
                </div>

                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <span class="emoji">🧠</span>
                        Enhanced Recognition Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Active Listening (0.9):</strong> Complete information gathering about impact
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Recognition of emotional states and contexts
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Thought (0.7):</strong> Structured analysis of actions and consequences
                        </div>
                    </div>
                </div>

                <div class="bias-checklist">
                    <div class="bias-title">
                        <span class="emoji">🛡️</span>
                        Bias Mitigation Checklist
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="minimization" id="minimization">
                        <label for="minimization">I understand the minimization bias: "It wasn't that bad"</label>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="intent" id="intent">
                        <label for="intent">I understand the intent fallacy: "I didn't mean to hurt anyone"</label>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="comparative" id="comparative">
                        <label for="comparative">I understand the comparative bias: "Others have done worse"</label>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="victim_blaming" id="victim_blaming">
                        <label for="victim_blaming">I understand victim blaming: "They're too sensitive"</label>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">What specific actions or inactions caused harm?</label>
                    <textarea class="form-textarea" name="specificActions" placeholder="Be specific about what you did or didn't do..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">How do you accept responsibility for these actions?</label>
                    <textarea class="form-textarea" name="responsibility" placeholder="Express your acceptance of responsibility without deflection..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">What emotional impact did your behavior have?</label>
                    <textarea class="form-textarea" name="emotionalImpact" placeholder="Describe the emotional impact on the affected party..."></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getExamineContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">🔍</span>
                    Phase 2: EXAMINE
                </div>
                <div class="phase-subtitle">
                    Deep understanding of the full scope of impact through logical analysis.
                </div>

                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <span class="emoji">🧠</span>
                        Enhanced Analysis Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Chain of Reasoning (0.9):</strong> Logical analysis of causation
                        </div>
                        <div class="enhancement-item">
                            <strong>Bias Mitigation (0.9):</strong> Objective assessment
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Thought (0.8):</strong> Structured examination
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Direct impacts on the affected party:</label>
                    <textarea class="form-textarea" name="directImpacts" placeholder="What were the immediate and direct consequences?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Secondary effects on relationships:</label>
                    <textarea class="form-textarea" name="secondaryEffects" placeholder="How did this affect others in your shared circles?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Systemic implications:</label>
                    <textarea class="form-textarea" name="systemicImplications" placeholder="What patterns or larger issues does this reveal?"></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getPrepareContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">📝</span>
                    Phase 3: PREPARE
                </div>
                <div class="phase-subtitle">
                    Formulate your authentic apology and restoration plan.
                </div>

                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <span class="emoji">💭</span>
                        Enhanced Preparation Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Wisdom-Understanding (0.9):</strong> Balanced approach
                        </div>
                        <div class="enhancement-item">
                            <strong>Memory Context (0.8):</strong> Learning integration
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.8):</strong> Appropriate response
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Clear acknowledgment statement:</label>
                    <textarea class="form-textarea" name="acknowledgmentStatement" placeholder="I acknowledge that I..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Commitment to change:</label>
                    <textarea class="form-textarea" name="changeCommitment" placeholder="What specific changes will you make?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Specific amends proposal:</label>
                    <textarea class="form-textarea" name="amendsProposal" placeholder="What concrete actions will you take to make amends?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Implementation timeline:</label>
                    <textarea class="form-textarea" name="timeline" placeholder="When will you complete these actions?"></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getArticulateContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">💬</span>
                    Phase 4: ARTICULATE
                </div>
                <div class="phase-subtitle">
                    Craft your complete, authentic apology with emotional awareness.
                </div>

                <div class="apology-structure">
                    <div class="structure-title">
                        <span class="emoji">📋</span>
                        Enhanced Apology Structure
                    </div>
                    <ul class="structure-list">
                        <li class="structure-item">1. "I acknowledge that I..." (Specific Actions)</li>
                        <li class="structure-item">2. "This caused..." (Impact Recognition)</li>
                        <li class="structure-item">3. "I understand that..." (Deep Implications)</li>
                        <li class="structure-item">4. "I will..." (Specific Changes)</li>
                        <li class="structure-item">5. "To make amends..." (Restoration Proposals)</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label class="form-label">Your complete enhanced apology:</label>
                    <textarea class="form-textarea" name="apologyText" rows="10" placeholder="Write your complete apology following the structure above..."></textarea>
                </div>

                <div class="helper-text">
                    <strong>Delivery Requirements:</strong> Create safe space, maintain authentic delivery, apply responsive communication, and ensure complete expression.
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getImplementContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">⚡</span>
                    Phase 5: IMPLEMENT
                </div>
                <div class="phase-subtitle">
                    Execute comprehensive restoration plan with systematic tracking.
                </div>

                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <span class="emoji">📅</span>
                        Implementation Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Memory Context (0.9):</strong> Learning integration
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Reasoning (0.8):</strong> Logical implementation
                        </div>
                        <div class="enhancement-item">
                            <strong>Wisdom-Understanding (0.7):</strong> Balanced approach
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Immediate actions (0-2 weeks):</label>
                    <textarea class="form-textarea" name="immediateActions" placeholder="What will you do immediately?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Long-term changes (3+ months):</label>
                    <textarea class="form-textarea" name="longTermChanges" placeholder="What sustainable changes will you maintain?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Progress check-in schedule:</label>
                    <textarea class="form-textarea" name="progressCheckins" placeholder="When and how will you check progress?"></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getRestoreContent() {
            return `
                <div class="phase-title">
                    <span class="emoji">💚</span>
                    Phase 6: RESTORE
                </div>
                <div class="phase-subtitle">
                    Rebuild trust and restore relationships through consistent action.
                </div>

                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <span class="emoji">🌱</span>
                        Restoration Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Wisdom-Understanding (0.9):</strong> Patient rebuilding
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Relationship healing
                        </div>
                        <div class="enhancement-item">
                            <strong>Active Listening (0.8):</strong> Ongoing dialogue
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Trust rebuilding metrics:</label>
                    <textarea class="form-textarea" name="trustMetrics" placeholder="How will you measure trust restoration?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Healing indicators:</label>
                    <textarea class="form-textarea" name="healingIndicators" placeholder="What signs will show relationship healing?"></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getContractContent() {
            const contractText = generateContract();
            
            return `
                <div class="phase-title" style="text-align: center;">
                    <span class="emoji">📄</span>
                    Enhanced Contract & Progress Tracking
                </div>
                <div class="phase-subtitle" style="text-align: center;">
                    Review, sign, and set up comprehensive tracking for your Enhanced REPAIR Protocol agreement.
                </div>
                
                <div style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); border-radius: 16px; padding: 30px; margin: 30px 0; text-align: center; box-shadow: 0 8px 25px rgba(16, 185, 129, 0.3);">
                    <div style="font-size: 1.5rem; font-weight: 700; color: white; margin-bottom: 15px;">
                        <span class="emoji">🤖</span> AI Coaching Support Ready!
                    </div>
                    <p style="color: rgba(255,255,255,0.95); font-size: 1.1rem; line-height: 1.6;">
                        After signing, scroll down to open the REPAIR Protocol AI coach for personalized guidance.
                    </p>
                </div>

                <div class="contract-preview" id="contractPreviewDiv" style="position: relative;">
                    ${contractText}
                    <div id="repairHeartAnimation" style="display: none; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); z-index: 1000; pointer-events: none;">
                        <img src="https://github.com/user-attachments/assets/0bdb61c2-fc8c-422a-a991-ef42454f2b1c" 
                             alt="REPAIR BOT" 
                             style="width: 300px; height: auto;">
                    </div>
                </div>
                
                <!-- Signature Section -->
                <div class="signature-section">
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); gap: 20px; margin-bottom: 20px;">
                        <div class="signature-container">
                            <label class="signature-label">Apologizer Signature:</label>
                            <input type="text" id="repairSignature1" placeholder="Type your full name" class="signature-input">
                        </div>
                        <div class="signature-container">
                            <label class="signature-label">Affected Party Signature:</label>
                            <input type="text" id="repairSignature2" placeholder="Affected party's full name" class="signature-input">
                        </div>
                    </div>
                    
                    <button class="btn btn-primary" id="signRepairButton" onclick="signRepairContract()" style="width: 100%; padding: 16px; font-size: 1.1rem; display: flex; align-items: center; justify-content: center; gap: 10px;">
                        <span class="emoji">✓</span>
                        Sign Enhanced Agreement
                    </button>
                </div>

                <div class="action-buttons" id="repairActionButtons" style="display: none;">
                    <button class="btn-download" onclick="downloadContract()">
                        <span class="emoji">📥</span> Download REPAIR Contract
                    </button>
                    <button class="btn-download" onclick="copyContract()" style="background: #6b7280;">
                        <span class="emoji">📋</span> Copy REPAIR Contract
                    </button>
                    <button class="btn-download" onclick="viewRepairContract()" style="background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);">
                        <span class="emoji">👁️</span> View REPAIR Contract
                    </button>
                    <button class="btn-download" onclick="printContract()" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%);">
                        <span class="emoji">🖨️</span> Print REPAIR Contract
                    </button>
                </div>
                
                <div class="helper-text" style="margin-top: 20px;">
                    <p style="font-size: 0.95rem; margin: 0;">
                        <strong>Export Options:</strong> Download works outside Claude.ai • Copy works everywhere • View shows modal preview • Print opens browser print/save as PDF
                    </p>
                </div>

                <div class="completion-section">
                    <div class="completion-icon emoji">🎉</div>
                    <h2 class="completion-title">Protocol Complete!</h2>
                    <p class="completion-text">
                        You've completed the Enhanced REPAIR Protocol. Your journey of reconciliation continues with implementation and ongoing support.
                    </p>
                    <a href="https://chatgpt.com/g/g-685f7ec1cae4819183b514fdeff27b43-repair-protocol-support-bot" 
                       class="btn-download" 
                       target="_blank"
                       style="max-width: 300px; margin: 0 auto;">
                        <span class="emoji">🤖</span> Continue with AI Coach
                    </a>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function generateContract() {
            const date = new Date().toLocaleDateString();
            const harmSeverityLevel = formData.harmSeverity ? formData.harmSeverity.charAt(0).toUpperCase() + formData.harmSeverity.slice(1) : 'Not assessed';
            
            return `ENHANCED REPAIR PROTOCOL RECONCILIATION AGREEMENT
Reconciliation & Emotional Process for Apology, Integration, & Restoration
Enhanced with Cognitive Foundation Components

================================================================================
CONTRACT METADATA
================================================================================
Date: ${date}
Parties: ${formData.apologizerSignature || '[Apologizer]'} and ${formData.affectedParty || '[Affected Party]'}
Severity Level: ${harmSeverityLevel}
Readiness Assessment: ${formData.readiness || 'Not assessed'}
Framework Version: Enhanced REPAIR Protocol v2.0

================================================================================
COGNITIVE ENHANCEMENT CONFIGURATION
================================================================================
This agreement incorporates advanced cognitive processing for enhanced effectiveness:

Active Listening (AL): High priority in RECOGNIZE and ARTICULATE phases
Memory Context (MC): Integrated throughout for learning retention and pattern recognition
Chain of Thought (CoT): Applied for structured analysis and communication
Chain of Reasoning (CoR): Enhanced logical analysis in EXAMINE phase
Bias Mitigation (BM): Systematic objectivity checks throughout process
Wisdom-Understanding (WU): Balanced intuitive and analytical approach
Emotional Intelligence (EI): High-level emotional awareness and regulation

Performance Target Metrics (0.0-1.0 scale):
- Information Completeness: Target 0.8+
- Emotional Recognition Accuracy: Target 0.8+
- Logical Consistency: Target 0.9+
- Bias Detection Effectiveness: Target 0.8+
- Implementation Consistency: Target 0.9+
- Trust Restoration Progress: Target 0.7+

================================================================================
PHASE 1: RECOGNIZE - ENHANCED ACKNOWLEDGMENT
================================================================================

HARM DESCRIPTION:
${formData.harmDescription || 'Not specified'}

SPECIFIC ACTIONS THAT CAUSED HARM:
${formData.specificActions || 'Not specified'}

RESPONSIBILITY ACCEPTANCE:
${formData.responsibility || 'Not specified'}

EMOTIONAL IMPACT RECOGNITION:
${formData.emotionalImpact || 'Not specified'}

COGNITIVE ENHANCEMENT COMMITMENTS FOR RECOGNIZE PHASE:
- Apply Active Listening (Level 0.9) to fully understand all impacts
- Use Emotional Intelligence (Level 0.9) to recognize and validate feelings
- Complete bias mitigation checklist for defensive thinking
- Achieve minimum 0.8 performance score on acknowledgment authenticity

BIAS MITIGATION CHECKLIST COMPLETION REQUIRED:
□ Minimization bias: "It wasn't that bad"
□ Intent fallacy: "I didn't mean to hurt anyone" 
□ Comparative bias: "Others have done worse"
□ Victim blaming: "They're too sensitive"
□ Self-pity bias: "I'm the real victim here"
□ Perfectionism bias: "I never do anything right"

================================================================================
PHASE 2: EXAMINE - ENHANCED ANALYSIS
================================================================================

DIRECT IMPACTS IDENTIFIED:
${formData.directImpacts || 'Not specified'}

SECONDARY EFFECTS ON COMMUNITY:
${formData.secondaryEffects || 'Not specified'}

SYSTEMIC IMPLICATIONS:
${formData.systemicImplications || 'Not specified'}

COGNITIVE ENHANCEMENT COMMITMENTS FOR EXAMINE PHASE:
- Apply Chain of Reasoning (Level 0.9) for logical impact analysis
- Use Bias Mitigation (Level 0.9) to ensure objective self-assessment
- Complete pattern analysis for recurring behaviors
- Achieve minimum 0.8 performance score on impact assessment completeness

REQUIRED ANALYSIS COMPONENTS:
- Immediate harm assessment with logical causation mapping
- Ripple effect analysis on relationships and community
- Trust damage evaluation with safety implications
- Personal pattern identification with root cause analysis

================================================================================
PHASE 3: PREPARE - ENHANCED PLANNING
================================================================================

ACKNOWLEDGMENT STATEMENT:
${formData.acknowledgmentStatement || 'Not specified'}

COMMITMENT TO CHANGE:
${formData.changeCommitment || 'Not specified'}

SPECIFIC AMENDS PROPOSAL:
${formData.amendsProposal || 'Not specified'}

IMPLEMENTATION TIMELINE:
${formData.timeline || 'Not specified'}

COGNITIVE ENHANCEMENT COMMITMENTS FOR PREPARE PHASE:
- Apply Wisdom-Understanding (Level 0.9) for balanced approach
- Use Memory Context (Level 0.8) to integrate past learning
- Employ Emotional Intelligence (Level 0.8) for appropriate response design
- Achieve minimum 0.8 performance score on authenticity and comprehensiveness

REQUIRED PREPARATION COMPONENTS:
- Wisdom Processing: Connect with genuine remorse and empathy
- Understanding Processing: Organize systematic apology structure
- Synthesis Integration: Balance emotional authenticity with practical commitments
- Memory Integration: Apply learning from past experiences

================================================================================
PHASE 4: ARTICULATE - ENHANCED COMMUNICATION
================================================================================

COMPLETE APOLOGY TEXT:
${formData.apologyText || 'Not specified'}

COGNITIVE ENHANCEMENT COMMITMENTS FOR ARTICULATE PHASE:
- Apply Active Listening (Level 0.9) during delivery for responsive communication
- Use Emotional Intelligence (Level 0.9) to read and respond to emotional cues
- Employ Chain of Thought (Level 0.8) for clear, organized presentation
- Achieve minimum 0.8 performance score on delivery authenticity

REQUIRED COMMUNICATION STRUCTURE:
1. "I acknowledge that I..." (Specific Actions with Emotional Awareness)
2. "This caused..." (Comprehensive Impact Recognition)
3. "I understand that..." (Deep Implications with Wisdom Integration)
4. "I will..." (Specific Changes with Memory Context)
5. "To make amends..." (Meaningful Restoration Proposals)

DELIVERY REQUIREMENTS:
- Safe space creation with emotional safety protocols
- Authentic delivery with genuine presence and emotion
- Responsive communication with real-time feedback adjustment
- Complete expression covering all prepared elements

================================================================================
PHASE 5: IMPLEMENT - ENHANCED ACTION
================================================================================

IMMEDIATE CORRECTIVE ACTIONS (0-2 weeks):
${formData.immediateActions || 'Not specified'}

LONG-TERM SYSTEMIC CHANGES (2+ weeks):
${formData.longTermChanges || 'Not specified'}

PROGRESS CHECK-IN SCHEDULE:
${formData.progressCheckins || 'Not specified'}

COGNITIVE ENHANCEMENT COMMITMENTS FOR IMPLEMENT PHASE:
- Apply Memory Context (Level 0.9) for learning integration and pattern tracking
- Use Chain of Reasoning (Level 0.8) for logical implementation and adjustment
- Employ systematic progress tracking with documented metrics
- Achieve minimum 0.9 performance score on implementation consistency

MEMORY CONTEXT INTEGRATION SCHEDULE:
- 24 hours: Review and reinforcement of key commitments
- 3 days: Pattern application practice and initial habit formation
- 1 week: Integration assessment and progress evaluation
- 2 weeks: Adjustment and refinement of approach
- 1 month: Long-term retention check and sustainability assessment

REQUIRED IMPLEMENTATION ACTIONS:
□ Immediate cessation of harmful behaviors
□ Safety measure implementation where needed
□ Communication and transparency practice initiation
□ Documentation and accountability system activation
□ Professional help engagement if specified

================================================================================
PHASE 6: RESTORE - ENHANCED RELATIONSHIP HEALING
================================================================================

TRUST REBUILDING METRICS:
${formData.trustMetrics || 'Not specified'}

RELATIONSHIP HEALING INDICATORS:
${formData.healingIndicators || 'Not specified'}

COGNITIVE ENHANCEMENT COMMITMENTS FOR RESTORE PHASE:
- Apply Wisdom-Understanding (Level 0.9) for balanced approach to healing
- Use Emotional Intelligence (Level 0.9) to navigate complex emotional dynamics
- Employ Memory Context (Level 0.8) for learning from healing process
- Achieve minimum 0.7 performance score on trust restoration progress

REQUIRED RESTORATION COMPONENTS:
- Trust Rebuilding: Demonstrate consistency between words and actions
- Relationship Healing: Navigate complex emotional restoration with patience
- Pattern Prevention: Maintain sustainable change and growth systems
- Community Restoration: Contribute to broader healing and education

LONG-TERM SUSTAINABILITY METRICS:
- Consistency between commitments and actions (Target: 0.9+)
- Transparency in communication and decision-making (Target: 0.8+)
- Respect for boundaries and agreements (Target: 0.9+)
- Demonstration of genuine change over time (Target: 0.8+)

================================================================================
PERFORMANCE TRACKING FRAMEWORK
================================================================================

COGNITIVE ENHANCEMENT EFFECTIVENESS TRACKING:
Each phase will be evaluated using the following metrics (0.0-1.0 scale):

RECOGNIZE Phase Metrics:
- Information completeness score
- Emotional recognition accuracy
- Acknowledgment authenticity rating
- Safe space establishment effectiveness

EXAMINE Phase Metrics:
- Logical consistency score
- Bias detection accuracy
- Impact assessment completeness
- Pattern recognition quality

PREPARE Phase Metrics:
- Authenticity assessment
- Comprehensiveness rating
- Specificity and actionability score
- Emotional appropriateness

ARTICULATE Phase Metrics:
- Delivery authenticity
- Emotional appropriateness
- Responsiveness to feedback
- Completeness of communication

IMPLEMENT Phase Metrics:
- Implementation consistency
- Behavior change sustainability
- Learning integration effectiveness
- Accountability engagement quality

RESTORE Phase Metrics:
- Trust restoration rate
- Relationship quality improvement
- Pattern prevention effectiveness
- Community healing contribution

================================================================================
QUALITY ASSURANCE PROTOCOLS
================================================================================

CONTINUOUS MONITORING REQUIREMENTS:
- Real-time adjustment of cognitive enhancement levels based on effectiveness
- Regular check-ins with all parties using structured assessment tools
- Progress measurement against established metrics with documented evidence
- Early warning system activation for process breakdown indicators
- Support system engagement when performance falls below target thresholds

VALIDATION CHECKPOINTS:
□ Phase completion verification with quality assessment
□ Stakeholder satisfaction evaluation using standardized measures
□ Objective third-party review when requested or indicated
□ Long-term sustainability assessment at 3, 6, and 12 month intervals
□ Community impact evaluation for broader healing contribution

CRISIS MANAGEMENT INTEGRATION:
If severe distress, safety concerns, or process breakdown occurs:
- Prioritize safety over process completion speed
- Engage professional mental health support coordination
- Implement safety planning and risk assessment protocols
- Activate community intervention and support systems
- Document concerns for professional follow-up and learning

================================================================================
ADAPTIVE CONFIGURATION SETTINGS
================================================================================

CULTURAL ADAPTATION PROTOCOL:
This agreement acknowledges and accommodates:
- Cultural communication patterns and expectations
- Power dynamics and hierarchical considerations
- Religious or spiritual integration where relevant
- Community healing traditions and practices
- Language and accessibility accommodations

PROFESSIONAL RESOURCE INTEGRATION:
This process may integrate with:
- Mental health support coordination for emotional processing
- Legal consultation where appropriate for serious matters
- Safety planning and risk assessment for complex situations
- Community intervention and support for broader healing
- Long-term therapeutic integration for sustained growth

================================================================================
COMMITMENT AND SIGNATURES
================================================================================

APOLOGIZER COMMITMENT:
"I, ${formData.apologizerSignature || '[Apologizer Name]'}, commit to engaging fully with this Enhanced REPAIR Protocol process. I understand that this involves not only completing the agreed actions but also applying advanced cognitive enhancement techniques for deeper understanding, more effective communication, and lasting change. I commit to the performance targets outlined above and to continuous improvement throughout this journey."

AFFECTED PARTY ACKNOWLEDGMENT:
"I, ${formData.affectedPartySignature || '[Affected Party Name]'}, acknowledge this comprehensive commitment to reconciliation and healing. I understand the enhanced framework being applied and commit to engaging with this process in good faith, while maintaining my right to adjust timelines and boundaries as needed for my own healing and safety."

SHARED COMMITMENT:
"We both agree to approach this Enhanced REPAIR Protocol with patience, authenticity, and commitment to genuine healing and restoration. We understand that this process is designed to create lasting positive change through advanced cognitive processing and emotional intelligence application."

SIGNATURES:
Apologizer: ${formData.apologizerSignature || '[Signature Required]'}
Date: ${formData.signatureDate || '[Date Required]'}

Affected Party: ${formData.affectedPartySignature || '[Signature Required]'}
Date: ${formData.signatureDate || '[Date Required]'}

================================================================================
AI SUPPORT COACHING INFORMATION
================================================================================

🤖 PERSONALIZED AI SUPPORT AVAILABLE

Congratulations on completing your Enhanced REPAIR Protocol contract! You now have access to specialized AI coaching designed specifically for this framework.

Your AI coach will:
✅ Track your progress against these specific commitments
✅ Guide you through cognitive enhancement exercises
✅ Provide accountability and emotional support
✅ Generate performance reports using the metrics above
✅ Help you navigate challenges with bias mitigation techniques
✅ Support memory context integration for lasting change

TO BEGIN AI COACHING:
1. Upload this signed contract to your REPAIR Protocol AI Coach
2. Complete the initial cognitive enhancement assessment
3. Begin your guided journey with personalized daily support

Your AI coach uses the same enhanced cognitive framework outlined in this contract, ensuring consistent, effective support throughout your reconciliation journey.

Remember: Healing takes time, and every step forward matters. You've shown courage by signing this enhanced contract - your AI coach will help you succeed! 🌱

================================================================================
END OF ENHANCED REPAIR PROTOCOL CONTRACT
================================================================================

This Enhanced REPAIR Protocol Contract represents a comprehensive commitment to healing, growth, and reconciliation using advanced cognitive processing techniques for maximum effectiveness and sustainability.

Framework Version: Enhanced REPAIR Protocol v2.0 with Cognitive Foundation Integration
Generated by: REPAIR Protocol Digital Platform
Date: ${date}`;
        }

        function downloadContract() {
            const contractText = generateContract();
            const blob = new Blob([contractText], { type: 'text/plain' });
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `Enhanced_REPAIR_Contract_${new Date().toISOString().split('T')[0]}.txt`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        function copyContract() {
            const contractText = generateContract();
            navigator.clipboard.writeText(contractText).then(() => {
                alert('Contract copied to clipboard!');
            }).catch(err => {
                console.error('Failed to copy:', err);
                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = contractText;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);
                alert('Contract copied to clipboard!');
            });
        }
        
        function signRepairContract() {
            const sig1 = document.getElementById('repairSignature1')?.value || '';
            const sig2 = document.getElementById('repairSignature2')?.value || '';
            
            if (!sig1 || !sig2) {
                alert('Please enter both signatures');
                return;
            }
            
            // Update form data with signatures
            formData.apologizerSignature = sig1;
            formData.affectedPartySignature = sig2;
            formData.signatureDate = new Date().toLocaleString();
            
            // Get contract preview div
            const contractPreview = document.getElementById('contractPreviewDiv');
            if (contractPreview) {
                // Create image overlay that covers the entire contract
                const overlay = document.createElement('div');
                overlay.style.cssText = 'position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: white; display: flex; align-items: center; justify-content: center; z-index: 10;';
                overlay.innerHTML = '<img src="https://github.com/user-attachments/assets/0bdb61c2-fc8c-422a-a991-ef42454f2b1c" alt="REPAIR BOT" style="max-width: 90%; max-height: 90%; width: auto; height: auto;">';
                contractPreview.appendChild(overlay);
                
                // After 2 seconds, remove overlay and update everything
                setTimeout(() => {
                    // Remove the overlay
                    overlay.remove();
                    
                    // Update contract with signed version
                    const signedContract = generateContract();
                    contractPreview.innerHTML = '<pre style="white-space: pre-wrap;">' + signedContract + '</pre>';
                    
                    // Hide sign button and show action buttons
                    const signButton = document.getElementById('signRepairButton');
                    const actionButtons = document.getElementById('repairActionButtons');
                    if (signButton) signButton.style.display = 'none';
                    if (actionButtons) actionButtons.style.display = 'grid';
                    
                    // Disable signature inputs
                    document.getElementById('repairSignature1').disabled = true;
                    document.getElementById('repairSignature2').disabled = true;
                }, 2000);
            }
        }
        
        function viewRepairContract() {
            const contractText = generateContract();
            
            // Create modal
            const modal = document.createElement('div');
            modal.style.cssText = 'position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 2000; overflow-y: auto;';
            modal.innerHTML = `
                <div style="background: white; max-width: 900px; margin: 50px auto; padding: 40px; border-radius: 20px; position: relative;">
                    <span onclick="this.parentElement.parentElement.remove()" style="position: absolute; top: 20px; right: 20px; font-size: 2rem; cursor: pointer; color: #6b7280;">&times;</span>
                    <h2 style="margin-bottom: 20px;">Contract Preview</h2>
                    <pre style="white-space: pre-wrap; font-family: monospace; line-height: 1.6; max-height: 70vh; overflow-y: auto;">${contractText.replace(/</g, '&lt;').replace(/>/g, '&gt;')}</pre>
                </div>
            `;
            document.body.appendChild(modal);
            
            // Close on outside click
            modal.addEventListener('click', (e) => {
                if (e.target === modal) modal.remove();
            });
        }
        
        function printContract() {
            const contractText = generateContract();
            
            const printWindow = window.open('', '_blank');
            printWindow.document.write('<html><head><title>Enhanced REPAIR Protocol Contract</title></head><body>');
            printWindow.document.write('<pre style="font-family: monospace; white-space: pre-wrap; line-height: 1.6;">');
            printWindow.document.write(contractText.replace(/</g, '&lt;').replace(/>/g, '&gt;'));
            printWindow.document.write('</pre></body></html>');
            printWindow.document.close();
            printWindow.print();
        }
    </script>

    <!-- Load GPT Integration Scripts -->
    <script src="config/api-config.js"></script>
    <script src="agents/gpt-integration.js"></script>
    <script src="agents/anthropic-integration.js"></script>
    <script src="agents/repair-assistant.js"></script>

    <!-- GPT Integration JavaScript -->
    <script>
        // Global AI Integration Variables
        let gptIntegration = null;
        let anthropicIntegration = null;
        let repairAssistant = null;
        let apiConfigured = false;
        let chatSession = null;

        // Initialize GPT Integration when AI mode is enabled
        async function initializeGPTIntegration() {
            try {
                console.log('Initializing GPT Integration...');

                // Initialize API configuration if not already done
                if (!window.repairAPIConfig) {
                    window.repairAPIConfig = new APIConfig();
                }

                // Check if API is configured
                const status = window.repairAPIConfig.getStatus();
                if (!status.hasApiKey) {
                    console.warn('No API key configured - showing setup panel');
                    showAPISetupPanel();
                    return false;
                }

                // Initialize AI Integration based on provider
                const provider = window.repairAPIConfig.config.primary.provider;

                if (provider === 'anthropic' && window.AnthropicIntegration) {
                    // Initialize Anthropic Integration
                    anthropicIntegration = new AnthropicIntegration(window.repairAPIConfig);
                    await anthropicIntegration.initialize();

                    if (anthropicIntegration.isInitialized) {
                        gptIntegration = anthropicIntegration; // Use as common interface
                    }
                } else {
                    // Initialize GPT Integration
                    gptIntegration = new GPTIntegration(window.repairAPIConfig);
                    await gptIntegration.initialize();
                }

                if (gptIntegration && (gptIntegration.isInitialized || anthropicIntegration?.isInitialized)) {
                    // Initialize REPAIR Assistant
                    repairAssistant = new REPAIRAssistant(gptIntegration, window.repairAPIConfig);
                    await repairAssistant.initialize();

                    // Start coaching session
                    if (repairAssistant) {
                        chatSession = await repairAssistant.startCoachingSession(formData, currentPhase);
                        console.log('REPAIR Assistant session started:', chatSession.sessionId);
                    }

                    apiConfigured = true;
                    updateAPIStatus('success', 'GPT Integration active');
                    showChatInterface();
                    updateUsageStats();

                    return true;
                } else {
                    throw new Error('GPT Integration failed to initialize');
                }

            } catch (error) {
                console.error('Failed to initialize GPT Integration:', error);
                updateAPIStatus('error', `Failed to initialize: ${error.message}`);
                showAPISetupPanel();
                return false;
            }
        }

        // API Configuration Functions
        function openAPIConfig() {
            document.getElementById('api-config-modal').classList.add('active');
            loadAPIConfigValues();

            // Set up event listeners if config isn't loaded
            if (!window.repairAPIConfig) {
                addCodeExampleUpdateListeners();
            }
        }

        function closeAPIConfig() {
            document.getElementById('api-config-modal').classList.remove('active');
        }

        function loadAPIConfigValues() {
            if (!window.repairAPIConfig) return;

            const config = window.repairAPIConfig.config;

            // Load primary configuration
            document.getElementById('config-provider').value = config.primary.provider;

            // Update provider-specific settings first
            updateProviderSettings();

            // Then set the specific model and other values
            document.getElementById('config-model').value = config.primary.model;
            document.getElementById('config-endpoint').value = config.primary.endpoint;
            document.getElementById('config-temperature').value = config.primary.temperature;
            document.getElementById('config-max-tokens').value = config.primary.maxTokens;
            document.getElementById('config-timeout').value = config.primary.timeout;

            // Load rate limiting
            document.getElementById('config-rpm').value = config.rateLimiting.requestsPerMinute;
            document.getElementById('config-rph').value = config.rateLimiting.requestsPerHour;
            document.getElementById('config-daily-limit').value = config.usage.monthlyLimit;

            // Load features
            document.getElementById('feature-conversation-history').checked = config.features.conversationHistory;
            document.getElementById('feature-real-time-feedback').checked = config.features.realTimeFeedback;
            document.getElementById('feature-emotional-analysis').checked = config.features.emotionalAnalysis;
            document.getElementById('feature-bias-detection').checked = config.features.biasDetection;
            document.getElementById('feature-progress-tracking').checked = config.features.progressTracking;
            document.getElementById('feature-auto-save').checked = config.features.autoSave;

            // Add event listeners for real-time code example updates
            addCodeExampleUpdateListeners();
        }

        // Add event listeners to trigger code example updates
        function addCodeExampleUpdateListeners() {
            const fieldsToWatch = [
                'config-provider',
                'config-model',
                'config-endpoint',
                'config-api-key',
                'config-temperature',
                'config-max-tokens'
            ];

            fieldsToWatch.forEach(fieldId => {
                const element = document.getElementById(fieldId);
                if (element) {
                    element.addEventListener('input', () => {
                        // Only update if quickstart tab is active
                        const quickstartTab = document.getElementById('tab-quickstart');
                        if (quickstartTab && quickstartTab.classList.contains('active')) {
                            generateCodeExamples();
                        }
                    });
                }
            });
        }

        async function saveAPIConfig() {
            try {
                const config = {
                    primary: {
                        provider: document.getElementById('config-provider').value,
                        model: document.getElementById('config-model').value,
                        endpoint: document.getElementById('config-endpoint').value,
                        temperature: parseFloat(document.getElementById('config-temperature').value),
                        maxTokens: parseInt(document.getElementById('config-max-tokens').value),
                        timeout: parseInt(document.getElementById('config-timeout').value)
                    },
                    rateLimiting: {
                        requestsPerMinute: parseInt(document.getElementById('config-rpm').value),
                        requestsPerHour: parseInt(document.getElementById('config-rph').value)
                    },
                    usage: {
                        monthlyLimit: parseInt(document.getElementById('config-daily-limit').value)
                    },
                    features: {
                        conversationHistory: document.getElementById('feature-conversation-history').checked,
                        realTimeFeedback: document.getElementById('feature-real-time-feedback').checked,
                        emotionalAnalysis: document.getElementById('feature-emotional-analysis').checked,
                        biasDetection: document.getElementById('feature-bias-detection').checked,
                        progressTracking: document.getElementById('feature-progress-tracking').checked,
                        autoSave: document.getElementById('feature-auto-save').checked
                    }
                };

                const apiKey = document.getElementById('config-api-key').value;
                if (apiKey) {
                    window.repairAPIConfig.setApiKey(apiKey);
                }

                window.repairAPIConfig.updateConfig(config);

                alert('Configuration saved successfully!');
                closeAPIConfig();

                // Reinitialize if in AI mode
                if (aiMode) {
                    await initializeGPTIntegration();
                }

            } catch (error) {
                console.error('Error saving configuration:', error);
                alert('Failed to save configuration: ' + error.message);
            }
        }

        // Tab switching functionality
        function switchTab(tabName) {
            // Hide all tab contents
            const tabContents = document.querySelectorAll('.tab-content');
            tabContents.forEach(content => content.classList.remove('active'));

            // Remove active class from all tabs
            const tabs = document.querySelectorAll('.api-config-tab');
            tabs.forEach(tab => tab.classList.remove('active'));

            // Show selected tab content
            const selectedContent = document.getElementById(`tab-${tabName}`);
            if (selectedContent) {
                selectedContent.classList.add('active');
            }

            // Add active class to selected tab
            event.target.classList.add('active');

            // If switching to quickstart tab, generate code examples
            if (tabName === 'quickstart') {
                generateCodeExamples();
            }
        }

        // Generate dynamic code examples
        function generateCodeExamples() {
            const container = document.getElementById('code-examples-container');
            const provider = document.getElementById('config-provider').value;
            const model = document.getElementById('config-model').value;
            const endpoint = document.getElementById('config-endpoint').value;
            const apiKey = document.getElementById('config-api-key').value;
            const temperature = document.getElementById('config-temperature').value;
            const maxTokens = document.getElementById('config-max-tokens').value;

            // If no API key is provided, show placeholder
            if (!apiKey) {
                container.innerHTML = `
                    <div class="config-placeholder">
                        <div class="config-placeholder-icon">🔑</div>
                        <p>Enter your API key in the Configuration tab to see personalized code examples</p>
                    </div>
                `;
                return;
            }

            const examples = getCodeExamples(provider, model, endpoint, apiKey, temperature, maxTokens);

            container.innerHTML = examples.map(example => `
                <div class="code-example">
                    <div class="code-example-header">
                        <div class="code-example-title">
                            <span class="language-icon ${example.language}">${example.icon}</span>
                            ${example.title}
                        </div>
                        <button class="copy-button" onclick="copyToClipboard(this, \`${example.code.replace(/`/g, '\\`').replace(/\$/g, '\\$')}\`)">
                            📋 Copy
                        </button>
                    </div>
                    <div class="code-content">
                        <pre><code>${example.highlightedCode}</code></pre>
                    </div>
                </div>
            `).join('');
        }

        // Get code examples based on provider and settings
        function getCodeExamples(provider, model, endpoint, apiKey, temperature, maxTokens) {
            const examples = [];
            const apiKeyMasked = apiKey.substring(0, 8) + '...' + apiKey.substring(apiKey.length - 4);

            // JavaScript Example
            examples.push({
                language: 'javascript',
                icon: 'JS',
                title: 'JavaScript/Node.js',
                code: `const axios = require('axios');

async function sendRepairRequest(message) {
    try {
        const response = await axios.post('${endpoint}', {
            model: '${model}',
            messages: [
                {
                    role: 'system',
                    content: 'You are a helpful assistant for the REPAIR apology framework.'
                },
                {
                    role: 'user',
                    content: message
                }
            ],
            temperature: ${temperature},
            max_tokens: ${maxTokens}
        }, {
            headers: {
                'Authorization': 'Bearer ${apiKey}',
                'Content-Type': 'application/json'
            }
        });

        return response.data.choices[0].message.content;
    } catch (error) {
        console.error('API request failed:', error);
        throw error;
    }
}

// Usage
sendRepairRequest('Help me craft a sincere apology using the REPAIR framework')
    .then(response => console.log(response))
    .catch(error => console.error(error));`,
                highlightedCode: `<span class="keyword">const</span> axios = <span class="function">require</span>(<span class="string">'axios'</span>);

<span class="keyword">async function</span> <span class="function">sendRepairRequest</span>(message) {
    <span class="keyword">try</span> {
        <span class="keyword">const</span> response = <span class="keyword">await</span> axios.<span class="function">post</span>(<span class="string">'${endpoint}'</span>, {
            <span class="variable">model</span>: <span class="string">'${model}'</span>,
            <span class="variable">messages</span>: [
                {
                    <span class="variable">role</span>: <span class="string">'system'</span>,
                    <span class="variable">content</span>: <span class="string">'You are a helpful assistant for the REPAIR apology framework.'</span>
                },
                {
                    <span class="variable">role</span>: <span class="string">'user'</span>,
                    <span class="variable">content</span>: message
                }
            ],
            <span class="variable">temperature</span>: <span class="number">${temperature}</span>,
            <span class="variable">max_tokens</span>: <span class="number">${maxTokens}</span>
        }, {
            <span class="variable">headers</span>: {
                <span class="string">'Authorization'</span>: <span class="string">'Bearer ${apiKeyMasked}'</span>,
                <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
            }
        });

        <span class="keyword">return</span> response.data.choices[<span class="number">0</span>].message.content;
    } <span class="keyword">catch</span> (error) {
        console.<span class="function">error</span>(<span class="string">'API request failed:'</span>, error);
        <span class="keyword">throw</span> error;
    }
}

<span class="comment">// Usage</span>
<span class="function">sendRepairRequest</span>(<span class="string">'Help me craft a sincere apology using the REPAIR framework'</span>)
    .<span class="function">then</span>(response => console.<span class="function">log</span>(response))
    .<span class="function">catch</span>(error => console.<span class="function">error</span>(error));`
            });

            // Python Example
            examples.push({
                language: 'python',
                icon: 'PY',
                title: 'Python',
                code: `import requests
import json

def send_repair_request(message):
    url = "${endpoint}"
    headers = {
        "Authorization": "Bearer ${apiKey}",
        "Content-Type": "application/json"
    }

    data = {
        "model": "${model}",
        "messages": [
            {
                "role": "system",
                "content": "You are a helpful assistant for the REPAIR apology framework."
            },
            {
                "role": "user",
                "content": message
            }
        ],
        "temperature": ${temperature},
        "max_tokens": ${maxTokens}
    }

    try:
        response = requests.post(url, headers=headers, json=data)
        response.raise_for_status()
        return response.json()["choices"][0]["message"]["content"]
    except requests.exceptions.RequestException as e:
        print(f"API request failed: {e}")
        raise

# Usage
try:
    result = send_repair_request("Help me craft a sincere apology using the REPAIR framework")
    print(result)
except Exception as e:
    print(f"Error: {e}")`,
                highlightedCode: `<span class="keyword">import</span> requests
<span class="keyword">import</span> json

<span class="keyword">def</span> <span class="function">send_repair_request</span>(message):
    url = <span class="string">"${endpoint}"</span>
    headers = {
        <span class="string">"Authorization"</span>: <span class="string">"Bearer ${apiKeyMasked}"</span>,
        <span class="string">"Content-Type"</span>: <span class="string">"application/json"</span>
    }

    data = {
        <span class="string">"model"</span>: <span class="string">"${model}"</span>,
        <span class="string">"messages"</span>: [
            {
                <span class="string">"role"</span>: <span class="string">"system"</span>,
                <span class="string">"content"</span>: <span class="string">"You are a helpful assistant for the REPAIR apology framework."</span>
            },
            {
                <span class="string">"role"</span>: <span class="string">"user"</span>,
                <span class="string">"content"</span>: message
            }
        ],
        <span class="string">"temperature"</span>: <span class="number">${temperature}</span>,
        <span class="string">"max_tokens"</span>: <span class="number">${maxTokens}</span>
    }

    <span class="keyword">try</span>:
        response = requests.<span class="function">post</span>(url, headers=headers, json=data)
        response.<span class="function">raise_for_status</span>()
        <span class="keyword">return</span> response.<span class="function">json</span>()[<span class="string">"choices"</span>][<span class="number">0</span>][<span class="string">"message"</span>][<span class="string">"content"</span>]
    <span class="keyword">except</span> requests.exceptions.RequestException <span class="keyword">as</span> e:
        <span class="function">print</span>(<span class="string">f"API request failed: {e}"</span>)
        <span class="keyword">raise</span>

<span class="comment"># Usage</span>
<span class="keyword">try</span>:
    result = <span class="function">send_repair_request</span>(<span class="string">"Help me craft a sincere apology using the REPAIR framework"</span>)
    <span class="function">print</span>(result)
<span class="keyword">except</span> Exception <span class="keyword">as</span> e:
    <span class="function">print</span>(<span class="string">f"Error: {e}"</span>)`
            });

            // cURL Example
            examples.push({
                language: 'curl',
                icon: '💻',
                title: 'cURL',
                code: `curl -X POST "${endpoint}" \\
  -H "Authorization: Bearer ${apiKey}" \\
  -H "Content-Type: application/json" \\
  -d '{
    "model": "${model}",
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful assistant for the REPAIR apology framework."
      },
      {
        "role": "user",
        "content": "Help me craft a sincere apology using the REPAIR framework"
      }
    ],
    "temperature": ${temperature},
    "max_tokens": ${maxTokens}
  }'`,
                highlightedCode: `<span class="function">curl</span> <span class="operator">-X</span> <span class="keyword">POST</span> <span class="string">"${endpoint}"</span> <span class="operator">\\</span>
  <span class="operator">-H</span> <span class="string">"Authorization: Bearer ${apiKeyMasked}"</span> <span class="operator">\\</span>
  <span class="operator">-H</span> <span class="string">"Content-Type: application/json"</span> <span class="operator">\\</span>
  <span class="operator">-d</span> <span class="string">'{
    "model": "${model}",
    "messages": [
      {
        "role": "system",
        "content": "You are a helpful assistant for the REPAIR apology framework."
      },
      {
        "role": "user",
        "content": "Help me craft a sincere apology using the REPAIR framework"
      }
    ],
    "temperature": ${temperature},
    "max_tokens": ${maxTokens}
  }'</span>`
            });

            // TypeScript Example
            examples.push({
                language: 'typescript',
                icon: 'TS',
                title: 'TypeScript',
                code: `interface RepairAPIResponse {
    choices: Array<{
        message: {
            content: string;
            role: string;
        };
    }>;
}

interface RepairAPIRequest {
    model: string;
    messages: Array<{
        role: 'system' | 'user' | 'assistant';
        content: string;
    }>;
    temperature: number;
    max_tokens: number;
}

async function sendRepairRequest(message: string): Promise<string> {
    const requestData: RepairAPIRequest = {
        model: '${model}',
        messages: [
            {
                role: 'system',
                content: 'You are a helpful assistant for the REPAIR apology framework.'
            },
            {
                role: 'user',
                content: message
            }
        ],
        temperature: ${temperature},
        max_tokens: ${maxTokens}
    };

    try {
        const response = await fetch('${endpoint}', {
            method: 'POST',
            headers: {
                'Authorization': 'Bearer ${apiKey}',
                'Content-Type': 'application/json'
            },
            body: JSON.stringify(requestData)
        });

        if (!response.ok) {
            throw new Error(\`HTTP error! status: \${response.status}\`);
        }

        const data: RepairAPIResponse = await response.json();
        return data.choices[0].message.content;
    } catch (error) {
        console.error('API request failed:', error);
        throw error;
    }
}

// Usage
sendRepairRequest('Help me craft a sincere apology using the REPAIR framework')
    .then(response => console.log(response))
    .catch(error => console.error(error));`,
                highlightedCode: `<span class="keyword">interface</span> <span class="variable">RepairAPIResponse</span> {
    choices: <span class="keyword">Array</span>&lt;{
        message: {
            content: <span class="keyword">string</span>;
            role: <span class="keyword">string</span>;
        };
    }&gt;;
}

<span class="keyword">interface</span> <span class="variable">RepairAPIRequest</span> {
    model: <span class="keyword">string</span>;
    messages: <span class="keyword">Array</span>&lt;{
        role: <span class="string">'system'</span> | <span class="string">'user'</span> | <span class="string">'assistant'</span>;
        content: <span class="keyword">string</span>;
    }&gt;;
    temperature: <span class="keyword">number</span>;
    max_tokens: <span class="keyword">number</span>;
}

<span class="keyword">async function</span> <span class="function">sendRepairRequest</span>(message: <span class="keyword">string</span>): <span class="keyword">Promise</span>&lt;<span class="keyword">string</span>&gt; {
    <span class="keyword">const</span> requestData: <span class="variable">RepairAPIRequest</span> = {
        <span class="variable">model</span>: <span class="string">'${model}'</span>,
        <span class="variable">messages</span>: [
            {
                <span class="variable">role</span>: <span class="string">'system'</span>,
                <span class="variable">content</span>: <span class="string">'You are a helpful assistant for the REPAIR apology framework.'</span>
            },
            {
                <span class="variable">role</span>: <span class="string">'user'</span>,
                <span class="variable">content</span>: message
            }
        ],
        <span class="variable">temperature</span>: <span class="number">${temperature}</span>,
        <span class="variable">max_tokens</span>: <span class="number">${maxTokens}</span>
    };

    <span class="keyword">try</span> {
        <span class="keyword">const</span> response = <span class="keyword">await</span> <span class="function">fetch</span>(<span class="string">'${endpoint}'</span>, {
            <span class="variable">method</span>: <span class="string">'POST'</span>,
            <span class="variable">headers</span>: {
                <span class="string">'Authorization'</span>: <span class="string">'Bearer ${apiKeyMasked}'</span>,
                <span class="string">'Content-Type'</span>: <span class="string">'application/json'</span>
            },
            <span class="variable">body</span>: JSON.<span class="function">stringify</span>(requestData)
        });

        <span class="keyword">if</span> (!response.ok) {
            <span class="keyword">throw new</span> <span class="function">Error</span>(\`HTTP error! status: \${response.status}\`);
        }

        <span class="keyword">const</span> data: <span class="variable">RepairAPIResponse</span> = <span class="keyword">await</span> response.<span class="function">json</span>();
        <span class="keyword">return</span> data.choices[<span class="number">0</span>].message.content;
    } <span class="keyword">catch</span> (error) {
        console.<span class="function">error</span>(<span class="string">'API request failed:'</span>, error);
        <span class="keyword">throw</span> error;
    }
}

<span class="comment">// Usage</span>
<span class="function">sendRepairRequest</span>(<span class="string">'Help me craft a sincere apology using the REPAIR framework'</span>)
    .<span class="function">then</span>(response => console.<span class="function">log</span>(response))
    .<span class="function">catch</span>(error => console.<span class="function">error</span>(error));`
            });

            return examples;
        }

        // Copy to clipboard functionality
        async function copyToClipboard(button, text) {
            try {
                await navigator.clipboard.writeText(text);

                // Update button appearance
                const originalContent = button.innerHTML;
                button.innerHTML = '✅ Copied!';
                button.classList.add('copied');

                // Reset button after 2 seconds
                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('copied');
                }, 2000);
            } catch (err) {
                console.error('Failed to copy text: ', err);

                // Fallback for older browsers
                const textArea = document.createElement('textarea');
                textArea.value = text;
                document.body.appendChild(textArea);
                textArea.select();
                document.execCommand('copy');
                document.body.removeChild(textArea);

                // Update button appearance
                const originalContent = button.innerHTML;
                button.innerHTML = '✅ Copied!';
                button.classList.add('copied');

                setTimeout(() => {
                    button.innerHTML = originalContent;
                    button.classList.remove('copied');
                }, 2000);
            }
        }

        async function testAPIConnection() {
            try {
                updateAPIStatus('warning', 'Testing connection...');

                if (!window.repairAPIConfig) {
                    throw new Error('API configuration not initialized');
                }

                const result = await window.repairAPIConfig.testConnection();

                if (result.success) {
                    updateAPIStatus('success', `Connection successful (${result.latency}ms)`);
                } else {
                    updateAPIStatus('error', `Connection failed: ${result.error}`);
                }

            } catch (error) {
                console.error('Connection test error:', error);
                updateAPIStatus('error', `Test failed: ${error.message}`);
            }
        }

        function updateProviderSettings() {
            const provider = document.getElementById('config-provider').value;
            const modelSelect = document.getElementById('config-model');
            const endpointInput = document.getElementById('config-endpoint');

            // Clear existing model options
            modelSelect.innerHTML = '';

            // Update models and endpoints based on provider
            if (provider === 'openai') {
                const openAIModels = [
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-4-turbo', text: 'GPT-4 Turbo' },
                    { value: 'gpt-3.5-turbo', text: 'GPT-3.5 Turbo' },
                    { value: 'gpt-4o', text: 'GPT-4o' }
                ];
                openAIModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
                endpointInput.value = 'https://api.openai.com/v1/chat/completions';
                endpointInput.placeholder = 'https://api.openai.com/v1/chat/completions';

            } else if (provider === 'anthropic') {
                const anthropicModels = [
                    { value: 'claude-opus-4-1-20250805', text: 'Claude Opus 4.1' },
                    { value: 'claude-sonnet-4-20250514', text: 'Claude Sonnet 4' },
                    { value: 'claude-3-5-sonnet-20241022', text: 'Claude 3.5 Sonnet' },
                    { value: 'claude-3-5-haiku-20241022', text: 'Claude 3.5 Haiku' }
                ];
                anthropicModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
                endpointInput.value = 'https://api.anthropic.com/v1/messages';
                endpointInput.placeholder = 'https://api.anthropic.com/v1/messages';

            } else if (provider === 'azure') {
                const azureModels = [
                    { value: 'gpt-4', text: 'GPT-4' },
                    { value: 'gpt-35-turbo', text: 'GPT-3.5 Turbo' }
                ];
                azureModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
                endpointInput.value = '';
                endpointInput.placeholder = 'https://your-resource.openai.azure.com/openai/deployments/your-deployment/chat/completions?api-version=2023-12-01-preview';

            } else if (provider === 'custom') {
                const customModels = [
                    { value: 'custom-model', text: 'Custom Model' }
                ];
                customModels.forEach(model => {
                    const option = document.createElement('option');
                    option.value = model.value;
                    option.textContent = model.text;
                    modelSelect.appendChild(option);
                });
                endpointInput.value = '';
                endpointInput.placeholder = 'https://your-custom-endpoint.com/v1/chat/completions';
            }

            // Update API key placeholder based on provider
            const apiKeyInput = document.getElementById('config-api-key');
            if (provider === 'openai') {
                apiKeyInput.placeholder = 'sk-...';
            } else if (provider === 'anthropic') {
                apiKeyInput.placeholder = 'sk-ant-...';
            } else if (provider === 'azure') {
                apiKeyInput.placeholder = 'Azure API Key';
            } else {
                apiKeyInput.placeholder = 'API Key';
            }

            // Apply provider-specific configuration if available
            if (window.repairAPIConfig && provider !== 'custom') {
                window.repairAPIConfig.setProvider(provider);
            }

            // Update code examples if quickstart tab is active
            const quickstartTab = document.getElementById('tab-quickstart');
            if (quickstartTab && quickstartTab.classList.contains('active')) {
                generateCodeExamples();
            }
        }

        function resetAPIConfig() {
            if (confirm('Are you sure you want to reset all settings to defaults?')) {
                window.repairAPIConfig.resetToDefaults();
                loadAPIConfigValues();
                alert('Configuration reset to defaults');
            }
        }

        // Quick API Setup Functions
        function openAPIExamples() {
            // Navigate to API examples page in same window instead of new tab
            const currentProvider = window.repairAPIConfig?.config?.primary?.provider || 'openai';
            const currentModel = window.repairAPIConfig?.config?.primary?.model || 'gpt-4';

            // Build URL with current configuration
            let url = 'api-quickstart.html';
            const params = new URLSearchParams();

            if (currentProvider === 'anthropic') {
                params.set('provider', 'anthropic');
                params.set('model', currentModel);
            } else if (currentProvider === 'openai') {
                params.set('provider', 'openai');
                params.set('model', currentModel);
            }

            // Add return URL parameter for seamless back navigation
            params.set('return', window.location.pathname + window.location.search);

            if (params.toString()) {
                url += '?' + params.toString();
            }

            // Add smooth transition effect with subtle loading indication
            const button = event.target;
            const originalText = button.textContent;
            button.textContent = 'Loading...';
            button.disabled = true;
            
            document.body.style.opacity = '0.7';
            document.body.style.transition = 'opacity 0.3s ease';
            
            // Navigate in same window for seamless experience
            setTimeout(() => {
                window.location.href = url;
            }, 300);
        }

        async function saveQuickAPIKey() {
            const apiKey = document.getElementById('quick-api-key').value;
            if (!apiKey) {
                alert('Please enter an API key');
                return;
            }

            try {
                if (!window.repairAPIConfig) {
                    window.repairAPIConfig = new APIConfig();
                }

                window.repairAPIConfig.setApiKey(apiKey);
                updateAPIStatus('success', 'API key saved');

                // Auto-initialize if in AI mode
                if (aiMode) {
                    await initializeGPTIntegration();
                }

            } catch (error) {
                console.error('Error saving API key:', error);
                updateAPIStatus('error', 'Failed to save API key');
            }
        }

        async function testConnection() {
            try {
                updateAPIStatus('warning', 'Testing...');
                const result = await window.repairAPIConfig.testConnection();

                if (result.success) {
                    updateAPIStatus('success', 'Connected');
                    if (aiMode && !apiConfigured) {
                        await initializeGPTIntegration();
                    }
                } else {
                    updateAPIStatus('error', 'Connection failed');
                }
            } catch (error) {
                updateAPIStatus('error', 'Test failed');
            }
        }

        // Chat Interface Functions
        async function sendChatMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();

            if (!message || !repairAssistant) return;

            // Add user message to chat
            addChatMessage(message, 'user');
            input.value = '';

            // Show typing indicator
            showTypingIndicator(true);

            try {
                // Get response from assistant
                const response = await repairAssistant.chat(message, {
                    currentPhase: currentPhase,
                    formData: formData
                });

                // Hide typing indicator
                showTypingIndicator(false);

                // Add assistant response
                addChatMessage(response.content, 'assistant');

                // Update insights if available
                if (response.insights && response.insights.length > 0) {
                    updateContextualInsights(response.insights);
                }

                // Update progress if available
                if (response.progressUpdate) {
                    updateProgressDisplay(response.progressUpdate);
                }

                // Update conversation history
                updateConversationHistory();

            } catch (error) {
                showTypingIndicator(false);
                addChatMessage('Sorry, I encountered an error. Please try again.', 'assistant');
                console.error('Chat error:', error);
            }
        }

        function addChatMessage(content, sender) {
            const messagesContainer = document.getElementById('chat-messages');
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${sender}`;

            const avatar = document.createElement('div');
            avatar.className = `chat-avatar ${sender}`;
            avatar.textContent = sender === 'user' ? '👤' : '🤖';

            const bubble = document.createElement('div');
            bubble.className = `chat-bubble ${sender}`;
            bubble.textContent = content;

            messageDiv.appendChild(avatar);
            messageDiv.appendChild(bubble);
            messagesContainer.appendChild(messageDiv);

            // Scroll to bottom
            messagesContainer.scrollTop = messagesContainer.scrollHeight;
        }

        function showTypingIndicator(show) {
            const indicator = document.getElementById('chat-typing');
            indicator.classList.toggle('active', show);
        }

        function toggleChat() {
            const chatInterface = document.getElementById('chat-interface');
            const isMinimized = chatInterface.style.height === '60px';

            if (isMinimized) {
                chatInterface.style.height = 'auto';
                document.querySelector('.chat-minimize').textContent = '−';
            } else {
                chatInterface.style.height = '60px';
                document.querySelector('.chat-minimize').textContent = '+';
            }
        }

        function clearChatHistory() {
            if (confirm('Clear chat history?')) {
                const messagesContainer = document.getElementById('chat-messages');
                messagesContainer.innerHTML = `
                    <div class="chat-message">
                        <div class="chat-avatar assistant">🤖</div>
                        <div class="chat-bubble assistant">
                            Chat history cleared. How can I help you with the REPAIR Protocol?
                        </div>
                    </div>
                `;

                if (repairAssistant) {
                    repairAssistant.clearHistory();
                }
            }
        }

        // UI Update Functions
        function updateAPIStatus(status, message) {
            const indicator = document.getElementById('api-status-indicator');
            const text = document.getElementById('api-status-text');

            indicator.className = `status-indicator ${status}`;

            // Add provider information to the message
            const provider = window.repairAPIConfig?.config?.primary?.provider;
            let providerText = '';
            if (provider === 'anthropic') {
                providerText = ' (Claude)';
            } else if (provider === 'openai') {
                providerText = ' (OpenAI)';
            } else if (provider === 'azure') {
                providerText = ' (Azure)';
            }

            text.textContent = message + providerText;

            // Also update connection status in modal if open
            const connectionIndicator = document.getElementById('connection-indicator');
            const connectionText = document.getElementById('connection-text');
            if (connectionIndicator && connectionText) {
                connectionIndicator.className = `status-indicator ${status}`;
                connectionText.textContent = message;
            }
        }

        function showAPISetupPanel() {
            const panel = document.getElementById('ai-config-panel');
            panel.classList.add('active');
        }

        function hideAPISetupPanel() {
            const panel = document.getElementById('ai-config-panel');
            panel.classList.remove('active');
        }

        function showChatInterface() {
            const chatInterface = document.getElementById('chat-interface');
            chatInterface.classList.add('active');
        }

        function updateUsageStats() {
            if (!window.repairAPIConfig) return;

            const stats = window.repairAPIConfig.getUsageStats();

            document.getElementById('requests-today').textContent = stats.requestsToday;
            document.getElementById('tokens-used').textContent = stats.tokensUsed;
            document.getElementById('success-rate').textContent = Math.round(stats.percentageUsed) + '%';

            document.getElementById('usage-stats').style.display = 'grid';
        }

        function updateContextualInsights(insights) {
            const container = document.getElementById('contextual-insights');
            const list = document.getElementById('insight-list');

            list.innerHTML = '';

            insights.forEach(insight => {
                const item = document.createElement('div');
                item.className = 'insight-item-ai';
                item.textContent = typeof insight === 'string' ? insight : insight.message;
                list.appendChild(item);
            });

            container.style.display = 'block';
        }

        function updateConversationHistory() {
            const container = document.getElementById('conversation-history');
            const list = document.getElementById('history-list');

            if (repairAssistant && repairAssistant.getRecentInteractions) {
                const recent = repairAssistant.getRecentInteractions(5);

                list.innerHTML = '';

                recent.forEach(interaction => {
                    const item = document.createElement('div');
                    item.className = 'history-item';
                    item.innerHTML = `
                        <div><strong>${interaction.role}:</strong> ${interaction.content.substring(0, 50)}...</div>
                        <div class="history-timestamp">${new Date(interaction.timestamp).toLocaleTimeString()}</div>
                    `;
                    list.appendChild(item);
                });

                container.style.display = 'block';
            }
        }

        // Enhanced AI Mode Toggle
        async function toggleAIModeEnhanced(enable) {
            aiMode = enable;

            // Update toggle UI
            document.getElementById('standard-toggle').classList.toggle('active', !enable);
            document.getElementById('ai-toggle').classList.toggle('active', enable);

            // Update main content layout
            const mainContent = document.getElementById('main-content');
            mainContent.classList.toggle('ai-mode', enable);

            // Show/hide agent panel
            const agentPanel = document.getElementById('agent-panel');
            agentPanel.classList.toggle('active', enable);

            // Update description
            const description = document.getElementById('mode-description');
            if (enable) {
                description.textContent = 'AI-enhanced version with real-time GPT analysis, intelligent feedback, and personalized coaching.';

                // Initialize GPT integration
                await initializeGPTIntegration();
            } else {
                description.textContent = 'Experience the foundational REPAIR Protocol with comprehensive 8-phase workflow.';

                // Clean up GPT integration
                if (repairAssistant) {
                    repairAssistant.endSession();
                }
                hideAPISetupPanel();
                document.getElementById('chat-interface').classList.remove('active');
                document.getElementById('contextual-insights').style.display = 'none';
                document.getElementById('conversation-history').style.display = 'none';
            }
        }

        // Enhanced Form Data Handling with GPT Integration
        async function updateFormDataEnhanced(field, value) {
            formData[field] = value;

            // Trigger GPT analysis if configured
            if (aiMode && gptIntegration && apiConfigured) {
                try {
                    // Provide real-time feedback
                    const feedback = await gptIntegration.provideFeedback(field, value, currentPhase);
                    if (feedback) {
                        showRealtimeFeedback(field, feedback);
                    }

                    // Update emotional analysis
                    if (window.repairAPIConfig.isFeatureEnabled('emotionalAnalysis')) {
                        const emotional = await gptIntegration.analyzeEmotionalIntelligence(value, currentPhase);
                        updateEmotionalGauges(emotional);
                    }

                    // Detect bias
                    if (window.repairAPIConfig.isFeatureEnabled('biasDetection')) {
                        const biasCheck = await gptIntegration.detectBias(value, field);
                        if (biasCheck.biasLevel !== 'none') {
                            showBiasWarning(field, biasCheck);
                        }
                    }

                } catch (error) {
                    console.error('Error in GPT analysis:', error);
                }
            }
        }

        function showRealtimeFeedback(field, feedback) {
            // Find the input element
            const input = document.querySelector(`[name="${field}"]`);
            if (!input) return;

            // Remove existing feedback
            const existing = input.parentNode.querySelector('.realtime-feedback');
            if (existing) existing.remove();

            // Add new feedback
            const feedbackDiv = document.createElement('div');
            feedbackDiv.className = 'realtime-feedback active';
            feedbackDiv.innerHTML = `
                <span class="feedback-score ${feedback.quality}">${feedback.quality}</span>
                <span>${feedback.feedback}</span>
            `;

            input.parentNode.appendChild(feedbackDiv);

            // Auto-hide after 5 seconds
            setTimeout(() => {
                feedbackDiv.classList.remove('active');
                setTimeout(() => feedbackDiv.remove(), 300);
            }, 5000);
        }

        function updateEmotionalGauges(emotional) {
            if (emotional.empathy !== undefined) {
                updateGauge('empathy', emotional.empathy);
            }
            if (emotional.sincerity !== undefined) {
                updateGauge('sincerity', emotional.sincerity);
            }
            if (emotional.completeness !== undefined) {
                updateGauge('completeness', emotional.completeness);
            }
        }

        function updateGauge(type, value) {
            const gauge = document.getElementById(`${type}-gauge`);
            const score = document.getElementById(`${type}-score`);
            if (gauge && score) {
                gauge.style.width = `${value * 100}%`;
                score.textContent = `${Math.round(value * 100)}%`;
            }
        }

        function showBiasWarning(field, biasCheck) {
            // Implementation for showing bias warnings
            console.log('Bias detected in', field, ':', biasCheck);
        }

        // Override the original toggle function
        window.toggleAIMode = toggleAIModeEnhanced;
        window.updateFormData = updateFormDataEnhanced;

        // Chat input event handling
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendChatMessage();
                    }
                });

                // Auto-resize textarea
                chatInput.addEventListener('input', function() {
                    this.style.height = 'auto';
                    this.style.height = Math.min(this.scrollHeight, 120) + 'px';
                });
            }
        });

        // Initialize on page load
        document.addEventListener('DOMContentLoaded', function() {
            // Initialize theme first
            initializeTheme();
            
            // Check URL parameters for AI mode
            const urlParams = new URLSearchParams(window.location.search);
            const mode = urlParams.get('mode');
            if (mode === 'ai') {
                toggleAIModeEnhanced(true);
            }
        });

        // Theme management functions
        function toggleTheme() {
            const currentTheme = document.documentElement.getAttribute('data-theme');
            const newTheme = currentTheme === 'dark' ? 'light' : 'dark';

            document.documentElement.setAttribute('data-theme', newTheme);

            // Update theme toggle button
            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            if (newTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }

            // Store preference
            localStorage.setItem('theme', newTheme);
        }

        // Initialize theme
        function initializeTheme() {
            const savedTheme = localStorage.getItem('theme') || 'light';
            document.documentElement.setAttribute('data-theme', savedTheme);

            const themeIcon = document.getElementById('theme-icon');
            const themeText = document.getElementById('theme-text');

            if (savedTheme === 'dark') {
                themeIcon.textContent = '☀️';
                themeText.textContent = 'Light Mode';
            } else {
                themeIcon.textContent = '🌙';
                themeText.textContent = 'Dark Mode';
            }
        }
    </script>

    <!-- AI Integrator Script (conditionally loaded) -->
    <script>
        // Conditionally load AI integrator script
        if (new URLSearchParams(window.location.search).get('mode') === 'ai') {
            const script = document.createElement('script');
            script.src = 'agents/repair-integrator.js';
            script.onload = function() {
                if (aiMode && window.RepairIntegrator) {
                    window.RepairIntegrator.initialize();
                }
            };
            document.head.appendChild(script);
        }
    </script>
</body>
</html>
