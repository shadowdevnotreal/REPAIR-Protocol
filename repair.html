<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Enhanced REPAIR Protocol - Digital Platform</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/feather-icons/4.29.0/feather.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6;
            color: #1f2937;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        .header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-bottom: 1px solid rgba(255, 255, 255, 0.2);
            padding: 2rem 0;
            text-align: center;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
        }

        .header h1 {
            font-size: 3rem;
            font-weight: 800;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 0.5rem;
        }

        .header p {
            font-size: 1.2rem;
            color: #6b7280;
            font-weight: 500;
        }

        .main-content {
            padding: 2rem 0;
        }

        .progress-stepper {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 2rem;
            margin-bottom: 2rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            overflow-x: auto;
        }

        .stepper-container {
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-width: 800px;
            gap: 1rem;
        }

        .step {
            display: flex;
            align-items: center;
            flex-direction: column;
            text-align: center;
            min-width: 100px;
        }

        .step-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 0.5rem;
            transition: all 0.3s ease;
            cursor: pointer;
            border: 3px solid transparent;
        }

        .step-circle.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            transform: scale(1.1);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .step-circle.completed {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .step-circle.inactive {
            background: #f3f4f6;
            color: #9ca3af;
            border: 3px solid #e5e7eb;
        }

        .step-label {
            font-size: 0.9rem;
            font-weight: 600;
            color: #374151;
        }

        .step-connector {
            flex: 1;
            height: 3px;
            background: #e5e7eb;
            margin: 0 1rem;
            border-radius: 2px;
            position: relative;
            top: -15px;
        }

        .step-connector.completed {
            background: linear-gradient(90deg, #10b981 0%, #059669 100%);
        }

        .content-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 3rem;
            box-shadow: 0 8px 32px rgba(31, 38, 135, 0.37);
            margin-bottom: 2rem;
        }

        .phase-title {
            font-size: 2rem;
            font-weight: 700;
            color: #1f2937;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .phase-subtitle {
            font-size: 1.1rem;
            color: #6b7280;
            margin-bottom: 2rem;
            line-height: 1.5;
        }

        .form-group {
            margin-bottom: 2rem;
        }

        .form-label {
            display: block;
            font-size: 1rem;
            font-weight: 600;
            color: #374151;
            margin-bottom: 0.5rem;
        }

        .form-input, .form-textarea, .form-select {
            width: 100%;
            padding: 1rem;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: rgba(255, 255, 255, 0.8);
        }

        .form-input:focus, .form-textarea:focus, .form-select:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
            background: white;
        }

        .form-textarea {
            min-height: 120px;
            resize: vertical;
        }

        .enhancement-box {
            background: linear-gradient(135deg, #ddd6fe 0%, #c4b5fd 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .enhancement-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #581c87;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .enhancement-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(300px, 1fr));
            gap: 1rem;
        }

        .enhancement-item {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.1);
        }

        .bias-checklist {
            background: linear-gradient(135deg, #fed7aa 0%, #fdba74 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(251, 146, 60, 0.2);
        }

        .bias-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #9a3412;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .bias-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .bias-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(5px);
        }

        .bias-checkbox {
            width: 20px;
            height: 20px;
            border-radius: 4px;
            border: 2px solid #f97316;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .bias-checkbox:checked {
            background: #f97316;
            border-color: #f97316;
        }

        .apology-structure {
            background: linear-gradient(135deg, #bbf7d0 0%, #86efac 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-bottom: 2rem;
            border: 1px solid rgba(34, 197, 94, 0.2);
        }

        .structure-title {
            font-size: 1.2rem;
            font-weight: 700;
            color: #166534;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .structure-list {
            list-style: none;
        }

        .structure-item {
            padding: 0.75rem;
            margin-bottom: 0.5rem;
            background: rgba(255, 255, 255, 0.7);
            border-radius: 8px;
            border-left: 4px solid #22c55e;
        }

        .navigation {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-top: 2rem;
            border-top: 2px solid #e5e7eb;
            margin-top: 2rem;
        }

        .btn {
            padding: 1rem 2rem;
            border: none;
            border-radius: 12px;
            font-size: 1rem;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            text-decoration: none;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.4);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #6b7280;
            border: 2px solid #e5e7eb;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
            color: #374151;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none !important;
        }

        .contract-preview {
            background: #f9fafb;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            padding: 2rem;
            margin: 2rem 0;
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Ubuntu Mono', monospace;
            font-size: 0.9rem;
            line-height: 1.5;
            white-space: pre-line;
            position: relative;
        }

        .action-buttons {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .btn-download { background: linear-gradient(135deg, #3b82f6 0%, #1d4ed8 100%); color: white; }
        .btn-copy { background: linear-gradient(135deg, #6b7280 0%, #374151 100%); color: white; }
        .btn-copy.success { background: linear-gradient(135deg, #10b981 0%, #059669 100%); }
        .btn-view { background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%); color: white; }
        .btn-print { background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white; }

        .signature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 2rem;
            margin: 2rem 0;
        }

        .signature-section {
            background: #f8fafc;
            padding: 1.5rem;
            border-radius: 12px;
            border: 2px solid #e2e8f0;
        }

        .status-indicator {
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .status-success {
            background: #dcfce7;
            color: #166534;
            border: 1px solid #bbf7d0;
        }

        .progress-dashboard {
            background: linear-gradient(135deg, #f3e8ff 0%, #e9d5ff 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(139, 92, 246, 0.2);
        }

        .dashboard-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #581c87;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .metrics-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 1.5rem;
            margin-bottom: 2rem;
        }

        .metric-card {
            background: rgba(255, 255, 255, 0.8);
            padding: 1.5rem;
            border-radius: 12px;
            border: 1px solid rgba(139, 92, 246, 0.1);
            text-align: center;
        }

        .metric-title {
            font-size: 0.9rem;
            font-weight: 600;
            color: #581c87;
            margin-bottom: 0.5rem;
        }

        .metric-value {
            font-size: 2rem;
            font-weight: 800;
            color: #8b5cf6;
            margin-bottom: 0.5rem;
        }

        .progress-bar {
            width: 100%;
            height: 8px;
            background: #e9d5ff;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 0.5rem;
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #8b5cf6 0%, #7c3aed 100%);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            backdrop-filter: blur(5px);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 2rem;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            max-width: 800px;
            width: 100%;
            max-height: 80vh;
            overflow: hidden;
            box-shadow: 0 25px 50px rgba(0, 0, 0, 0.25);
        }

        .modal-header {
            padding: 2rem 2rem 1rem;
            border-bottom: 1px solid #e5e7eb;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .modal-body {
            padding: 2rem;
            overflow-y: auto;
            max-height: 60vh;
        }

        .modal-footer {
            padding: 1rem 2rem 2rem;
            border-top: 1px solid #e5e7eb;
            display: flex;
            justify-content: flex-end;
            gap: 1rem;
        }

        .close-btn {
            background: none;
            border: none;
            font-size: 1.5rem;
            cursor: pointer;
            color: #6b7280;
            padding: 0.5rem;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: #f3f4f6;
            color: #374151;
        }

        .ai-integration {
            background: linear-gradient(135deg, #bfdbfe 0%, #93c5fd 100%);
            border-radius: 16px;
            padding: 2rem;
            margin-top: 2rem;
            border: 1px solid rgba(59, 130, 246, 0.2);
            text-align: center;
        }

        .ai-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 1rem;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
        }

        .ai-description {
            color: #1e40af;
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .ai-features {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1.5rem 0;
        }

        .ai-feature {
            background: rgba(255, 255, 255, 0.7);
            padding: 1rem;
            border-radius: 8px;
            font-size: 0.9rem;
            color: #1e40af;
        }

        .ai-link-highlight {
            animation: pulse 1.5s infinite;
        }

        @keyframes pulse {
            0% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0.5);
            }
            70% {
                box-shadow: 0 0 0 10px rgba(59, 130, 246, 0);
            }
            100% {
                box-shadow: 0 0 0 0 rgba(59, 130, 246, 0);
            }
        }

        .helper-text {
            font-size: 0.85rem;
            color: #6b7280;
            margin-top: 1rem;
            padding: 0.75rem;
            background: #f9fafb;
            border-radius: 8px;
            border-left: 4px solid #3b82f6;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 2rem;
            }
            
            .content-card {
                padding: 2rem;
            }
            
            .stepper-container {
                min-width: 600px;
            }
            
            .step {
                min-width: 80px;
            }
            
            .step-circle {
                width: 50px;
                height: 50px;
                font-size: 1rem;
            }
            
            .action-buttons {
                grid-template-columns: 1fr;
            }
        }

        .fade-in {
            animation: fadeIn 0.5s ease-in;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .slide-in {
            animation: slideIn 0.3s ease-out;
        }

        @keyframes slideIn {
            from { transform: translateX(-100%); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Heart Animation Overlay */
        .heart-animation-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 12px;
            pointer-events: none;
            opacity: 0;
        }

        .heart-animation-overlay.show {
            animation: overlayShow 0.5s ease-in forwards;
        }

        @keyframes overlayShow {
            to { opacity: 1; }
        }

        .heart-container {
            position: relative;
            width: 120px;
            height: 120px;
            margin-bottom: 2rem;
        }

        .heart-left, .heart-right {
            position: absolute;
            width: 60px;
            height: 80px;
            background: #ef4444;
            border-radius: 60px 60px 0 0;
            transform: rotate(-45deg);
            transform-origin: 0 100%;
            opacity: 0;
        }

        .heart-left {
            left: 30px;
            animation: heartLeftMove 3s ease-in-out forwards;
        }

        .heart-right {
            left: 0px;
            transform: rotate(45deg);
            transform-origin: 100% 100%;
            animation: heartRightMove 3s ease-in-out forwards;
        }

        @keyframes heartLeftMove {
            0% { 
                opacity: 1;
                transform: rotate(-45deg) translateX(-100px);
            }
            50% {
                opacity: 1;
                transform: rotate(-45deg) translateX(0px);
            }
            100% {
                opacity: 1;
                transform: rotate(-45deg) translateX(0px);
            }
        }

        @keyframes heartRightMove {
            0% { 
                opacity: 1;
                transform: rotate(45deg) translateX(100px);
            }
            50% {
                opacity: 1;
                transform: rotate(45deg) translateX(0px);
            }
            100% {
                opacity: 1;
                transform: rotate(45deg) translateX(0px);
            }
        }

        .heart-lock {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 2rem;
            color: #059669;
            opacity: 0;
            animation: lockAppear 1s ease-in-out 2.5s forwards;
        }

        @keyframes lockAppear {
            0% {
                opacity: 0;
                transform: translate(-50%, -50%) scale(0.5);
            }
            50% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1.2);
            }
            100% {
                opacity: 1;
                transform: translate(-50%, -50%) scale(1);
            }
        }

        .scroll-message {
            text-align: center;
            color: #059669;
            font-weight: 600;
            font-size: 1.1rem;
            opacity: 0;
            animation: messageAppear 1s ease-in-out 4s forwards;
        }

        @keyframes messageAppear {
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        .scroll-arrow {
            animation: bounce 2s infinite 5s;
            color: #059669;
            font-size: 1.5rem;
            margin-top: 0.5rem;
        }

        @keyframes bounce {
            0%, 20%, 50%, 80%, 100% {
                transform: translateY(0);
            }
            40% {
                transform: translateY(-10px);
            }
            60% {
                transform: translateY(-5px);
            }
        }

        /* GPT Bot Prominent Banner */
        .gpt-banner {
            background: linear-gradient(135deg, #10b981 0%, #059669 100%);
            color: white;
            padding: 1rem;
            border-radius: 12px;
            margin: 1rem 0;
            text-align: center;
            box-shadow: 0 4px 15px rgba(16, 185, 129, 0.3);
        }

        .gpt-banner h3 {
            margin: 0 0 0.5rem 0;
            font-size: 1.2rem;
            font-weight: 700;
        }

        .gpt-banner p {
            margin: 0.5rem 0;
            opacity: 0.9;
        }
    </style>
</head>
<body>
    <nav>
        <a href="index.html">Home</a> | <a href="repair.html">REPAIR Protocol</a> | <a href="about.html">Visual Framework</a> | <a href="progress.html">Progress</a>
    </nav>
    <div class="header">
        <div class="container">
            <h1>Enhanced REPAIR Protocol</h1>
            <p>Reconciliation & Emotional Process for Apology, Integration, & Restoration</p>
            <div style="margin-top: 1rem; font-size: 0.9rem; color: #8b5cf6;">
                <strong>Enhanced with Cognitive Foundation Components</strong>
            </div>
        </div>
    </div>

    <div class="main-content">
        <div class="container">
            <!-- Progress Stepper -->
            <div class="progress-stepper">
                <div class="stepper-container">
                    <div class="step" data-phase="0">
                        <div class="step-circle active" id="step-0">
                            <i data-feather="clipboard"></i>
                        </div>
                        <div class="step-label">Assessment</div>
                    </div>
                    <div class="step-connector" id="connector-0"></div>
                    
                    <div class="step" data-phase="1">
                        <div class="step-circle inactive" id="step-1">
                            <i data-feather="eye"></i>
                        </div>
                        <div class="step-label">Recognize</div>
                    </div>
                    <div class="step-connector" id="connector-1"></div>
                    
                    <div class="step" data-phase="2">
                        <div class="step-circle inactive" id="step-2">
                            <i data-feather="search"></i>
                        </div>
                        <div class="step-label">Examine</div>
                    </div>
                    <div class="step-connector" id="connector-2"></div>
                    
                    <div class="step" data-phase="3">
                        <div class="step-circle inactive" id="step-3">
                            <i data-feather="edit-3"></i>
                        </div>
                        <div class="step-label">Prepare</div>
                    </div>
                    <div class="step-connector" id="connector-3"></div>
                    
                    <div class="step" data-phase="4">
                        <div class="step-circle inactive" id="step-4">
                            <i data-feather="message-circle"></i>
                        </div>
                        <div class="step-label">Articulate</div>
                    </div>
                    <div class="step-connector" id="connector-4"></div>
                    
                    <div class="step" data-phase="5">
                        <div class="step-circle inactive" id="step-5">
                            <i data-feather="activity"></i>
                        </div>
                        <div class="step-label">Implement</div>
                    </div>
                    <div class="step-connector" id="connector-5"></div>
                    
                    <div class="step" data-phase="6">
                        <div class="step-circle inactive" id="step-6">
                            <i data-feather="heart"></i>
                        </div>
                        <div class="step-label">Restore</div>
                    </div>
                    <div class="step-connector" id="connector-6"></div>
                    
                    <div class="step" data-phase="7">
                        <div class="step-circle inactive" id="step-7">
                            <i data-feather="file-text"></i>
                        </div>
                        <div class="step-label">Contract</div>
                    </div>
                </div>
            </div>

            <!-- Phase Content -->
            <div class="content-card fade-in" id="phase-content">
                <!-- Content will be dynamically loaded here -->
            </div>
        </div>
    </div>

    <!-- Contract Modal -->
    <div class="modal" id="contractModal">
        <div class="modal-content">
            <div class="modal-header">
                <h3>Enhanced REPAIR Protocol Contract Preview</h3>
                <button class="close-btn" onclick="closeModal()">&times;</button>
            </div>
            <div class="modal-body">
                <pre id="modalContractText" style="white-space: pre-line; font-family: Monaco, monospace; font-size: 0.85rem; line-height: 1.4;"></pre>
            </div>
            <div class="modal-footer">
                <button class="btn btn-copy" onclick="copyToClipboard()">
                    <i data-feather="copy"></i> Copy to Clipboard
                </button>
                <button class="btn btn-secondary" onclick="closeModal()">Close</button>
            </div>
        </div>
    </div>

    <script>
        // Application State
        let currentPhase = 0;
        let copySuccess = false;
        let formData = {
            harmDescription: '',
            affectedParty: '',
            harmSeverity: '',
            readiness: '',
            specificActions: '',
            responsibility: '',
            emotionalImpact: '',
            directImpacts: '',
            secondaryEffects: '',
            systemicImplications: '',
            acknowledgmentStatement: '',
            changeCommitment: '',
            amendsProposal: '',
            timeline: '',
            apologyText: '',
            immediateActions: '',
            longTermChanges: '',
            progressCheckins: '',
            trustMetrics: '',
            healingIndicators: '',
            contractSigned: false,
            apologizerSignature: '',
            affectedPartySignature: '',
            signatureDate: '',
            biasChecklist: {}
        };

        const phases = [
            { name: 'Assessment', icon: 'clipboard' },
            { name: 'Recognize', icon: 'eye' },
            { name: 'Examine', icon: 'search' },
            { name: 'Prepare', icon: 'edit-3' },
            { name: 'Articulate', icon: 'message-circle' },
            { name: 'Implement', icon: 'activity' },
            { name: 'Restore', icon: 'heart' },
            { name: 'Contract', icon: 'file-text' }
        ];

        function replaceFeatherIcons() {
            if (window.feather && typeof window.feather.replace === 'function') {
                window.feather.replace();
            } else {
                document.querySelectorAll('[data-feather="chevron-left"]').forEach(el => {
                    el.innerHTML = '&larr;';
                });
                document.querySelectorAll('[data-feather="chevron-right"]').forEach(el => {
                    el.innerHTML = '&rarr;';
                });
            }
        }

        // Initialize application
        document.addEventListener('DOMContentLoaded', function() {
            replaceFeatherIcons();
            renderPhaseContent();
            setupEventListeners();
        });

        function setupEventListeners() {
            // Phase navigation
            document.querySelectorAll('.step').forEach((step, index) => {
                step.addEventListener('click', () => goToPhase(index));
            });
        }

        // Auto-save form data with error handling
        function saveFormData() {
            try {
                localStorage.setItem('repairProtocolData', JSON.stringify(formData));
            } catch (err) {
                console.warn('Could not save to localStorage:', err);
            }
        }

        // Load saved data with error handling
        function loadFormData() {
            try {
                const savedData = localStorage.getItem('repairProtocolData');
                if (savedData) {
                    const parsed = JSON.parse(savedData);
                    Object.assign(formData, parsed);
                    return true;
                }
            } catch (err) {
                console.warn('Could not load from localStorage:', err);
            }
            return false;
        }

        function updateFormData(field, value) {
            formData[field] = value;
            saveFormData();
        }

        function goToPhase(phaseIndex) {
            if (phaseIndex >= 0 && phaseIndex < phases.length) {
                currentPhase = phaseIndex;
                updateStepperUI();
                renderPhaseContent();
            }
        }

        function nextPhase() {
            // Basic validation before proceeding
            if (!validateCurrentPhase()) {
                return;
            }
            
            if (currentPhase < phases.length - 1) {
                currentPhase++;
                updateStepperUI();
                renderPhaseContent();
            }
        }

        function validateCurrentPhase() {
            // Basic validation for key fields
            switch(currentPhase) {
                case 0: // Assessment
                    if (!formData.harmDescription || !formData.affectedParty || !formData.harmSeverity || !formData.readiness) {
                        alert('Please complete all assessment fields before proceeding.');
                        return false;
                    }
                    break;
                case 1: // Recognize
                    if (!formData.specificActions || !formData.responsibility || !formData.emotionalImpact) {
                        alert('Please complete all recognition fields before proceeding.');
                        return false;
                    }
                    break;
                case 2: // Examine
                    if (!formData.directImpacts || !formData.secondaryEffects || !formData.systemicImplications) {
                        alert('Please complete all examination fields before proceeding.');
                        return false;
                    }
                    break;
                // Add more validation as needed
            }
            return true;
        }

        function prevPhase() {
            if (currentPhase > 0) {
                currentPhase--;
                updateStepperUI();
                renderPhaseContent();
            }
        }

        function updateStepperUI() {
            phases.forEach((phase, index) => {
                const stepCircle = document.getElementById(`step-${index}`);
                const connector = document.getElementById(`connector-${index}`);
                
                stepCircle.className = 'step-circle';
                if (index < currentPhase) {
                    stepCircle.classList.add('completed');
                    if (connector) connector.classList.add('completed');
                } else if (index === currentPhase) {
                    stepCircle.classList.add('active');
                } else {
                    stepCircle.classList.add('inactive');
                    if (connector) connector.classList.remove('completed');
                }
            });
        }

        function renderPhaseContent() {
            const content = document.getElementById('phase-content');
            content.className = 'content-card fade-in';
            
            switch(currentPhase) {
                case 0: content.innerHTML = getAssessmentContent(); break;
                case 1: content.innerHTML = getRecognizeContent(); break;
                case 2: content.innerHTML = getExamineContent(); break;
                case 3: content.innerHTML = getPrepareContent(); break;
                case 4: content.innerHTML = getArticulateContent(); break;
                case 5: content.innerHTML = getImplementContent(); break;
                case 6: content.innerHTML = getRestoreContent(); break;
                case 7: content.innerHTML = getContractContent(); break;
            }
            
            // Replace icons once after content is loaded
            setTimeout(replaceFeatherIcons, 100);
            bindFormEvents();
        }

        function bindFormEvents() {
            // Bind all form inputs to update formData
            document.querySelectorAll('input, textarea, select').forEach(input => {
                input.addEventListener('input', (e) => {
                    updateFormData(e.target.name, e.target.value);
                });
                
                // Set current values
                if (formData[input.name] !== undefined) {
                    input.value = formData[input.name];
                }
            });
            
            // Bind bias checklist
            document.querySelectorAll('.bias-checkbox').forEach(checkbox => {
                checkbox.addEventListener('change', (e) => {
                    updateFormData('biasChecklist', {
                        ...formData.biasChecklist,
                        [e.target.name]: e.target.checked
                    });
                });
            });

            // Simple navigation button binding
            setTimeout(() => {
                const prevBtn = document.getElementById('prevBtn');
                const nextBtn = document.getElementById('nextBtn');
                
                if (prevBtn) {
                    prevBtn.onclick = function() {
                        if (!this.disabled) {
                            prevPhase();
                        }
                    };
                }
                
                if (nextBtn) {
                    nextBtn.onclick = function() {
                        if (!this.disabled) {
                            nextPhase();
                        }
                    };
                }
            }, 100);
        }

        function getAssessmentContent() {
            return `
                <div class="phase-title">
                    <i data-feather="clipboard"></i>
                    Initial Assessment
                </div>
                <div class="phase-subtitle">
                    Let's begin by understanding the situation and your readiness for this enhanced reconciliation process.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="cpu"></i>
                        Cognitive Enhancement Framework Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Active Listening (0.9):</strong> Complete information gathering
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Emotional awareness and context
                        </div>
                        <div class="enhancement-item">
                            <strong>Memory Context (0.6):</strong> Learning integration foundation
                        </div>
                        <div class="enhancement-item">
                            <strong>Bias Mitigation (0.6):</strong> Objective assessment preparation
                        </div>
                    </div>
                </div>

                <!-- Early GPT Bot Notice -->
                <div style="background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); border-radius: 12px; padding: 1.5rem; margin: 1.5rem 0; border: 1px solid rgba(59, 130, 246, 0.2);">
                    <div style="display: flex; align-items: center; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <i data-feather="info" style="color: #2563eb;"></i>
                        <strong style="color: #1e40af;">AI Support Available After Completion</strong>
                    </div>
                    <p style="margin: 0.5rem 0; color: #1e40af; font-size: 0.9rem;">
                        After completing and signing your contract, you'll find a link to our specialized AI coach for ongoing support and accountability. 
                        <strong>Complete all phases first, then scroll down after signing for AI coaching access.</strong>
                    </p>
                </div>

                <div class="form-group">
                    <label class="form-label">Describe the harm that occurred:</label>
                    <textarea class="form-textarea" name="harmDescription" placeholder="What happened that caused harm? Be specific and comprehensive..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Who was affected?</label>
                    <input type="text" class="form-input" name="affectedParty" placeholder="Name or description of affected party">
                </div>

                <div class="form-group">
                    <label class="form-label">How would you rate the severity of harm?</label>
                    <select class="form-select" name="harmSeverity">
                        <option value="">Select severity level</option>
                        <option value="mild">Mild - Minor impact, easily addressed</option>
                        <option value="moderate">Moderate - Significant impact, requires effort</option>
                        <option value="severe">Severe - Major impact, substantial work needed</option>
                    </select>
                </div>

                <div class="form-group">
                    <label class="form-label">How ready are you to engage in this enhanced process?</label>
                    <select class="form-select" name="readiness">
                        <option value="">Select readiness level</option>
                        <option value="fully">Fully ready - Committed to complete cognitive enhancement process</option>
                        <option value="mostly">Mostly ready - Some concerns but willing to engage</option>
                        <option value="somewhat">Somewhat ready - Need more consideration and support</option>
                    </select>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getRecognizeContent() {
            return `
                <div class="phase-title">
                    <i data-feather="eye"></i>
                    Phase 1: RECOGNIZE
                </div>
                <div class="phase-subtitle">
                    Acknowledge harm and establish comprehensive awareness through enhanced cognitive processing.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="brain"></i>
                        Enhanced Recognition Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Active Listening (0.9):</strong> Complete information gathering about impact
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Recognition of emotional states and contexts
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Thought (0.7):</strong> Structured analysis of actions and consequences
                        </div>
                    </div>
                </div>

                <div class="bias-checklist">
                    <div class="bias-title">
                        <i data-feather="shield"></i>
                        Bias Mitigation Checklist - Complete Before Proceeding
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="minimization">
                        <span>Minimization bias: "It wasn't that bad" - Recognize tendency to downplay harm</span>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="intent">
                        <span>Intent fallacy: "I didn't mean to hurt anyone" - Impact matters more than intent</span>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="comparative">
                        <span>Comparative bias: "Others have done worse" - Focus on your actions, not comparisons</span>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="victim_blaming">
                        <span>Victim blaming: "They're too sensitive" - Validate their experience without judgment</span>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="self_pity">
                        <span>Self-pity bias: "I'm the real victim here" - Center the affected party's experience</span>
                    </div>
                    <div class="bias-item">
                        <input type="checkbox" class="bias-checkbox" name="perfectionism">
                        <span>Perfectionism bias: "I never do anything right" - Focus on specific actions and growth</span>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">What specific actions or inactions caused harm?</label>
                    <textarea class="form-textarea" name="specificActions" placeholder="Be specific about what you did or didn't do. Apply Active Listening to understand complete impact..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">How do you accept responsibility for these actions?</label>
                    <textarea class="form-textarea" name="responsibility" placeholder="Express your acceptance of responsibility without deflection or bias..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">What emotional impact did your behavior have on the affected party?</label>
                    <textarea class="form-textarea" name="emotionalImpact" placeholder="Apply Emotional Intelligence to understand the full emotional impact..."></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getExamineContent() {
            return `
                <div class="phase-title">
                    <i data-feather="search"></i>
                    Phase 2: EXAMINE
                </div>
                <div class="phase-subtitle">
                    Deep understanding of the full scope of impact through logical analysis and objective evaluation.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="cpu"></i>
                        Enhanced Analysis Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Chain of Reasoning (0.9):</strong> Logical analysis of causation and impact
                        </div>
                        <div class="enhancement-item">
                            <strong>Bias Mitigation (0.9):</strong> Objective assessment without self-justification
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Thought (0.8):</strong> Structured examination process
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Direct impacts on the affected party:</label>
                    <textarea class="form-textarea" name="directImpacts" placeholder="Apply Chain of Reasoning: What were the immediate and direct consequences? Use logical analysis..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Secondary effects on shared community or relationships:</label>
                    <textarea class="form-textarea" name="secondaryEffects" placeholder="Consider ripple effects: How did this affect others in your shared circles?"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Systemic implications of your behavior:</label>
                    <textarea class="form-textarea" name="systemicImplications" placeholder="Pattern analysis: What patterns or larger issues does this reveal? Apply objective assessment..."></textarea>
                </div>

                <div class="helper-text">
                    <strong>Enhanced Analysis Requirements:</strong> Use logical reasoning to trace causation, apply bias mitigation to ensure objectivity, and conduct systematic pattern analysis for root causes and contributing factors.
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getPrepareContent() {
            return `
                <div class="phase-title">
                    <i data-feather="edit-3"></i>
                    Phase 3: PREPARE
                </div>
                <div class="phase-subtitle">
                    Formulate your authentic, comprehensive apology and restoration plan using balanced cognitive processing.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="heart"></i>
                        Enhanced Preparation Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Wisdom-Understanding (0.9):</strong> Balanced approach to apology formulation
                        </div>
                        <div class="enhancement-item">
                            <strong>Memory Context (0.8):</strong> Integration of learning and past experience
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.8):</strong> Emotionally appropriate response design
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Clear acknowledgment statement:</label>
                    <textarea class="form-textarea" name="acknowledgmentStatement" placeholder="I acknowledge that I... (Apply Wisdom-Understanding for authentic connection)"></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Commitment to change:</label>
                    <textarea class="form-textarea" name="changeCommitment" placeholder="What specific changes will you make? Use Memory Context to integrate past learning..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Specific amends proposal:</label>
                    <textarea class="form-textarea" name="amendsProposal" placeholder="What concrete actions will you take to make amends? Balance emotional authenticity with practical commitments..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Implementation timeline:</label>
                    <textarea class="form-textarea" name="timeline" placeholder="When will you complete these actions? Consider realistic emotional processing time..."></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getArticulateContent() {
            return `
                <div class="phase-title">
                    <i data-feather="message-circle"></i>
                    Phase 4: ARTICULATE
                </div>
                <div class="phase-subtitle">
                    Craft your complete, authentic apology with full emotional awareness and responsive communication.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="mic"></i>
                        Enhanced Communication Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Active Listening (0.9):</strong> Responsive communication during delivery
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Reading and responding to emotional cues
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Thought (0.8):</strong> Clear, organized presentation
                        </div>
                    </div>
                </div>

                <div class="apology-structure">
                    <div class="structure-title">
                        <i data-feather="list"></i>
                        Enhanced Apology Structure with Cognitive Framework
                    </div>
                    <ul class="structure-list">
                        <li class="structure-item">1. "I acknowledge that I..." (Specific Actions with Emotional Awareness)</li>
                        <li class="structure-item">2. "This caused..." (Comprehensive Impact Recognition)</li>
                        <li class="structure-item">3. "I understand that..." (Deep Implications with Wisdom Integration)</li>
                        <li class="structure-item">4. "I will..." (Specific Changes with Memory Context)</li>
                        <li class="structure-item">5. "To make amends..." (Meaningful Restoration Proposals)</li>
                    </ul>
                </div>

                <div class="form-group">
                    <label class="form-label">Your complete enhanced apology:</label>
                    <textarea class="form-textarea" name="apologyText" rows="10" placeholder="Write your complete apology following the enhanced structure above. Apply Active Listening principles, demonstrate Emotional Intelligence, and use clear Chain of Thought..."></textarea>
                </div>

                <div class="helper-text">
                    <strong>Delivery Requirements:</strong> Create safe space with emotional safety protocols, maintain authentic delivery with genuine presence, apply responsive communication with real-time feedback adjustment, and ensure complete expression of all prepared elements.
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getImplementContent() {
            return `
                <div class="phase-title">
                    <i data-feather="activity"></i>
                    Phase 5: IMPLEMENT
                </div>
                <div class="phase-subtitle">
                    Execute comprehensive restoration plan with systematic tracking and learning integration.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="calendar"></i>
                        Enhanced Implementation Protocol Active
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Memory Context (0.9):</strong> Learning integration and pattern tracking
                        </div>
                        <div class="enhancement-item">
                            <strong>Chain of Reasoning (0.8):</strong> Logical implementation and adjustment
                        </div>
                        <div class="enhancement-item">
                            <strong>Wisdom-Understanding (0.7):</strong> Balanced approach to change process
                        </div>
                    </div>
                </div>

                <div class="enhancement-box" style="background: linear-gradient(135deg, #ecfdf5 0%, #d1fae5 100%);">
                    <div class="enhancement-title" style="color: #065f46;">
                        <i data-feather="clock"></i>
                        Memory Context Integration Schedule
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>24 hours:</strong> Review and reinforcement of key commitments
                        </div>
                        <div class="enhancement-item">
                            <strong>3 days:</strong> Pattern application practice and habit formation
                        </div>
                        <div class="enhancement-item">
                            <strong>1 week:</strong> Integration assessment and progress evaluation
                        </div>
                        <div class="enhancement-item">
                            <strong>2 weeks:</strong> Adjustment and refinement of approach
                        </div>
                        <div class="enhancement-item">
                            <strong>1 month:</strong> Long-term retention and sustainability check
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">Immediate corrective actions (0-2 weeks):</label>
                    <textarea class="form-textarea" name="immediateActions" placeholder="What will you do immediately to address the harm? Include cessation of harmful behaviors, safety measures, and transparency practices..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Long-term systemic changes (2+ weeks):</label>
                    <textarea class="form-textarea" name="longTermChanges" placeholder="What ongoing changes will you make to prevent recurrence? Apply Memory Context for sustainable transformation..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">Progress check-in schedule with Memory Context integration:</label>
                    <textarea class="form-textarea" name="progressCheckins" placeholder="When and how will you check progress? Include spaced repetition schedule and accountability measures..."></textarea>
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getRestoreContent() {
            return `
                <div class="phase-title">
                    <i data-feather="heart"></i>
                    Phase 6: RESTORE
                </div>
                <div class="phase-subtitle">
                    Rebuild trust and restore relationships with comprehensive cognitive support and community healing.
                </div>
                
                <div class="enhancement-box">
                    <div class="enhancement-title">
                        <i data-feather="users"></i>
                        Enhanced Restoration Protocol Active - Full Cognitive Foundation
                    </div>
                    <div class="enhancement-grid">
                        <div class="enhancement-item">
                            <strong>Wisdom-Understanding (0.9):</strong> Balanced approach to relationship healing
                        </div>
                        <div class="enhancement-item">
                            <strong>Emotional Intelligence (0.9):</strong> Navigation of complex emotional dynamics
                        </div>
                        <div class="enhancement-item">
                            <strong>Memory Context (0.8):</strong> Learning from healing process
                        </div>
                        <div class="enhancement-item">
                            <strong>Active Listening (0.8):</strong> Ongoing responsive communication
                        </div>
                        <div class="enhancement-item">
                            <strong>Bias Mitigation (0.7):</strong> Objective assessment of progress
                        </div>
                    </div>
                </div>

                <div class="form-group">
                    <label class="form-label">How will you measure trust rebuilding?</label>
                    <textarea class="form-textarea" name="trustMetrics" placeholder="What signs will indicate trust restoration? Include consistency between words/actions, transparency, boundary respect, and patience with healing timelines..."></textarea>
                </div>

                <div class="form-group">
                    <label class="form-label">What are indicators of relationship healing?</label>
                    <textarea class="form-textarea" name="healingIndicators" placeholder="How will you know the relationship is healing? Apply Emotional Intelligence to recognize comfort levels, communication patterns, and mutual investment..."></textarea>
                </div>

                <div class="helper-text">
                    <strong>Long-term Sustainability Requirements:</strong> Pattern prevention systems, community restoration contributions, continued learning and development, and wisdom accumulation for teaching others. Target performance: Trust restoration (0.7+), Relationship quality improvement (0.8+), Pattern prevention effectiveness (0.9+).
                </div>

                ${getNavigationButtons()}
            `;
        }

        function getContractContent() {
            return `
                <div class="phase-title">
                    <i data-feather="file-text"></i>
                    Enhanced Contract & Progress Tracking
                </div>
                <div class="phase-subtitle">
                    Review, sign, and set up comprehensive tracking for your Enhanced REPAIR Protocol agreement.
                </div>

                <!-- Prominent GPT Bot Banner -->
                <div class="gpt-banner">
                    <h3>🤖 AI Coaching Support Ready!</h3>
                    <p>After signing, scroll down to open the REPAIR Protocol AI coach for personalized guidance.</p>
                </div>

                <div class="contract-preview" id="contractPreview">
                    ${generateContract()}
                    <div class="heart-animation-overlay" id="heartAnimation">
                        <div class="heart-container">
                            <div class="heart-left"></div>
                            <div class="heart-right"></div>
                            <div class="heart-lock">🔒</div>
                        </div>
                        <div class="scroll-message">
                            Contract Successfully Signed! ✨
                            <div class="scroll-arrow">⬇️</div>
                            <div style="font-size: 0.9rem; margin-top: 0.5rem;">Scroll down to see your AI coaching options</div>
                        </div>
                    </div>
                </div>

                <div class="signature-grid">
                    <div class="signature-section">
                        <label class="form-label">Apologizer Signature:</label>
                        <input type="text" class="form-input" name="apologizerSignature" placeholder="Type your full name">
                    </div>
                    <div class="signature-section">
                        <label class="form-label">Affected Party Signature:</label>
                        <input type="text" class="form-input" name="affectedPartySignature" placeholder="Affected party's full name">
                    </div>
                </div>

                <div style="text-align: center; margin: 2rem 0;">
                    <button class="btn btn-primary" onclick="signAgreement()" style="font-size: 1.1rem; padding: 1rem 2rem;" type="button">
                        <i data-feather="check-circle"></i>
                        Sign Enhanced Agreement
                    </button>
                </div>

                <div class="action-buttons">
                    <button class="btn btn-download" onclick="downloadContract()" type="button">
                        <i data-feather="download"></i>
                        Download
                    </button>
                    <button class="btn btn-copy" onclick="copyToClipboard()" id="copyBtn" type="button">
                        <i data-feather="copy"></i>
                        Copy
                    </button>
                    <button class="btn btn-view" onclick="showContractModal()" type="button">
                        <i data-feather="eye"></i>
                        View
                    </button>
                    <button class="btn btn-print" onclick="printContract()" type="button">
                        <i data-feather="printer"></i>
                        Print
                    </button>
                </div>

                <div class="helper-text">
                    <strong>Export Options:</strong> Download works outside Claude.ai • Copy works everywhere • View shows modal preview • Print opens browser print/save as PDF
                </div>

                <div id="signedStatus"></div>
                <div id="progressDashboard"></div>
                <div id="aiIntegration"></div>

                ${getNavigationButtons()}
            `;
        }

        function getNavigationButtons() {
            const prevDisabled = currentPhase === 0;
            const nextDisabled = currentPhase === phases.length - 1;
            
            return `
                <div class="navigation">
                    <button type="button" class="btn btn-secondary" id="prevBtn" ${prevDisabled ? 'disabled' : ''}>
                        <i data-feather="chevron-left"></i>
                        Previous
                    </button>
                    <button type="button" class="btn btn-primary" id="nextBtn" ${nextDisabled ? 'disabled' : ''}>
                        Next
                        <i data-feather="chevron-right"></i>
                    </button>
                </div>
            `;
        }

        function generateContract() {
            try {
                const date = new Date().toLocaleDateString();
                const harmSeverityLevel = formData.harmSeverity === 'severe' ? 'HIGH' : formData.harmSeverity === 'moderate' ? 'MEDIUM' : 'STANDARD';
                
                // Helper function to safely get form data with fallback
                const safeGet = (field, fallback = 'Not specified') => {
                    return formData[field] && formData[field].trim() ? formData[field] : fallback;
                };
                
                return `ENHANCED REPAIR PROTOCOL RECONCILIATION AGREEMENT
Reconciliation & Emotional Process for Apology, Integration, & Restoration
Enhanced with Cognitive Foundation Components

================================================================================
CONTRACT METADATA
================================================================================
Date: ${date}
Parties: ${safeGet('apologizerSignature', '[Apologizer]')} and ${safeGet('affectedParty', '[Affected Party]')}
Severity Level: ${harmSeverityLevel}
Readiness Assessment: ${safeGet('readiness', 'Not assessed')}
Framework Version: Enhanced REPAIR Protocol v2.0

================================================================================
COGNITIVE ENHANCEMENT CONFIGURATION
================================================================================
This agreement incorporates advanced cognitive processing for enhanced effectiveness:

Active Listening (AL): High priority in RECOGNIZE and ARTICULATE phases
Memory Context (MC): Integrated throughout for learning retention and pattern recognition
Chain of Thought (CoT): Applied for structured analysis and communication
Chain of Reasoning (CoR): Enhanced logical analysis in EXAMINE phase
Bias Mitigation (BM): Systematic objectivity checks throughout process
Wisdom-Understanding (WU): Balanced intuitive and analytical approach
Emotional Intelligence (EI): High-level emotional awareness and regulation

Performance Target Metrics (0.0-1.0 scale):
- Information Completeness: Target 0.8+
- Emotional Recognition Accuracy: Target 0.8+
- Logical Consistency: Target 0.9+
- Bias Detection Effectiveness: Target 0.8+
- Implementation Consistency: Target 0.9+
- Trust Restoration Progress: Target 0.7+

================================================================================
PHASE 1: RECOGNIZE - ENHANCED ACKNOWLEDGMENT
================================================================================

HARM DESCRIPTION:
${safeGet('harmDescription')}

SPECIFIC ACTIONS THAT CAUSED HARM:
${safeGet('specificActions')}

RESPONSIBILITY ACCEPTANCE:
${safeGet('responsibility')}

EMOTIONAL IMPACT RECOGNITION:
${safeGet('emotionalImpact')}

COGNITIVE ENHANCEMENT COMMITMENTS FOR RECOGNIZE PHASE:
- Apply Active Listening (Level 0.9) to fully understand all impacts
- Use Emotional Intelligence (Level 0.9) to recognize and validate feelings
- Complete bias mitigation checklist for defensive thinking
- Achieve minimum 0.8 performance score on acknowledgment authenticity

BIAS MITIGATION CHECKLIST COMPLETION REQUIRED:
□ Minimization bias: "It wasn't that bad"
□ Intent fallacy: "I didn't mean to hurt anyone" 
□ Comparative bias: "Others have done worse"
□ Victim blaming: "They're too sensitive"
□ Self-pity bias: "I'm the real victim here"
□ Perfectionism bias: "I never do anything right"

================================================================================
PHASE 2: EXAMINE - ENHANCED ANALYSIS
================================================================================

DIRECT IMPACTS IDENTIFIED:
${safeGet('directImpacts')}

SECONDARY EFFECTS ON COMMUNITY:
${safeGet('secondaryEffects')}

SYSTEMIC IMPLICATIONS:
${safeGet('systemicImplications')}

COGNITIVE ENHANCEMENT COMMITMENTS FOR EXAMINE PHASE:
- Apply Chain of Reasoning (Level 0.9) for logical impact analysis
- Use Bias Mitigation (Level 0.9) to ensure objective self-assessment
- Complete pattern analysis for recurring behaviors
- Achieve minimum 0.8 performance score on impact assessment completeness

================================================================================
PHASE 3: PREPARE - ENHANCED PLANNING
================================================================================

ACKNOWLEDGMENT STATEMENT:
${safeGet('acknowledgmentStatement')}

COMMITMENT TO CHANGE:
${safeGet('changeCommitment')}

SPECIFIC AMENDS PROPOSAL:
${safeGet('amendsProposal')}

IMPLEMENTATION TIMELINE:
${safeGet('timeline')}

COGNITIVE ENHANCEMENT COMMITMENTS FOR PREPARE PHASE:
- Apply Wisdom-Understanding (Level 0.9) for balanced approach
- Use Memory Context (Level 0.8) to integrate past learning
- Employ Emotional Intelligence (Level 0.8) for appropriate response design
- Achieve minimum 0.8 performance score on authenticity and comprehensiveness

================================================================================
PHASE 4: ARTICULATE - ENHANCED COMMUNICATION
================================================================================

COMPLETE APOLOGY TEXT:
${safeGet('apologyText')}

COGNITIVE ENHANCEMENT COMMITMENTS FOR ARTICULATE PHASE:
- Apply Active Listening (Level 0.9) during delivery for responsive communication
- Use Emotional Intelligence (Level 0.9) to read and respond to emotional cues
- Employ Chain of Thought (Level 0.8) for clear, organized presentation
- Achieve minimum 0.8 performance score on delivery authenticity

================================================================================
PHASE 5: IMPLEMENT - ENHANCED ACTION
================================================================================

IMMEDIATE CORRECTIVE ACTIONS (0-2 weeks):
${safeGet('immediateActions')}

LONG-TERM SYSTEMIC CHANGES (2+ weeks):
${safeGet('longTermChanges')}

PROGRESS CHECK-IN SCHEDULE:
${safeGet('progressCheckins')}

COGNITIVE ENHANCEMENT COMMITMENTS FOR IMPLEMENT PHASE:
- Apply Memory Context (Level 0.9) for learning integration and pattern tracking
- Use Chain of Reasoning (Level 0.8) for logical implementation and adjustment
- Employ systematic progress tracking with documented metrics
- Achieve minimum 0.9 performance score on implementation consistency

MEMORY CONTEXT INTEGRATION SCHEDULE:
- 24 hours: Review and reinforcement of key commitments
- 3 days: Pattern application practice and initial habit formation
- 1 week: Integration assessment and progress evaluation
- 2 weeks: Adjustment and refinement of approach
- 1 month: Long-term retention check and sustainability assessment

================================================================================
PHASE 6: RESTORE - ENHANCED RELATIONSHIP HEALING
================================================================================

TRUST REBUILDING METRICS:
${safeGet('trustMetrics')}

RELATIONSHIP HEALING INDICATORS:
${safeGet('healingIndicators')}

COGNITIVE ENHANCEMENT COMMITMENTS FOR RESTORE PHASE:
- Apply Wisdom-Understanding (Level 0.9) for balanced approach to healing
- Use Emotional Intelligence (Level 0.9) to navigate complex emotional dynamics
- Employ Memory Context (Level 0.8) for learning from healing process
- Achieve minimum 0.7 performance score on trust restoration progress

================================================================================
COMMITMENT AND SIGNATURES
================================================================================

APOLOGIZER COMMITMENT:
"I, ${safeGet('apologizerSignature', '[Apologizer Name]')}, commit to engaging fully with this Enhanced REPAIR Protocol process with advanced cognitive enhancement techniques for deeper understanding, more effective communication, and lasting change."

AFFECTED PARTY ACKNOWLEDGMENT:
"I, ${safeGet('affectedPartySignature', '[Affected Party Name]')}, acknowledge this comprehensive commitment to reconciliation and healing using the enhanced cognitive framework."

SIGNATURES:
Apologizer: ${safeGet('apologizerSignature', '[Signature Required]')}
Date: ${safeGet('signatureDate', '[Date Required]')}

Affected Party: ${safeGet('affectedPartySignature', '[Signature Required]')}
Date: ${safeGet('signatureDate', '[Date Required]')}

================================================================================
AI SUPPORT COACHING INTEGRATION
================================================================================

🤖 ENHANCED AI COACHING AVAILABLE

This Enhanced REPAIR Protocol contract is designed for seamless integration with specialized AI coaching that applies the same cognitive enhancement framework.

Your AI coach will provide:
✅ Cognitive enhancement tracking and adjustment
✅ Performance metrics monitoring (0.0-1.0 scale)
✅ Bias mitigation exercises and accountability
✅ Memory context integration with spaced repetition
✅ Emotional intelligence development support
✅ Progress reporting with validation checkpoints

TO BEGIN ENHANCED AI COACHING:
Visit: https://chatgpt.com/g/g-685f7ec1cae4819183b514fdeff27b43-repair-protocol-support-bot
Upload this signed contract to your REPAIR Protocol AI Coach for personalized guidance with advanced cognitive processing support.

================================================================================
Enhanced REPAIR Protocol v2.0 with Cognitive Foundation Integration
Generated: ${date}
================================================================================`;
            
            } catch (error) {
                console.error('Error generating contract:', error);
                return 'Error generating contract. Please ensure all required fields are completed.';
            }
        }

        function signAgreement() {
            if (!formData.apologizerSignature || !formData.affectedPartySignature) {
                alert('Both parties must provide their signatures before signing the agreement.');
                return;
            }
            
            if (!formData.apologizerSignature.trim() || !formData.affectedPartySignature.trim()) {
                alert('Signatures cannot be empty. Please provide valid names.');
                return;
            }
            
            formData.signatureDate = new Date().toLocaleDateString();
            formData.contractSigned = true;
            updateFormData('contractSigned', true);
            updateFormData('signatureDate', formData.signatureDate);
            
            // Trigger heart animation
            triggerHeartAnimation();
            
            // Show other sections after longer animation
            setTimeout(() => {
                showSignedStatus();
                showProgressDashboard();
                showAIIntegration();

                // Update contract preview (regenerate without animation overlay)
                const contractPreview = document.getElementById('contractPreview');
                if (contractPreview) {
                    const contractContent = generateContract();
                    contractPreview.innerHTML = contractContent;
                }
            }, 10000); // Wait 10 seconds so animation can be enjoyed while content loads
        }

        function triggerHeartAnimation() {
            const heartAnimation = document.getElementById('heartAnimation');
            if (heartAnimation) {
                heartAnimation.classList.add('show');

                // Hide animation after 15 seconds (longer duration)
                setTimeout(() => {
                    heartAnimation.style.opacity = '0';
                    setTimeout(() => {
                        heartAnimation.style.display = 'none';
                    }, 500);
                }, 15000);
            }
        }

        function showSignedStatus() {
            const statusElement = document.getElementById('signedStatus');
            if (!statusElement) return;
            
            statusElement.innerHTML = `
                <div class="status-indicator status-success">
                    <i data-feather="check-circle"></i>
                    Agreement Successfully Signed on ${formData.signatureDate}
                    <div style="font-size: 0.9rem; font-weight: normal; margin-top: 0.5rem;">
                        Both parties have committed to this Enhanced REPAIR Protocol process with cognitive enhancement support.
                    </div>
                </div>
            `;
            setTimeout(replaceFeatherIcons, 100);
        }

        function showProgressDashboard() {
            document.getElementById('progressDashboard').innerHTML = `
                <div class="progress-dashboard">
                    <div class="dashboard-title">
                        🧠 Enhanced Progress Tracking Dashboard
                    </div>
                    
                    <div class="metrics-grid">
                        <div class="metric-card">
                            <div class="metric-title">Cognitive Enhancement</div>
                            <div class="metric-value">0.0</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-title">Implementation Progress</div>
                            <div class="metric-value">0.0</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-title">Trust Restoration</div>
                            <div class="metric-value">0.0</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        
                        <div class="metric-card">
                            <div class="metric-title">Memory Integration</div>
                            <div class="metric-value">0.0</div>
                            <div class="progress-bar">
                                <div class="progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.8); padding: 1.5rem; border-radius: 12px; text-align: center; color: #581c87;">
                        <strong>Next Steps:</strong> Progress tracking will begin with AI coaching support. Upload your signed contract to begin personalized cognitive enhancement guidance.
                    </div>
                </div>
            `;
        }

        function showAIIntegration() {
            const aiElement = document.getElementById('aiIntegration');
            if (!aiElement) return;
            
            aiElement.innerHTML = `
                <div class="ai-integration">
                    <div class="ai-title">
                        <i data-feather="cpu"></i>
                        🤖 Enhanced AI Coaching Ready
                    </div>
                    <div class="ai-description">
                        Your Enhanced REPAIR Protocol contract is ready for AI coaching integration! Get personalized support with advanced cognitive enhancement tracking.
                    </div>
                    
                    <div class="ai-features">
                        <div class="ai-feature">
                            ✅ Cognitive Enhancement Monitoring
                        </div>
                        <div class="ai-feature">
                            ✅ Performance Metrics Tracking
                        </div>
                        <div class="ai-feature">
                            ✅ Bias Mitigation Support
                        </div>
                        <div class="ai-feature">
                            ✅ Memory Context Integration
                        </div>
                        <div class="ai-feature">
                            ✅ Progress Validation & Checkpoints
                        </div>
                        <div class="ai-feature">
                            ✅ Crisis Management Protocols
                        </div>
                    </div>
                    
                    <div style="background: rgba(255, 255, 255, 0.9); padding: 1.5rem; border-radius: 12px; margin-top: 1.5rem; border: 2px solid #3b82f6;">
                        <strong style="color: #1e40af;">🚀 Ready to Begin AI Coaching:</strong>
                        <p style="margin: 0.5rem 0; color: #1e40af;">
                            Upload this signed contract to your REPAIR Protocol AI Coach to start your enhanced reconciliation journey with full cognitive support!
                        </p>
                        <div style="text-align: center; margin-top: 1rem;">
                            <a href="https://chatgpt.com/g/g-685f7ec1cae4819183b514fdeff27b43-repair-protocol-support-bot"
                               target="_blank"
                               class="btn btn-primary ai-link-highlight"
                               style="display: inline-flex; align-items: center; gap: 0.5rem; text-decoration: none; font-size: 1rem; padding: 0.75rem 1.5rem;">
                                <i data-feather="external-link"></i>
                                Open AI Coach Bot
                            </a>
                        </div>
                        <p style="font-size: 0.85rem; color: #6b7280; text-align: center; margin-top: 0.5rem;">
                            Copy your signed contract and upload it to the AI coach for personalized guidance
                        </p>
                    </div>
                </div>
            `;
            setTimeout(replaceFeatherIcons, 100);
        }

        function downloadContract() {
            try {
                const contract = generateContract();
                
                // Check if we're in a secure context and if the browser supports the File API
                if (window.File && window.FileReader && window.FileList && window.Blob) {
                    const blob = new Blob([contract], { type: 'text/plain;charset=utf-8' });
                    
                    // Check if browser supports URL.createObjectURL
                    if (window.URL && window.URL.createObjectURL) {
                        const url = window.URL.createObjectURL(blob);
                        const a = document.createElement('a');
                        a.href = url;
                        a.download = 'enhanced-repair-protocol-agreement.txt';
                        a.style.display = 'none';
                        
                        // Add to DOM, click, then remove
                        document.body.appendChild(a);
                        a.click();
                        document.body.removeChild(a);
                        
                        // Clean up the URL object
                        setTimeout(() => window.URL.revokeObjectURL(url), 100);
                        
                        return true;
                    }
                }
                
                // If download fails, fall back to copy
                throw new Error('Download not supported');
                
            } catch (err) {
                console.error('Download failed: ', err);
                
                // Fallback: Try to copy to clipboard instead
                copyToClipboard();
                alert('Download not supported in this environment. The contract has been copied to your clipboard instead. Please paste it into a text file and save manually.');
                
                return false;
            }
        }

        async function copyToClipboard() {
            const contract = generateContract();
            const copyBtn = document.getElementById('copyBtn');
            
            if (!copyBtn) return;
            
            try {
                if (navigator.clipboard && window.isSecureContext) {
                    await navigator.clipboard.writeText(contract);
                } else {
                    // Fallback for older browsers or non-secure contexts
                    const textArea = document.createElement('textarea');
                    textArea.value = contract;
                    textArea.style.position = 'fixed';
                    textArea.style.left = '-999999px';
                    textArea.style.top = '-999999px';
                    document.body.appendChild(textArea);
                    textArea.focus();
                    textArea.select();
                    document.execCommand('copy');
                    textArea.remove();
                }
                
                copyBtn.innerHTML = '<i data-feather="check"></i> Copied!';
                copyBtn.classList.add('success');
                setTimeout(() => {
                    copyBtn.innerHTML = '<i data-feather="copy"></i> Copy';
                    copyBtn.classList.remove('success');
                    replaceFeatherIcons();
                }, 2000);
                
            } catch (err) {
                console.error('Failed to copy text: ', err);
                alert('Failed to copy to clipboard. Please manually select and copy the text.');
            }
        }

        function showContractModal() {
            const modal = document.getElementById('contractModal');
            const modalText = document.getElementById('modalContractText');
            modalText.textContent = generateContract();
            modal.classList.add('show');
        }

        function closeModal() {
            document.getElementById('contractModal').classList.remove('show');
        }

        function printContract() {
            try {
                const contract = generateContract();
                
                // Escape HTML special characters to prevent injection
                const escapedContract = contract
                    .replace(/&/g, '&amp;')
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#039;');
                
                // Create a new window for printing
                const printWindow = window.open('', '_blank', 'width=800,height=600');
                
                if (!printWindow) {
                    throw new Error('Popup blocked or failed to open print window');
                }
                
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html>
                        <head>
                            <title>Enhanced REPAIR Protocol Agreement</title>
                            <meta charset="UTF-8">
                            <style>
                                body { 
                                    font-family: 'Times New Roman', serif; 
                                    line-height: 1.6; 
                                    margin: 40px; 
                                    color: #333;
                                    font-size: 12px;
                                }
                                h1 { 
                                    color: #333; 
                                    border-bottom: 3px solid #667eea; 
                                    padding-bottom: 10px; 
                                    font-size: 18px;
                                    margin-bottom: 20px;
                                }
                                .contract-content { 
                                    white-space: pre-line; 
                                    font-family: 'Courier New', monospace;
                                    font-size: 11px;
                                    line-height: 1.4;
                                }
                                .header {
                                    text-align: center;
                                    margin-bottom: 30px;
                                }
                                @media print {
                                    body { 
                                        margin: 20px; 
                                        font-size: 10px;
                                    }
                                    .contract-content { 
                                        font-size: 9px; 
                                    }
                                    h1 {
                                        font-size: 14px;
                                    }
                                }
                                @page {
                                    margin: 1in;
                                }
                            </style>
                        </head>
                        <body>
                            <div class="header">
                                <h1>Enhanced REPAIR Protocol Agreement</h1>
                                <p>Reconciliation & Emotional Process for Apology, Integration, & Restoration</p>
                            </div>
                            <div class="contract-content">${escapedContract}</div>
                        </body>
                    </html>
                `);
                
                printWindow.document.close();
                
                // Wait for content to load, then print
                printWindow.onload = function() {
                    setTimeout(() => {
                        printWindow.print();
                        // Close the window after printing (optional)
                        printWindow.onafterprint = function() {
                            printWindow.close();
                        };
                    }, 100);
                };
                
                return true;
                
            } catch (err) {
                console.error('Print failed: ', err);
                alert('Print failed. This might be due to popup blocking. Please ensure popups are allowed, or use the Copy option to manually save the contract.');
                return false;
            }
        }

        // Close modal when clicking outside
        document.addEventListener('click', function(event) {
            const modal = document.getElementById('contractModal');
            if (event.target === modal) {
                closeModal();
            }
        });

        // Auto-save form data with reduced frequency
        setInterval(() => {
            loadFormData();
        }, 10000); // Reduced from 5 seconds to 10 seconds

        // Load saved data on page load
        window.addEventListener('load', () => {
            if (loadFormData()) {
                // Update form fields with saved data after a short delay
                setTimeout(() => {
                    document.querySelectorAll('input, textarea, select').forEach(input => {
                        if (formData[input.name] !== undefined) {
                            input.value = formData[input.name];
                        }
                    });
                }, 200);
            }
        });
    </script>
</body>
</html>
